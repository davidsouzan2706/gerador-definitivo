<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Roteiros Virais v3.0 - O Painel do Projeto</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF para gera√ß√£o de PDF (ainda inclu√≠do, mas n√£o usado para download principal) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Fontes Google - Carlito para legibilidade -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carlito:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <style>


/* ========================================================== */
/* ======== ESTILOS PARA O CONSULTOR DE RETEN√á√ÉO V3 ======== */
/* ========================================================== */
.retention-paragraph-live {
    padding: 0.25rem 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
    border-left-width: 3px;
    transition: background-color 0.2s ease-out;
}
.retention-paragraph-live:hover {
    background-color: rgba(129, 140, 248, 0.1); /* Fundo sutil no hover */
}
.dark .retention-paragraph-live:hover {
    background-color: rgba(129, 140, 248, 0.15);
}

/* --- Cores do Mapa de Calor --- */
.retention-green { border-left-color: #10B981; }
.retention-yellow { border-left-color: #FBBF24; }
.retention-red { border-left-color: #EF4444; }

/* --- √Årea de Detalhes da Sugest√£o (Vamos usar depois) --- */
.retention-details-card {
    background-color: var(--bg-light);
    border: 1px solid var(--border-light);
    border-left-width: 4px;
    padding: 1rem;
    border-radius: 8px;
}
.dark .retention-details-card {
    background-color: #1f2937;
    border-color: #4b5563;
}
.retention-details-card strong {
    display: block;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
}
.retention-details-card p {
    font-size: 0.9rem;
    line-height: 1.5;
    color: var(--text-dark);
}
.dark .retention-details-card p {
    color: #d1d5db; /* Cor de texto clara */
}
.retention-details-card button {
    margin-top: 0.75rem;
}

/* E adicione esta regra para o modo escuro */
.dark .retention-details-card p {
    color: #d1d5db; /* Cor de texto clara */

}
.retention-details-card button {
    margin-top: 0.75rem;
}

	/* ========================================================== */
	/* ========= FEEDBACK VISUAL PARA TEXTO ENRIQUECIDO ========= */
	/* ========================================================== */
	@keyframes highlight-fade {
	from { background-color: rgba(255, 255, 0, 0.5); }
	to { background-color: transparent; }
	}

	.highlight-change {
	animation: highlight-fade 2s ease-in-out;
	background-color: transparent; /* Estado final da anima√ß√£o */
	}
	
        /* ========================================================== */
        /* ==================== ESTILOS GERAIS ==================== */
        /* ========================================================== */
        /* Vari√°veis CSS para cores consistentess e f√°cil manuten√ß√£o */
        :root {
            --primary-color: #4f46e5; /* Indigo-600 */
            --primary-hover: #4338ca; /* Indigo-700 */
            --secondary-bg: #e0e7ff; /* Indigo-100 */
            --secondary-text: #4338ca; /* Indigo-700 */
            --secondary-hover: #c7d2fe; /* Indigo-200 */
            --success-color: #10B981; /* Green-500 */
            --success-hover: #059669; /* Green-600 */
            --text-dark: #1f2937; /* Gray-800 */
            --text-medium: #4b5563; /* Gray-600 */
            --text-light: #6b7280; /* Gray-500 */
            --bg-light: #f9fafb; /* Gray-50 */
            --border-light: #e5e7eb; /* Gray-200 */
        }

        body {
            font-family: 'Carlito', sans-serif;
            background-color: #f0f2f5; /* Cinza bem claro */
            color: var(--text-dark); /* Cor de texto padr√£o para modo claro */
            min-height: 100vh; /* GARANTE QUE O BODY OCUPE NO M√çNIMO TODA A TELA */
        }
        .dark body {
            background-color: #111827; /* Cinza 900 */
            color: #d1d5db; /* Cor de texto padr√£o para modo escuro */
        }
        .container {
            max-width: 1024px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff; /* Branco */
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            margin-bottom: 120px; /* GARANTE ESPA√áO PARA O RODAP√â FIXO N√ÉO COBRIR O CONTE√öDO */
        }
        .dark .container {
            background-color: #1f2937; /* Cinza 800 */
        }
        .input-group label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            display: block;
        }
        /* ========================================================== */
        /* ======== ESTILIZA√á√ÉO DEFINITIVA DE INPUTS E FORMS ======== */
        /* ========================================================== */
        /* Classe Mestra para Fundos de Componentes */
        .card-background {
            background-color: #ffffff; /* Padr√£o (Claro) */
            border: 1px solid var(--border-light);
        }
        .dark .card-background {
            background-color: #1f2937; /* Escuro */
            border: 1px solid #4b5563;
        }

        /* --- ESTADO PADR√ÉO (MODO CLARO) --- */
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none !important;
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2) !important;
            background-color: #ffffff !important; /* Explicitly white on focus in light mode */
        }
        /* --- ESTADO MODO ESCURO --- */
        .dark .input-group input:focus,
        .dark .input-group select:focus,
        .dark .input-group textarea:focus {
            border-color: #6366f1 !important; /* indigo-500 */
            background-color: #4b5563 !important; /* gray-600 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3) !important;
        }
        /* --- CORRE√á√ÉO PARA O PLACEHOLDER --- */
        .dark .input-group input::placeholder,
        .dark .input-group textarea::placeholder {
            color: #9ca3af; /* gray-400 */
        }
        /* Cor de texto para elementos no modo escuro */
        .dark h1, .dark h2, .dark h3, .dark h4, .dark label {
            color: #f3f4f6;
        }
        .dark .input-group input, .dark .input-group select, .dark .input-group textarea {
            color: #f9fafb;
        }


        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: inline-flex; /* Para alinhar texto e spinner/√≠cone */
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            white-space: nowrap; /* Evita que o texto do bot√£o quebre linha */
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: #ffffff;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }
        .btn-secondary {
            background-color: var(--secondary-bg);
            color: var(--secondary-text);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--secondary-hover);
            transform: translateY(-2px);
            box-shadow: 0 44px 12px rgba(79, 70, 229, 0.15);
        }
        .btn-success {
            background-color: var(--success-color) !important; /* !important para sobrescrever */
            color: #ffffff !important;
        }
        .btn-success:hover:not(:disabled) {
            background-color: var(--success-hover) !important;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        .btn-secondary .loading-spinner {
            border: 4px solid rgba(67, 56, 202, 0.2);
            border-left-color: var(--secondary-text);
        }
        .loading-spinner.hidden { display: none; }
        .button-text.hidden { display: none; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Icone de Conclus√£o */
        /* REMOVIDO: .completion-icon { ... } */
        /* REMOVIDO: .completion-icon.hidden { display: none; } */

        /* ========================================================== */
        /* ==================== UI MELHORADA ====================== */
        /* ========================================================== */
        .accordion-item {
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden; /* Garante que o conte√∫do escondido n√£o vaze */
            background-color: var(--bg-light);
        }
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            user-select: none; /* Impede sele√ß√£o de texto ao clicar */
        }
        /* Estilo para o cabe√ßalho do acorde√£o ativo */
        .accordion-header.active {
            background-color: var(--secondary-bg);
        }
        .dark .accordion-header.active {
            background-color: #374151; /* Gray-700 */
        }
        .header-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .header-buttons {
            display: flex;
            gap: 0.5rem; /* Espa√ßamento entre os bot√µes de a√ß√£o */
        }
        .accordion-header h3 {
            margin-bottom: 0; /* Remove a margem padr√£o do h3 */
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        .accordion-arrow {
            transition: transform 0.3s ease-in-out;
        }
        .accordion-arrow.open {
            transform: rotate(180deg);
        }
        .accordion-body {
            max-height: 0; /* Escondido por padr√£o */
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
            padding: 0 1.5rem; /* Padding vertical zero quando fechado */
        }
	.accordion-body.open {
            max-height: 200vh; /* Um valor alto para permitir a expans√£o */
            padding: 1.5rem;   /* Restaura o padding para mostrar o conte√∫do */
        }
        /* For√ßa o fundo correto para o corpo do acorde√£o */
        .accordion-body {
            background-color: #ffffff; /* Fundo branco padr√£o (Modo Claro) */
        }
        /* Define a cor correta para o fundo do corpo no Modo Escuro */
        .dark .accordion-body {
            background-color: #1f2937; /* Mesmo fundo do container (Cinza 800) */
        }
        /* Garante a cor de texto correta para o conte√∫do gerado */
        .generated-content-wrapper {
            color: var(--text-dark); /* Garante texto escuro no modo claro */
            line-height: 1.6; /* Melhora a legibilidade */
        }
        .dark .generated-content-wrapper {
            color: #d1d5db; /* Garante texto claro no modo escuro (Gray-300) */
        }
        .accordion-body .generated-content-wrapper[contenteditable="true"] {
            outline: none;
            padding: 0.5rem;
            border-radius: 4px;
            transition: box-shadow 0.2s, background-color 0.2s;
        }
        .accordion-body .generated-content-wrapper[contenteditable="true"]:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
            background-color: #eef2ff; /* Fundo levemente azulado ao editar */
        }

        /* Bot√µes de Copiar e Re-gerar dentro das se√ß√µes */
        .copy-btn, .regenerate-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            white-space: nowrap;
        }
        .copy-btn {
            background-color: var(--primary-color);
            color: #ffffff;
        }
        .copy-btn:hover {
            background-color: var(--primary-hover);
        }
        .regenerate-btn {
            background-color: var(--secondary-bg);
            color: var(--secondary-text);
        }
        .regenerate-btn:hover {
            background-color: var(--secondary-hover);
        }
        
        /* Se√ß√µes de Prompts e Trilha Sonora */
        .section-prompts, .section-soundtrack {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px dashed #d1d5db;
        }
        .btn-small {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
        .loading-spinner-small {
            border: 3px solid rgba(67, 56, 202, 0.2);
            border-left-color: var(--secondary-text);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        .individual-prompt-block {
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .prompt-time {
            font-size: 0.75rem;
            color: var(--primary-color);
            font-weight: 700;
        }
        .prompt-phrase {
            font-size: 0.875rem;
            color: var(--text-dark);
            font-weight: 700;
            line-height: 1.4;
        }
        .prompt-description-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-medium);
            margin-top: 0.5rem;
            border-top: 1px dashed var(--border-light);
            padding-top: 0.5rem;
        }
        .prompt-description-content {
            font-size: 0.9rem;
            color: var(--text-dark);
            line-height: 1.5;
        }
        pre {
            background-color: var(--bg-light);
            border-radius: 4px;
            padding: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-medium);
            overflow-x: auto; /* Para lidar com blocos de estilo longos */
            white-space: pre-wrap; /* Quebra linhas longas */
            word-break: break-all; /* Quebra palavras longas */
        }
        .soundtrack-list {
            list-style-type: disc;
            padding-left: 20px;
            font-size: 0.9rem;
            color: var(--text-dark);
        }
        .soundtrack-list li { margin-bottom: 0.5rem; }

        /* Separador para Thumbnails */
        .thumbnail-item-separator {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-light);
        }

        /* Toast Notification */
        #toastNotification {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7); color: #fff; padding: 10px 20px;
            border-radius: 8px; font-size: 0.9rem; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            z-index: 1001; white-space: nowrap;
        }
        #toastNotification.toast-visible { opacity: 1; visibility: visible; }

        /* Alerta Full-Screen */
        #fullScreenAlertOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center;
            align-items: center; z-index: 1000; visibility: hidden; opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            z-index: 1000; /* Ensure it's above other content */
        }
        #fullScreenAlertOverlay.visible { visibility: visible; opacity: 1; }
        #fullScreenAlertBox {
            /* Removido background-color e border para usar .card-background */
            padding: 2.5rem; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); text-align: center; max-width: 500px;
            width: 90%; position: relative; transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        #fullScreenAlertOverlay.visible #fullScreenAlertBox { transform: translateY(0); }
        #fullScreenAlertBox p { font-size: 1.1rem; color: var(--text-dark); margin-bottom: 1.5rem; line-height: 1.6; }
        #fullScreenAlertBox button {
            background-color: var(--primary-color); color: #ffffff; padding: 0.75rem 1.5rem;
            border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; border: none;
        }
        #fullScreenAlertBox button:hover { background-color: var(--primary-hover); }

        /* ========================================================== */
        /* ================= BARRA FLUTUANTE ====================== */
        /* ========================================================== */
        .floating-action-bar {
            position: fixed; top: 0; left: 0; width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 999; padding: 0.75rem 0;
            transform: translateY(-100%); opacity: 0; visibility: hidden;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .floating-action-bar.visible { transform: translateY(0); opacity: 1; visibility: visible; }
        .action-bar-content {
            max-width: 1024px; margin: 0 auto; padding: 0 2rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .action-bar-buttons-group {
            display: flex; align-items: center; gap: 0.75rem;
            width: 100%; /* Garante que o grupo ocupe o espa√ßo */
        }
        .action-bar-buttons-group.hidden { display: none; }
        .action-bar-buttons-group .action-bar-title {
            white-space: nowrap; /* Impede que o t√≠tulo quebre linha */
            font-weight: 600;
            color: var(--text-dark);
        }
        .action-bar-buttons-group .btn-container {
            /* Removido flex e justify-content, agora √© grid */
            /* display: flex; gap: 0.75rem; justify-content: flex-end; width: 100%; */
        }
        .btn-container .btn {
            padding: 0.5rem 1rem; /* Um pouco menores */
            font-size: 0.875rem;
        }
        /* Corre√ß√£o para o espa√ßamento dos bot√µes clonados */
        /* REMOVIDO: .action-bar-buttons-group .btn-container .btn { margin-left: 0.75rem; } */
        /* REMOVIDO: .action-bar-buttons-group .btn-container .btn:first-child { margin-left: 0; } */

        /* ========================================================== */
        /* ======== ESTILOS PARA A BARRA DE PROGRESO ========= */
        /* ========================================================== */
        #progressBar {
            transition: width 0.5s ease-in-out; /* Anima√ß√£o suave do crescimento da barra */
            background-color: var(--success-color); /* Usa a nossa cor de sucesso verde! */
        }

        /* ========================================================== */
        /* ===== CORRE√á√ÉO DE COR DE TEXTO PARA MODO CLARO ===== */
        /* ========================================================== */
        /* REMOVIDO: body:not(.dark) #titlesThumbnailsSection .p-3 p { color: #374151; } */
        /* REMOVIDO: body:not(.dark) #titlesThumbnailsSection .font-semibold { color: #1f2937; } */

        /* ========================================================== */
        /* ==================== MODO ESCURO ======================= */
        /* ========================================================== */
        body.dark {
            /* background-color e color j√° definidos acima */
        }
        .dark .container, .dark .accordion-item {
            /* background-color j√° definido acima */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }
        .dark .accordion-item { border-color: #4b5563; }
        .dark .floating-action-bar { background-color: rgba(31, 41, 55, 0.9); }
        .dark .action-bar-title, .dark h3, .dark h4, .dark label, .dark p { /* color j√° definido acima */ }
        .dark .text-gray-500 { color: #9ca3af; }
        .dark .input-group label { /* color j√° definido acima */ }
        /* As regras para .dark .input-group input, select, textarea j√° est√£o no bloco definitivo acima */
        .dark .input-group input:focus,
        .dark .input-group select:focus,
        .dark .input-group textarea:focus {
            border-color: #6366f1 !important; /* indigo-500 */
            background-color: #4b5563 !important; /* gray-600 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3) !important;
        }
        /* --- CORRE√á√ÉO PARA O PLACEHOLDER --- */
        .dark .input-group input::placeholder,
        .dark .input-group textarea::placeholder {
            color: #9ca3af; /* gray-400 */
        }
        /* Cor de texto para elementos no modo escuro */
        .dark h1, .dark h2, .dark h3, .dark h4, .dark label {
            color: #f3f4f6;
        }
        .dark .input-group input, .dark .input-group select, .dark .input-group textarea {
            color: #f9fafb;
        }

        .dark .bg-indigo-50 { background-color: #374151 !important; }
        .dark .border-indigo-200 { border-color: #4b5563 !important; }
        .dark .text-indigo-800 { color: #a5b4fc !important; }
        .dark .bg-gray-50 { background-color: #374151 !important; }
        .dark .border-gray-200 { border-color: #4b5563 !important; }
        .dark .accordion-body .generated-content-wrapper[contenteditable="true"]:focus {
            background-color: #4b5563;
        }
        .dark .individual-prompt-block {
            /* background-color e border j√° definidos por .card-background */
        }
        .dark .prompt-phrase { color: #f3f4f6; }
        .dark .prompt-description-label { color: #9ca3af; }
        .dark .prompt-description-content { color: #d1d5db; }
        .dark pre { background-color: #374151 !important; color: #d1d5db; }
        .dark #darkModeToggle { color: #9ca3af; }

        /* Corre√ß√£o Espec√≠fica para Modo Escuro */
        /* Garante que o input do tema siga as regras */
        .dark #videoTheme.card-background {
            background-color: #374151 !important; 
            border-color: #4b5563 !important; 
        }
        /* Garante que o container dos bot√µes de gera√ß√£o siga as regras */
        .dark #scriptGenerationControls.card-background {
            background-color: rgba(31, 41, 55, 0.9) !important; /* Fundo cinza-800 com mais transpar√™ncia */
            border-top: 1px solid rgba(255, 255, 255, 0.1) !important; /* Borda superior clara e sutil */
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3) !important; /* Sombra um pouco mais forte para o modo escuro */
        }

        /* ========================================================== */
        /* ==================== ESTILOS TOOLTIP ===================== */
        /* ========================================================== */
        .tooltip {
            position: relative;
            cursor: help;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #e0e7ff; /* Indigo-100 */
            color: #4338ca; /* Indigo-700 */
            font-weight: bold;
            font-size: 0.8rem;
            /* Removido border para usar .card-background, mas manteremos o border-color para a borda espec√≠fica do tooltip */
            border-color: #c7d2fe;
        }
        .dark .tooltip {
            background-color: #4b5563; /* Gray-600 */
            color: #e5e7eb; /* Gray-200 */
            border-color: #374151; /* Gray-700 */
        }
        /* Esconde o tooltip por padr√£o */
        .tooltip::before, .tooltip::after {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            position: absolute;
            bottom: 150%; /* Posiciona acima do (?) */
            left: 50%;
            transform: translateX(-50%) translateY(10px); /* Come√ßa um pouco abaixo */
            z-index: 10;
        }
        /* Mostra o tooltip no hover */
        .tooltip:hover::before, .tooltip:hover::after {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(0); /* Sube para a posi√ß√£o final */
        }
        /* Estilo da caixa de texto do tooltip */
        .tooltip::before {
            content: attr(data-tooltip); /* Pega o texto do atributo! */
            background-color: #1f2937; /* Gray-800 */
            color: #f9fafb; /* Gray-50 */
            padding: 0.75rem;
            border-radius: 8px;
            width: 300px; /* Largura do tooltip */
            text-align: left;
            white-space: pre-wrap; /* Respeita as quebras de linha do atributo */
            font-size: 0.85rem;
            line-height: 1.5;
            font-weight: normal;
        }
        .dark .tooltip::before {
            background-color: #374151; /* Gray-700 */
        }
        /* Estilo da setinha do tooltip */
        .tooltip::after {
            content: '';
            border-width: 6px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent; /* Seta aponta para baixo */
            margin-left: -6px; /* Centraliza a seta */
        }
        .dark .tooltip::after {
            border-color: #374151 transparent transparent transparent;
        }
        .dark .section-prompts, .dark .section-soundtrack { border-top-color: #4b5563; }
        .dark .soundtrack-list { color: #d1d5db; }

        /* Anima√ß√£o para surgimento suave das se√ß√µes */
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in {
            animation: fadeInSlideUp 0.5s ease-out forwards;
        }

        /* ========================================================== */
        /* ============ ESTILOS MODO FOCO - VERS√ÉO FINAL ============ */
        /* ========================================================== */
        /* Quando o modo foco est√° ativo... */
        /* 1. Esconde os elementos que n√£o queremos ver */
        body.zen-mode .floating-action-bar,
        body.zen-mode #mainInputsGrid,
        body.zen-mode #progressBarContainer,
        body.zen-mode #assetsColumn,
        body.zen-mode .absolute.top-4.right-4, /* Esconde os bot√µes do canto */
        body.zen-mode .container > h1,
        body.zen-mode .container > p {
            display: none !important;
        }

        /* 2. Ajusta o container e o grid principal */
        body.zen-mode .container {
            max-width: 100%;
            padding: 1rem;
        }

        body.zen-mode #projectDashboard .grid {
            display: block; /* Faz o grid se comportar como um bloco normal */
        }

        /* 3. Expande a coluna do roteiro para ocupar todo o espa√ßo */
        body.zen-mode #scriptColumn {
            max-height: none; 
            grid-column: auto; /* Reseta as regras de coluna do grid */
        }
        /* Mostra o bot√£o de sair apenas no Modo Foco */
        body.zen-mode #exitZenModeBtn {
            display: inline-flex;
        }
        
        /* ========================================================== */
        /* DELETADAS AS REGRAS CONFLITANTES DE #scriptColumn, #scriptSectionsContainer, #strategicOutlineCard */
        /* ========================================================== */
        
        /* ========================================================== */
        /* ====== PAINEL DE BOT√ïES FIXO NO RODAP√â DA TELA ===== */
        /* ========================================================== */
        #scriptGenerationControls {
            position: fixed; /* MUDAN√áA CRUCIAL: Fixo na tela */
            bottom: 0;
            left: 0;
            width: 100%; /* Ocupa a largura total da tela */
            z-index: 50; /* Aumenta o z-index para garantir que fique sobre tudo */
            
            /* Mant√©m o design de vidro */
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);

            /* AJUSTE AQUI: Um padding vertical menor fica mais elegante */
            padding: 0.75rem 1rem;
        }
        .dark #scriptGenerationControls {
            background-color: rgba(31, 41, 55, 0.9);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }
        /* Removido o estilo para #scriptGenerationControls > div pois agora o flex est√° no div pai */
        /* #scriptGenerationControls > div { 
            max-width: 1024px;
            margin: 0 auto;
        } */

        /* Ajuste fino no t√≠tulo "Gerar Se√ß√µes do Roteiro" dentro do painel */
        #scriptGenerationControls h3 {
            color: var(--text-dark) !important;
        }
        .dark #scriptGenerationControls h3 {
            color: #f3f4f6 !important;
        }

        /* ========================================================== */
        /* =============== ESTILOS DE IMPRESS√ÉO (PDF) =============== */
        /* ========================================================== */
        @media print {
            /* Esconde tudo que n√£o est√° no nosso container de impress√£o */
            body > *:not(#print-container) {
                display: none !important;
            }

            /* Regras para o container de impress√£o */
            #print-container, #print-container * {
                visibility: visible; /* Garante que ele e TODOS os seus filhos sejam vis√≠veis */
                color: #000 !important; /* FOR√áA tudo dentro dele a ser preto */
                background-color: #fff !important; /* Garante fundo branco */
            }

            #print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 1.5cm; /* Margens de documento */
                font-size: 11pt;
            }

            .print-section-title {
                font-size: 16pt;
                font-weight: bold;
                margin-top: 24px;
                margin-bottom: 12px;
                border-bottom: 1px solid #ccc;
                padding-bottom: 4px;
            }

            .print-section-content {
                line-height: 1.6;
                white-space: pre-wrap; /* Respeita as quebras de linha */
            }
        }

        /* ========================================================== */
        /* ========= CORRE√á√ïES FINAIS PARA MODO ESCURO ========== */
        /* ========================================================== */
        /* Garante que o input focado no modo escuro tenha o fundo correto */
        .dark .input-group input:focus {
            background-color: #4b5563 !important; /* gray-600 */
        }
        /* Garante que os blocos de prompt individuais fiquem escuros */
        .dark .individual-prompt-block {
            background-color: #1f2937 !important; /* gray-800 */
            border-color: #4b5563 !important; /* gray-600 */
        }
        /* Garante que o texto dentro dos prompts fique claro */
        .dark .prompt-phrase,
        .dark .prompt-description-content {
            color: #d1d5db !important; /* gray-300 */
        }
        /* Garante que o fundo do <pre> tamb√©m fique escuro */
        .dark .individual-prompt-block pre {
            background-color: #374151 !important; /* gray-700 */
        }

        /* ========================================================== */
        /* ========= CORRE√á√ïES FINAIS PARA MODO CLARO ========== */
        /* ========================================================== */
        /* Define a cor padr√£o (Modo Claro) para os t√≠tulos do dashboard */
        #projectDashboard h2,
        #projectDashboard h3 {
            color: var(--text-dark) !important;
        }
        /* Define a cor para o Modo Escuro, garantindo que ela sobrescreva o padr√£o */
        .dark #projectDashboard h2,
        .dark #projectDashboard h3 {
            color: #f3f4f6 !important; /* Cor de texto clara */
        }

        /* ========================================================== */
        /* ========= BLINDAGEM DE ESTILO PARA PROMPTS ========== */
        /* ========================================================== */
        /* Estilo para o <pre> em MODO CLARO dentro do prompt */
        .individual-prompt-block pre {
            background-color: var(--bg-light) !important; /* Ex: #f9fafb (cinza 50) */
            color: var(--text-medium) !important; /* Ex: #4b5563 (cinza 600) */
        }
        /* Estilo para o <pre> em MODO ESCURO dentro do prompt */
        .dark .individual-prompt-block pre {
            background-color: #374151 !important; /* Cinza 700 */
            color: #d1d5db !important; /* Cinza 300 */
        }

        /* ========================================================== */
        /* ==== BLINDAGEM FINAL DE TEXTOS PARA O PAINEL (AMBAS COLUNAS) - CORRIGIDO ==== */
        /* ========================================================== */
        /* Define a cor de texto padr√£o (MODO CLARO) para o conte√∫do dos pain√©is */
        /* MODIFICADO: Adicionamos os IDs dos containers de conte√∫do gerado */
        #projectDashboard #videoDescriptionContent,
        #projectDashboard #titlesThumbnailsContent,
        #projectDashboard .card-background p,
        #projectDashboard .card-background li, /* Added specific rule for li inside card-background */
        #projectDashboard .card-background strong,
        #projectDashboard .asset-card-placeholder,
        #projectDashboard .list-disc {
            color: var(--text-dark) !important;
        }

        /* Define a cor de texto (MODO ESCURO) para o conte√∫do dos pain√©is */
        /* MODIFICADO: Adicionamos os IDs dos containers de conte√∫do gerado */
        .dark #projectDashboard #videoDescriptionContent,
        .dark #projectDashboard #titlesThumbnailsContent,
        .dark #projectDashboard .card-background p,
        .dark #projectDashboard .card-background li, /* Added specific rule for li inside card-background */
        .dark #projectDashboard #titlesThumbnailsContent strong,
        .dark #projectDashboard .asset-card-placeholder,
        .dark #projectDashboard .list-disc {
            color: #d1d5db !important;
        }

        /* Ajuste espec√≠fico para os t√≠tulos H3 e H4 dentro do painel */
        #projectDashboard h3, #projectDashboard h4 {
            color: var(--text-dark) !important;
        }
        .dark #projectDashboard h3, .dark #projectDashboard h4 {
            color: #f3f4f6 !important;
        }
        /* ========================================================== */
        /* === CORRE√á√ÉO FINAL - FUNDO DO ACORDE√ÉO NO MODO ESCURO ==== */
        /* ========================================================== */
        /* Esta regra garante que o item do acorde√£o (e por heran√ßa, seu
           cabe√ßalho inativo) tenha o fundo escuro correto no Modo Escuro,
           sobrescrevendo a regra geral do modo claro. */
        .dark .accordion-item {
            background-color: #1f2937; /* Cinza 800 - o mesmo do container */
        }
        /* ========================================================== */
        /* === ESTILOS PARA ACORDE√ÉO ANINHADO (PROMPTS E TRILHA) ==== */
        /* ========================================================== */
        .nested-accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-top: 1.5rem;
            padding: 0.75rem 1rem; /* Ajustado para um padding mais compacto */
            border-top: 1px dashed var(--border-light);
            transition: background-color 0.2s;
            border-radius: 6px;
        }

        .dark .nested-accordion-header {
            border-top-color: #4b5563;
        }
        
        .nested-accordion-header:hover, .nested-accordion-header.active {
            background-color: var(--bg-light);
        }

        .dark .nested-accordion-header:hover, .dark .nested-accordion-header.active {
             background-color: #374151; /* Gray-700 */
        }

        .nested-accordion-header h4 {
            font-size: 1rem;
            font-weight: 700;
            margin: 0;
            color: var(--text-medium);
        }
        
        .dark .nested-accordion-header h4 {
            color: #9ca3af;
        }
        /* ========================================================== */
        /* ======== ESTILOS PARA O CONSULTOR DE RETEN√á√ÉO ======== */
        /* ========================================================== */
        .retention-paragraph {
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border-left-width: 4px;
            transition: background-color 0.2s;
            color: var(--text-medium); /* Aplica a cor de texto padr√£o */
        }
        .dark .retention-paragraph {
            color: #d1d5db; /* Cor de texto padr√£o para o modo escuro */
        }

        .retention-paragraph strong {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* --- Cores do Mapa de Calor --- */
        .retention-green {
            border-left-color: #10B981; /* success-color */
            background-color: rgba(16, 185, 129, 0.05);
        }
        .dark .retention-green {
            background-color: rgba(16, 185, 129, 0.1);
        }
        .retention-yellow {
            border-left-color: #FBBF24; /* Amber-400 */
            background-color: rgba(251, 191, 36, 0.05);
        }
        .dark .retention-yellow {
            background-color: rgba(251, 191, 36, 0.1);
        }
        .retention-red {
            border-left-color: #EF4444; /* Red-500 */
            background-color: rgba(239, 68, 68, 0.05);
        }
        .dark .retention-red {
            background-color: rgba(239, 68, 68, 0.1);
        }

        /* ========================================================== */
        /* ====== CORRE√á√ÉO DE COR PARA INPUTS EM CARDS ESPECIAIS ===== */
        /* ========================================================== */
        /* Garante que os labels dentro de cards com fundo cinza fiquem escuros no modo claro */
        .bg-gray-50 label {
            color: var(--text-dark); /* Cor de texto escura padr√£o */
        }
        /* Garante que eles voltem a ser claros no modo escuro */
        .dark .bg-gray-50 label {
            color: #f3f4f6; /* Cor de texto clara padr√£o */
        }

        /* ========================================================== */
        /* ============== ESTILOS PARA INTERFACE DE ABAS ============ */
        /* ========================================================== */
        .tab-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid transparent;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s ease-in-out;
        }
        .dark .tab-button {
            color: var(--text-light);
        }
        .tab-button:hover {
            color: var(--text-dark);
            border-bottom-color: var(--border-light);
        }
        .dark .tab-button:hover {
            color: #e5e7eb; /* Gray-200 */
            border-bottom-color: #4b5563; /* Gray-600 */
        }
        /* Estilo da aba ativa */
        .tab-button.active-tab {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .dark .tab-button.active-tab {
            color: #a5b4fc; /* Indigo-300 */
            border-bottom-color: #a5b4fc;
        }
        .tab-pane {
            /* Escondido por padr√£o */
            display: none;
        }
        .tab-pane.active-pane {
            /* Mostra o painel ativo */
            display: block;
            animation: fadeInSlideUp 0.4s ease-out forwards;
        }
	/* ========================================================== */
/* === ESTILO PARA LISTA DO ESBO√áO ESTRAT√âGICO (v5 - FINAL) === */
/* ========================================================== */
#outlineContent ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

/* Define o layout GRID para o item da lista */
#outlineContent ul li {
    display: grid;
    /* Coluna do marcador (15px) e coluna do texto (restante) */
    grid-template-columns: 15px 1fr;
    /* Dist√¢ncia entre o marcador e o texto */
    gap: 10px;
    align-items: start;
    margin-bottom: 0.75rem;
}

/* Estiliza o marcador (a bolinha) */
#outlineContent ul li::before {
    content: '‚Ä¢';
    color: #a5b4fc; /* Azul/lil√°s */
    font-size: 1.25rem;
    line-height: 1;
}

/* ESTA √â A REGRA FINAL QUE VAI FUNCIONAR */
#outlineContent .outline-title {
    /* Cor para o MODO CLARO (se necess√°rio) */
    color: #92400E; /* Um amarelo-escuro/marrom para contraste no branco */
    font-weight: 700;
    margin-right: 0.5rem;
}

/* REGRA ESPEC√çFICA E MAIS FORTE PARA O MODO ESCURO */
.dark #outlineContent .outline-title {
    color: #FBBF24 !important; /* Amarelo (Amber-400) */
}

/* ========================================================== */
/* ==== ESTILOS PARA O CONSULTOR DE RETEN√á√ÉO (TOOLTIP) ==== */
/* ========================================================== */
.retention-paragraph-live {
    position: relative; /* Essencial para posicionar os filhos */
}
.retention-tooltip {
    position: absolute;
    top: 100%;
    bottom: auto;
    left: 10px;
    margin-top: 8px;
    width: auto;
    max-width: 90%;
    background-color: #1f2937;
    color: #f9fafb;
    padding: 0.75rem;
    border-radius: 8px;
    font-size: 0.85rem;
    line-height: 1.5;
    z-index: 10;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: opacity 0.2s, transform 0.2s;
    pointer-events: none;
}
.dark .retention-tooltip {
    background-color: #374151;
}
.retention-paragraph-live:hover .retention-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}
.retention-action-btn {
    position: absolute;
    top: 50%;
    right: -15px;
    transform: translateY(-50%);
    background-color: var(--primary-color);
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid white;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, transform 0.2s;
    z-index: 11;
}
.retention-paragraph-live:hover .retention-action-btn {
    opacity: 1;
    visibility: visible;
}

    </style>


</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <!-- BARRA FLUTUANTE DE VOLTA AO LUGAR CERTO -->
    <div id="floatingActionBar" class="floating-action-bar">
        <div class="action-bar-content">
            <!-- Grupo de A√ß√µes Principais -->
            <div id="mainActions" class="action-bar-buttons-group">
                <span class="action-bar-title">Passo 1:</span>
                <!-- A MUDAN√áA EST√Å AQUI -->
                <div class="btn-container grid grid-cols-5 w-full gap-3">
                    <button id="float_generateIntroBtn" class="btn btn-primary">Introdu√ß√£o</button>
                    <button id="float_generateDevelopmentBtn" class="btn btn-primary">Desenvolvimento</button>
                    <button id="float_climaxBtn" class="btn btn-primary">Cl√≠max</button>
                    <button id="float_conclusionBtn" class="btn btn-primary">Conclus√£o</button>
                    <button id="float_generateCTABtn" class="btn btn-primary">CTA</button>
                </div>
            </div>
            <!-- Grupo de A√ß√µes R√°pidas -->
            <div id="quickActions" class="action-bar-buttons-group hidden">
                <span class="action-bar-title">A√ß√µes R√°pidas:</span>
                <!-- E A MUDAN√áA EST√Å AQUI -->
                <div class="btn-container grid grid-cols-4 w-full gap-3">
                    <button id="float_generateDescriptionBtn" class="btn btn-secondary">Descri√ß√£o</button>
                    <button id="float_generateTitlesAndThumbnailsBtn" class="btn btn-secondary">T√≠tulos</button>
                    <button id="float_downloadPdfBtn" class="btn btn-secondary">PDF</button>
                    <button id="float_resetScriptBtn" class="btn btn-secondary">Novo</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container relative">
        <!-- ========================================================== -->
        <!-- ===== NOVO M√ìDULO: GERADOR E VALIDADOR DE IDEIAS ===== -->
        <!-- ========================================================== -->
        <div id="ideaGeneratorSection" class="mb-12 p-6 card-background rounded-lg border-2 border-dashed border-indigo-300 dark:border-indigo-800">
            <h2 class="text-2xl font-bold text-center mb-2 text-gray-800 dark:text-gray-200">Precisa de Inspira√ß√£o?</h2>
            <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Comece por aqui. Descreva o nicho ou os temas gerais do seu canal e deixe a IA sugerir v√≠deos com alto potencial.</p>

            <div class="input-group">
                <label for="nicheDescription">Nicho do Canal ou Temas de Interesse:</label>
                <textarea id="nicheDescription" rows="3" class="card-background" placeholder="Ex: Arqueologia B√≠blica e mist√©rios n√£o resolvidos; Finan√ßas pessoais para jovens crist√£os; An√°lise de serm√µes e teologia pr√°tica..."></textarea>
            </div>

            <div class="flex justify-center mt-4">
                <button id="generateIdeasBtn" class="btn btn-primary w-full md:w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a7 7 0 0 1 7 7c0 1.503-.473 2.883-1.283 4.043-.16.185-.33.364-.504.536l.328.328a.5.5 0 0 1 0 .707l-.707.707a.5.5 0 0 1-.707 0l-1.92-1.92a.5.5 0 0 1 0-.707l.328-.328c-.172-.174-.35-.355-.536-.504A6.98 6.98 0 0 1 1 8a7 7 0 0 1 7-7zm0 1a6 6 0 1 0 0 12A6 6 0 0 0 8 2z"/><path d="M8 4.25a.75.75 0 0 1 .75.75v1.25a.75.75 0 0 1-1.5 0V5a.75.75 0 0 1 .75-.75zM8.5 8a.5.5 0 0 0-1 0v2.5a.5.5 0 0 0 1 0V8z"/></svg>
                    <span class="button-text">Gerar Ideias de V√≠deo</span>
                    <div class="loading-spinner hidden"></div>
                </button>
            </div>

            <!-- √Årea de Sa√≠da para as Ideias Geradas -->
            <div id="ideasOutput" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Os cart√µes de ideia ser√£o injetados aqui -->
            </div>
        </div>
        <!-- Divis√≥ria para separar as se√ß√µes -->
        <div class="relative flex py-5 items-center">
            <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
            <span class="flex-shrink mx-4 text-gray-400 dark:text-gray-500 font-semibold">OU COMECE DIRETAMENTE AQUI</span>
            <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
        </div>
        
        <div class="absolute top-4 right-4 flex items-center gap-2 z-[1001]">
            <button id="toggleZenModeBtn" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-gray-500 dark:text-gray-400" title="Modo Foco">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/><path d="M3 14.5a1.5 1.5 0 0 1-1.5-1.5V3a1.5 1.5 0 0 1 1.5-1.5h10A1.5 1.5 0 0 1 14.5 3v10a1.5 1.5 0 0 1-1.5 1.5H3zM4 3v10h8V3H4z"/></svg>
            </button>
            <button id="darkModeToggle" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-gray-500 dark:text-gray-400" title="Modo Escuro">
                <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-14.66l-.707.707M4.04 19.96l-.707.707M21 12h-1M4 12H3m16.66-7.96l-.707-.707M4.04 4.04l-.707-.707m11.314 0l-1.414 1.414M5.464 18.536l-1.414 1.414m12.728-1.414l-1.414-1.414m-9.9-9.9l-1.414-1.414M12 6a6 6 0 100 12 6 6 0 000-12z" /></svg>
            </button>
        </div>
        
        <h1 class="text-4xl font-extrabold text-gray-800 dark:text-gray-100 text-center mb-2">Gerador de Roteiros Virais v3.0</h1>
        <p class="text-center text-gray-500 dark:text-gray-400 mb-8">O seu painel de controle para conte√∫do de alto impacto.</p>
        
        <!-- Se√ß√£o de Inputs da Aplica√ß√£o -->

  <!-- NOVA ESTRUTURA DE ABAS PARA OS INPUTS -->

<div id="mainInputsTabs" class="mb-8">
    <!-- 1. Navega√ß√£o das Abas -->
    <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
        <nav id="inputTabsNav" class="-mb-px flex space-x-6" aria-label="Tabs">
            <button data-tab="input-tab-basico" class="tab-button active-tab">
                <span class="text-lg mr-2">1</span> B√°sico
            </button>
            <button data-tab="input-tab-estrategia" class="tab-button">
                <span class="text-lg mr-2">2</span> Estrat√©gia Narrativa
            </button>
            <button data-tab="input-tab-tecnicos" class="tab-button">
                <span class="text-lg mr-2">3</span> Detalhes T√©cnicos
            </button>
        </nav>
    </div>

    <!-- 2. Conte√∫do das Abas -->
    <div id="inputTabContent">
        <!-- Aba 1: B√°sico -->
        <div id="input-tab-basico" class="tab-pane active-pane">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="input-group">
                    <label for="channelName">Nome do Canal:</label>
                    <input type="text" id="channelName" class="card-background" placeholder="Ex: The Biblical Unveiling" value="The Biblical Unveiling">
                </div>
                <div class="input-group">
                    <label for="videoTheme">Tema do V√≠deo:</label>
                    <input type="text" id="videoTheme" class="card-background" placeholder="Ex: A Arca da Alian√ßa Foi Encontrada?">
                </div>
                <div class="input-group md:col-span-2">
                    <label for="videoDescription">Descri√ß√£o do V√≠deo (para inspira√ß√£o):</label>
                    <textarea id="videoDescription" rows="4" class="card-background" placeholder="Cole uma breve descri√ß√£o do v√≠deo aqui para que a IA possa usar como inspira√ß√£o para o roteiro."></textarea>
                </div>
                <div class="md:col-span-2 my-4 flex justify-center">
                    <button id="analyzeStrategyBtn" class="btn btn-primary w-full md:w-1/2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 1 0 .707.707L14 2.707a.5.5 0 0 0 0-.707ZM7.293 4A.5.5 0 1 0 8 3.293L6.707 2A.5.5 0 0 0 6 2.707L7.293 4Zm-.621 2.5a.5.5 0 0 0 0 .707l1.293 1.293a.5.5 0 0 0 .707-.707L7.38 6.207a.5.5 0 0 0-.707 0ZM5.5 7a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1Zm-1.829-1.5a.5.5 0 0 0-.707 0L2 6.793a.5.5 0 0 0 0 .707l1.293 1.293a.5.5 0 0 0 .707-.707L3.707 7.5H3.5a.5.5 0 0 0 0-1h.207L2.707 5.5Zm-1 .707a.5.5 0 0 0-.707-.707L.707 6.5a.5.5 0 0 0 0 .707l1.293 1.293a.5.5 0 0 0 .707-.707L1.293 7.5H1.5a.5.5 0 0 0 0-1h-.207L2.293 6.207Z"/><path d="M12.026 8.5H11a.5.5 0 0 0 0 1h1.026a.5.5 0 0 0 0-1Zm-1.633.293a.5.5 0 1 1 .707.707l-1.293 1.293a.5.5 0 0 1-.707-.707l1.293-1.293Zm-3.134 3.367a.5.5 0 1 0-.707.707l1.293 1.293a.5.5 0 0 0 .707-.707l-1.293-1.293Zm1.633-.293a.5.5 0 1 1 .707.707l-1.293 1.293a.5.5 0 0 1-.707-.707l1.293-1.293A.5.5 0 0 1 8.89 11.86Z"/></svg>
                        <span class="button-text">Definir Estrat√©gia com IA</span>
                        <div class="loading-spinner hidden"></div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Aba 2: Estrat√©gia Narrativa -->
        <div id="input-tab-estrategia" class="tab-pane">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="input-group md:col-span-2">
                    <label for="targetAudience">P√∫blico-Alvo:</label>
                    <input type="text" id="targetAudience" class="card-background" value="Pessoas Interessadas em Arqueologia B√≠blica e Hist√≥ria Antiga, Crist√£os e Pessoas de F√©, Entusiastas de Ci√™ncia e Ceticismo (com mente aberta), Curiosos em Geral e Amantes de Mist√©rios." readonly>
                </div>
                <div class="input-group">
                    <label for="narrativeGoal">1. Objetivo da Narrativa:</label>
                    <select id="narrativeGoal" class="card-background">
                        <option value="storytelling">Conectar e Entreter (Storytelling)</option>
                        <option value="storyselling">Persuadir e Vender (Storyselling)</option>
                    </select>
                </div>
                <div class="input-group">
                    <div class="flex items-center gap-2">
                        <label for="narrativeStructure">2. Estrutura Espec√≠fica:</label>
                        <span id="narrativeStructureTooltip" class="tooltip card-background" data-tooltip="Selecione um objetivo primeiro.">(?)</span>
                    </div>
                    <select id="narrativeStructure" class="card-background"></select>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="narrativeTheme">3. Tema Principal (a grande ideia):</label>
                    <input type="text" id="narrativeTheme" class="card-background" placeholder="Ex: Supera√ß√£o, Luta contra injusti√ßa, Inova√ß√£o, A busca pela verdade...">
                </div>
                <div class="input-group">
                    <label for="narrativeTone">4. Tom da Narra√ß√£o (a sensa√ß√£o):</label>
                    <select id="narrativeTone" class="card-background">
                        <option value="inspirador" selected>Inspirador / Motivacional</option>
                        <option value="serio">S√©rio / Factual</option>
                        <option value="emocional">Emocional / Vulner√°vel</option>
                        <option value="desafiador">Desafiador / Provocativo</option>
                        <option value="sombrio">Sombrio / Misterioso</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="narrativeVoice">5. Voz do Narrador (a personalidade):</label>
                    <input type="text" id="narrativeVoice" class="card-background" placeholder="Ex: S√°bio e experiente, Jovem e c√©tico, Apaixonado e en√©rgico...">
                </div>
                <div class="input-group md:col-span-2">
                    <label for="centralQuestion">Pergunta Central (Opcional):</label>
                    <textarea id="centralQuestion" rows="2" class="card-background" placeholder="Ex: Por que as mulheres negras s√£o mais afetadas pela viol√™ncia dom√©stica no Brasil?"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="emotionalArc">Arco Emocional Desejado (Opcional):</label>
                    <textarea id="emotionalArc" rows="2" class="card-background" placeholder="Ex: Indigna√ß√£o -> Empatia -> Determina√ß√£o"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="shockingEndingHook">O Desfecho Chocante (Hook Opcional):</label>
                    <input type="text" id="shockingEndingHook" class="card-background" placeholder="Ex: ...e foi por isso que a Arca da Alian√ßa nunca deveria ser encontrada.">
                </div>
             </div>
        </div>
        
        <!-- Aba 3: Detalhes T√©cnicos -->
        <div id="input-tab-tecnicos" class="tab-pane">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="input-group">
                    <label for="languageSelect">Idioma do Roteiro:</label>
                    <select id="languageSelect" class="card-background">
                        <option value="pt-br">Portugu√™s (Brasil)</option>
                        <option value="pt-pt">Portugu√™s (Portugal)</option>
                        <option value="en" selected>English</option>
                        <option value="es">Espa√±√£o</option>
                    </select>
                </div>
                 <div class="input-group">
                    <label for="languageStyle">Estilo de Linguagem:</label>
                    <select id="languageStyle" class="card-background">
                        <option value="formal">Formal</option>
                        <option value="informal">Informar</option>
                        <option value="emocional">Emocional</option>
                        <option value="tecnico">T√©cnico</option>
                        <option value="inspirador" selected>Inspirador</option>
                        <option value="humoristico">Humor√≠stico</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="videoObjective">Objetivo do V√≠deo:</label>
                    <select id="videoObjective" class="card-background">
                        <option value="informar" selected>Informar</option>
                        <option value="emocionar">Emocionar</option>
                        <option value="evangelizar">Evangelizar (criar defensores)</option>
                        <option value="vender">Vender</option>
                        <option value="entreter">Entreter</option>
                    </select>
                </div>
                 <div class="input-group">
                    <label for="videoDuration">Dura√ß√£o Desejada:</label>
                    <select id="videoDuration" class="card-background">
                        <option value="">-- Selecione a Dura√ß√£o --</option>
                        <option value="short">Curto (~1-3 min)</option>
                        <option value="medium">M√©dio (~4-7 min)</option>
                        <option value="long">Longo (~8-12 min)</option>
                    </select>
                </div>
                 <div class="input-group">
                    <label for="speakingPace">Ritmo de Fala:</label>
                    <select id="speakingPace" class="card-background">
                        <option value="moderate" selected>Moderado</option>
                        <option value="slow">Lento</option>
                        <option value="fast">R√°pido</option>
                    </select>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="imageDescriptionEngine">Motor de Descri√ß√£o de Imagem:</label>
                    <textarea id="imageDescriptionEngine" rows="2" class="card-background" placeholder="Ex: 'fotografias reais', 'imagens fortes', 'rostos de mulheres negras'"></textarea>
                </div>
                <div class="input-group md:col-span-2">
                    <label for="imageStyleSelect">Motor de Qualidade de Imagem:</label>
                    <select id="imageStyleSelect" class="card-background">
                        <option value="cinematic" selected>Cinematogr√°fico</option>
                        <option value="custom">Personalizado</option>
                        <option value="none">Nenhum</option>
                    </select>
                </div>
                <div class="input-group md:col-span-2" id="customImageStyleContainer" style="display: none;">
                    <label for="customImageStyle">Estilo Visual Personalizado:</label>
                    <textarea id="customImageStyle" rows="5" class="card-background" placeholder="Cole aqui o seu bloco de estilo personalizado (ex: para cartoon, anime, etc.)."></textarea>
                </div>
            </div>
        </div>
    </div>
</div>


        <!-- ========================================================== -->
        <!-- ========= NOVA BARRA DE PROGRESO VISUAL ============= -->
        <!-- ========================================================== -->
        <div id="progressBarContainer" class="progress-bar-container mb-8">
            <div class="flex justify-between mb-1">
                <span class="text-base font-medium text-gray-700 dark:text-gray-300">Progresso do Projeto</span>
                <span id="progressText" class="text-sm font-medium text-gray-700 dark:text-gray-300">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>
        <!-- ========================================================== -->
    
        <!-- ========================================================== -->
        <!-- ===== NOVA √ÅREA DE SA√çDA: O PAINEL DO PROJETO ======== -->
        <!-- ========================================================== -->
        <div id="projectDashboard" class="hidden mt-12">
            <!-- ========================================================== -->
            <!-- ============= NOVA ESTRUTURA DE ABAS (TABS) ============ -->
            <!-- ========================================================== -->
            <div>
                <!-- 1. NAVEGA√á√ÉO DAS ABAS -->
                <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
                    <nav id="tabs" class="-mb-px flex space-x-6" aria-label="Tabs">
                        <!-- As abas ser√£o geradas pelo JavaScript, mas aqui est√° um exemplo de como elas ser√£o -->
                        <button data-tab="tab-roteiro" class="tab-button active-tab">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.5 2A1.5 1.5 0 0 1 6 3.5v9A1.5 1.5 0 0 1 4.5 14h-1A1.5 1.5 0 0 1 2 12.5v-9A1.5 1.5 0 0 1 3.5 2h1zM6 3a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-10zM12.5 2A1.5 1.5 0 0 1 14 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-1A1.5 1.5 0 0 1 10 12.5v-9A1.5 1.5 0 0 1 11.5 2h1zm-1 1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-10z"/></svg>
                            <span>Roteiro</span>
                        </button>
                        <button data-tab="tab-recursos" class="tab-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zM3.5 4.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2zm0 5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2z"/></svg>
                            <span>Recursos</span>
                        </button>
                        <button data-tab="tab-exportar" class="tab-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L6.354 8.146a.5.5 0 1 0-.708.708l2 2z"/></svg>
                            <span>Exportar</span>
                        </button>
                    </nav>
                </div>

                <!-- 2. CONTE√öDO DAS ABAS -->
                <div id="tab-content">
                    <!-- Painel da Aba Roteiro -->
                    <div id="tab-roteiro" class="tab-pane active-pane">
                        <div id="scriptColumn">
                            <!-- Esbo√ßo Estrat√©gico (agora aqui) -->
                            <div id="strategicOutlineCard" class="card-background p-4 rounded-lg shadow-md mb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200">Esbo√ßo Estrat√©gico</h3>
                                    <button id="generateOutlineBtn" class="btn btn-secondary btn-small">Criar Esbo√ßo</button>
                                </div>
                                <div id="outlineContent"><div class="asset-card-placeholder">Clique em 'Criar Esbo√ßo' para a IA planejar a estrutura do roteiro.</div></div>
                            </div>

                            <!-- M√≥dulo de Estrat√©gia de Conclus√£o (agora aqui) -->
                            <div id="conclusionStrategyModule" class="hidden my-8 p-6 card-background rounded-lg border-2 border-dashed border-purple-300 dark:border-purple-800 animate-fade-in">
                                <h3 class="text-xl font-bold text-center mb-4">Qual √© o objetivo final do seu v√≠deo?</h3>
                                <div class="flex flex-col md:flex-row justify-center gap-4 mb-6">
                                    <label class="flex items-center p-3 card-background rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                        <input type="radio" name="conclusionType" value="lesson" class="form-radio h-4 w-4 text-purple-600 focus:ring-purple-500" checked>
                                        <span class="ml-2 text-gray-700 dark:text-gray-300">Deixar uma Li√ß√£o / Reflex√£o</span>
                                    </label>
                                    <label class="flex items-center p-3 card-background rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                        <input type="radio" name="conclusionType" value="answer" class="form-radio h-4 w-4 text-purple-600 focus:ring-purple-500">
                                        <span class="ml-2 text-gray-700 dark:text-gray-300">Responder uma Pergunta Central</span>
                                    </label>
                                    <label class="flex items-center p-3 card-background rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                        <input type="radio" name="conclusionType" value="cliffhanger" class="form-radio h-4 w-4 text-purple-600 focus:ring-purple-500">
                                        <span class="ml-2 text-gray-700 dark:text-gray-300">Criar um Gancho / Mist√©rio Cont√≠nuo</span>
                                    </label>
                                </div>
                                <div id="conclusionInputContainer" class="input-group mb-6 hidden">
                                    <label for="conclusionSpecifics">Detalhes para a Conclus√£o:</label>
                                    <textarea id="conclusionSpecifics" rows="3" class="card-background" placeholder="Ex: 'Foque na import√¢ncia da f√© inabal√°vel'; 'A resposta est√° na antiga profecia de Isa√≠as'; 'Deixe claro que a busca continua e o mist√©rio se aprofunda.'"></textarea>
                                </div>
                                <div class="flex justify-center">
                                    <button id="generateConclusionAndCtaBtn" class="btn btn-primary w-full md:w-1/2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a7 7 0 0 1 7 7c0 1.503-.473 2.883-1.283 4.043-.16.185-.33.364-.504.536l.328.328a.5.5 0 0 1 0 .707l-.707.707a.5.5 0 0 1-.707 0l-1.92-1.92a.5.5 0 0 1 0-.707l.328-.328c-.172-.174-.35-.355-.536-.504A6.98 6.98 0 0 1 1 8a7 7 0 0 1 7-7zm0 1a6 6 0 1 0 0 12A6 6 0 0 0 8 2z"/><path d="M8 4.25a.75.75 0 0 1 .75.75v1.25a.75.75 0 0 1-1.5 0V5a.75.75 0 0 1 .75-.75zM8.5 8a.5.5 0 0 0-1 0v2.5a.5.5 0 0 0 1 0V8z"/></svg>
                                        <span class="button-text">Gerar Conclus√£o + CTA</span>
                                        <div class="loading-spinner hidden"></div>
                                    </button>
                                </div>
                            </div>

                            <!-- Se√ß√µes do Roteiro (agora aqui) -->
                            <div id="scriptSectionsContainer" class="space-y-4">
                                <div id="introSection" class="script-section"></div>
                                <div id="developmentSection" class="script-section"></div>
                                <div id="climaxSection" class="script-section"></div>
                                <div id="conclusionSection" class="script-section"></div>
                                <!-- CTA Section will be merged into conclusionSection via JS -->
                                <div id="ctaSection" class="script-section hidden"></div> 
                            </div>
                        </div>
                    </div>

                    <!-- Painel da Aba Recursos -->
                    <div id="tab-recursos" class="tab-pane hidden">
                        <div>
                            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">‚öôÔ∏è Metadados do V√≠deo</h3>
                            <div id="metadataContainer" class="space-y-6">
                                <!-- Cart√£o: Descri√ß√£o e Hashtags -->
                                <div class="card-background p-4 rounded-lg shadow-md">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-bold text-lg text-gray-800 dark:text-gray-200">Descri√ß√£o & Hashtags</h4>
                                        <button id="generateDescriptionBtn" class="btn btn-secondary btn-small">Gerar</button>
                                    </div>
                                    <div id="videoDescriptionContent">
                                        <div class="asset-card-placeholder">Clique em 'Gerar' para ver a descri√ß√£o</div>
                                    </div>
                                </div>

                                <!-- Cart√£o: T√≠tulos e Thumbnails -->
                                <div class="card-background p-4 rounded-lg shadow-md">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-bold text-lg text-gray-800 dark:text-gray-200">T√≠tulos & Thumbnails</h4>
                                        <button id="generateTitlesAndThumbnailsBtn" class="btn btn-secondary btn-small">Gerar</button>
                                    </div>
                                    <div id="titlesThumbnailsContent">
                                        <div class="asset-card-placeholder">Clique em 'Gerar' para ver as sugest√µes</div>
                                    </div>
                                </div>

				<!-- ADICIONE O BLOCO ABAIXO -->
				    <div class="card-background p-4 rounded-lg shadow-md">
				        <div class="flex justify-between items-center mb-3">
				            <h4 class="font-bold text-lg text-gray-800 dark:text-gray-200">Recursos Sonoros (Trilha)</h4>
				            <button id="generateSoundtrackBtn" class="btn btn-secondary btn-small">Gerar</button>
				        </div>
				        <div id="soundtrackContent">
			            <div class="asset-card-placeholder">Clique em 'Gerar' para criar sugest√µes de trilha para o roteiro completo.</div>
			        </div>
				</div>

                            </div>
                        </div>
                    </div>

                    <!-- Painel da Aba Exportar -->
                    <div id="tab-exportar" class="tab-pane hidden">
                        <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">üöÄ Finalizar e Exportar Projeto</h3>
                        <div id="exportContainer" class="card-background p-6 rounded-lg">
                            <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200 mb-3">Op√ß√µes de Exporta√ß√£o</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                <button id="exportProjectBtn" class="btn btn-secondary">Exportar Projeto (JSON)</button>
                                <button id="importProjectBtn" class="btn btn-secondary">Importar Projeto</button>
                                <input type="file" id="importFileInput" class="hidden" accept=".json">
                                <button id="downloadPdfBtn" class="btn btn-secondary">Download PDF</button>
                                <button id="resetScriptBtn" class="btn btn-secondary">Novo Roteiro</button>
                                <button id="copyTranscriptBtn" class="btn btn-secondary col-span-2 sm:col-span-1">Copiar Transcri√ß√£o</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles de Gera√ß√£o, agora fixos no final da tela -->
    <div id="scriptGenerationControls">
        <div class="grid grid-cols-5 gap-3 max-w-4xl mx-auto">
            <button id="generateIntroBtn" class="btn btn-primary btn-small">Introdu√ß√£o</button>
            <button id="generateDevelopmentBtn" class="btn btn-primary btn-small">Desenvolvimento</button>
            <button id="climaxBtn" class="btn btn-primary btn-small">Cl√≠max</button>
            <button id="conclusionBtn" class="btn btn-primary btn-small">Conclus√£o</button>
            <button id="generateCTABtn" class="btn btn-primary btn-small">CTA</button>
        </div>
    </div>

    <!-- Bot√£o para Sair do Modo Foco (come√ßa escondido) -->
    <button id="exitZenModeBtn" class="hidden fixed top-5 right-5 z-[2001] bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/><path d="M3 14.5a1.5 1.5 0 0 1-1.5-1.5V3a1.5 1.5 0 0 1 1.5-1.5h10A1.5 1.5 0 0 1 14.5 3v10a1.5 1.5 0 0 1-1.5 1.5H3zM4 3v10h8V3H4z"/></svg>
            </button>
    
    <!-- Elementos de Feedback (Toast e Alerta) -->
    <div id="toastNotification" class="toast-notification"></div>
    <div id="fullScreenAlertOverlay">
        <div id="fullScreenAlertBox" class="card-background">
            <p id="fullScreenAlertMessage"></p>
            <button id="fullScreenAlertCloseBtn">Entendi</button>
        </div>
    </div>
    
    <script type="module">
        // ==========================================================
        // ==================== SETUP INICIAL =======================
        // ==========================================================
        // Vari√°veis de estado globais
        let generatedTitlesAndThumbnails = null;
        let allImagePrompts = {}; 
        let strategicOutline = null;
        let totalScriptSeconds = 0;
        let promptPaginationState = {};
	let isSettingStrategy = false; // <-- NOSSO NOVO SINALIZADOR
    
        // Bloco de estilo cinematogr√°fico para prompts de imagem
        const CINEMATIC_STYLE_BLOCK = `
Ultra-realistic, high-resolution photographic image. Captured with natural lighting and cinematic composition. Rich textures and fine surface details ‚Äî visible skin pores, fabric fibers, weathered materials, realistic reflections, and organic imperfections. Sharp focus with subtle depth of field. True-to-life colors with refined tonal range. Every element should look authentic, physical, and believable ‚Äî as if taken with a high-end DSLR camera. No exaggerated features, no artificial smoothness ‚Äî only pure, grounded realism.`;
        // Labels para descri√ß√£o de imagem em diferentes idiomas
        const imageDescriptionLabels = { 'pt-br': 'Descri√ß√£o da Imagem:', 'pt-pt': 'Descri√ß√£o da Imagem:', 'en': 'Image Description:' };

        // Mapeamento de elementos do DOM para acesso f√°cil
        const elements = {};
        const buttons = {};
        // Mapeia todos os elementos e bot√µes com ID
        document.querySelectorAll('[id]').forEach(el => {
            if (el.tagName === 'BUTTON') {
                buttons[el.id] = el;
            } else {
                elements[el.id] = el;
            }
        });

        // ==========================================================
        // ================== FUN√á√ïES DE UTILIDADE ==================
        // ==========================================================
        /**
         * Exibe uma notifica√ß√£o toast na parte inferior da tela.
         * @param {string} message - A mensagem a ser exibida.
         */
        window.showToast = (message) => {
            elements.toastNotification.textContent = message;
            elements.toastNotification.classList.add('toast-visible');
            setTimeout(() => {
                elements.toastNotification.classList.remove('toast-visible');
                setTimeout(() => { elements.toastNotification.textContent = ''; }, 300);
            }, 3000);
        };

        /**
         * Copia um texto para a √°rea de transfer√™ncia.
         * @param {string} text - O texto a ser copiado.
         */
        window.copyTextToClipboard = async (text) => {
            try {
                await navigator.clipboard.writeText(text);
                window.showToast('Copiado!');
            } catch (err) {
                // Fallback para navegadores mais antigos ou contextos restritos (ex: iframes)
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                try {
                    document.execCommand('copy');
                    window.showToast('Copiado!');
                } finally {
                    document.body.removeChild(ta);
                }
            }
        };

        /**
         * Fornece feedback visual em um bot√£o ap√≥s uma a√ß√£o de c√≥pia.
         * @param {HTMLElement} buttonElement - O elemento do bot√£o que foi clicado.
         */
        window.showCopyFeedback = (buttonElement) => {
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = 'Copiado!';
            buttonElement.classList.add('btn-success');
            buttonElement.disabled = true; // Desabilita o bot√£o temporariamente

            setTimeout(() => {
                buttonElement.innerHTML = originalText;
                buttonElement.classList.remove('btn-success');
                buttonElement.disabled = false;
            }, 2000); // Reverte ap√≥s 2 segundos
        };

        /**
         * Mostra um spinner de carregamento e desabilita todos os bot√µes de gera√ß√£o.
         * @param {HTMLElement} button - O bot√£o que acionou o carregamento.
         */
        const showLoading = (button) => {
            // Desabilitar TODOS os bot√µes de gera√ß√£o para evitar rate limit
            Object.values(buttons).forEach(btn => { if(btn) btn.disabled = true; });
        
            const textSpan = button.querySelector('.button-text');
            const spinnerDiv = button.querySelector('.loading-spinner');

            if (textSpan) textSpan.classList.add('hidden');
            if (spinnerDiv) spinnerDiv.classList.remove('hidden');
        };

        /**
         * Esconde o spinner de carregamento e reabilita os bot√µes.
         * @param {HTMLElement} button - O bot√£o que estava em estado de carregamento.
         */
        const hideLoading = (button) => {
            // Habilita TODOS os bot√µes de gera√ß√£o novamente
            Object.values(buttons).forEach(btn => { if(btn) btn.disabled = false; });
            
            const spinnerDiv = button.querySelector('.loading-spinner');
            if (spinnerDiv) spinnerDiv.classList.add('hidden');
            
            const textSpan = button.querySelector('.button-text');
            if (textSpan) textSpan.classList.remove('hidden');

            updateButtonStates(); // Chama a fun√ß√£o centralizada para reavaliar o estado
        };

        /**
         * Marca um bot√£o (original e flutuante) como conclu√≠do (cor verde).
         * @param {string} originalId - O ID do bot√£o original.
         */
        const markButtonAsCompleted = (originalId) => {
            const originalButton = document.getElementById(originalId);
            const floatButton = document.getElementById(`float_${originalId}`);

            [originalButton, floatButton].forEach(btn => {
                if (btn) {
                    btn.classList.remove('btn-primary', 'btn-secondary');
                    btn.classList.add('btn-success');
                }
            });
            updateProgressBar(); 
        };

        /**
         * Reseta os √≠cones de conclus√£o de todos os bot√µes (original e flutuante) para suas cores padr√£o.
         */
        const resetCompletionIcons = () => {
            const passo1_buttons_ids = ['generateIntroBtn', 'generateDevelopmentBtn', 'climaxBtn', 'conclusionBtn', 'generateCTABtn'];
            
            for (const buttonId in buttons) { // Iterar sobre todos os bot√µes
                const isPasso1 = passo1_buttons_ids.includes(buttonId);
                const originalButton = document.getElementById(buttonId);
                const floatButton = document.getElementById(`float_${buttonId}`);

                // Remove a classe de sucesso e adiciona a classe correta (primary/secondary)
                [originalButton, floatButton].forEach(btn => {
                    if (btn) {
                        btn.classList.remove('btn-success');
                        if (isPasso1) {
                            btn.classList.remove('btn-secondary');
                            btn.classList.add('btn-primary');
                        } else {
                            btn.classList.remove('btn-primary');
                            btn.classList.add('btn-secondary');
                        }
                    }
                });
            }
        };
        
        /**
         * Verifica se as se√ß√µes principais do roteiro foram geradas.
         * @returns {boolean} True se todas as se√ß√µes principais foram geradas, caso contr√°rio, false.
         */
        const isScriptComplete = () => {
            return ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection'].every(id => { // CTA is now part of conclusionSection
                const section = document.getElementById(id);
                return section && !section.classList.contains('hidden') && section.querySelector('.generated-content-wrapper')?.textContent.trim() !== '';
            });
        };

        /**
         * Atualiza o estado de habilita√ß√£o/desabilita√ß√£o dos bot√µes com base no estado do roteiro. (VERS√ÉO CORRIGIDA)
         */
        const updateButtonStates = () => {
            const allMainScriptGenerated = isScriptComplete();
            const hasAnyContent = document.querySelector('#scriptColumn .accordion-item') != null; 

            // Bot√µes que dependem da conclus√£o do roteiro principal
            ['generateDescriptionBtn', 'generateTitlesAndThumbnailsBtn'].forEach(id => { 
                const originalBtn = document.getElementById(id);
                const floatBtn = document.getElementById(`float_${id}`);
                if (originalBtn) originalBtn.disabled = !allMainScriptGenerated;
                if (floatBtn) floatBtn.disabled = !allMainScriptGenerated;
            });
            
            const resetBtn = document.getElementById('resetScriptBtn');
            const floatResetBtn = document.getElementById('float_resetScriptBtn');
            if (resetBtn) resetBtn.disabled = false; 
            if (floatResetBtn) floatResetBtn.disabled = false;

            // L√≥gica para mostrar/esconder o m√≥dulo de conclus√£o (AGORA MAIS SEGURA)
            const introSec = document.getElementById('introSection');
            const devSec = document.getElementById('developmentSection');
            const climaxSec = document.getElementById('climaxSection');

            // A CORRE√á√ÉO EST√Å AQUI: Verificamos se os elementos existem ANTES de ler o innerHTML
            const mainSectionsDone = 
                (introSec && introSec.innerHTML.trim() !== '') &&
                (devSec && devSec.innerHTML.trim() !== '') &&
                (climaxSec && climaxSec.innerHTML.trim() !== '');

            const conclusionModule = document.getElementById('conclusionStrategyModule');
            if (conclusionModule) { // Adicionada verifica√ß√£o de seguran√ßa aqui tamb√©m
                if (conclusionModule) { // <-- DELETE ESTA LINHA
                    if (mainSectionsDone && conclusionModule.classList.contains('hidden')) { 
                        
                        const climaxSection = document.getElementById('climaxSection');
                        if (climaxSection) {
                            climaxSection.parentNode.insertBefore(conclusionModule, climaxSection.nextSibling);
                        }
                        
                        conclusionModule.classList.remove('hidden');
                        conclusionModule.classList.add('animate-fade-in');
                        handleConclusionStrategyChange();
                        conclusionModule.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        window.showToast("√öltimo passo: Defina o objetivo da sua conclus√£o!");

                    } else if (!mainSectionsDone && !conclusionModule.classList.contains('hidden')) {
                        conclusionModule.classList.add('hidden');
                    }
                } // <-- DELETE ESTA LINHA
            }
        };

        /**
         * Mostra um alerta em tela cheia com uma mensagem.
         * @param {string} message - A mensagem a ser exibida.
         */
        const showFullScreenAlert = (message) => {
            elements.fullScreenAlertMessage.textContent = message;
            elements.fullScreenAlertOverlay.classList.add('visible');
        };

        /** Esconde o alerta em tela cheia. */
        const hideFullScreenAlert = () => {
            elements.fullScreenAlertOverlay.classList.remove('visible');
        };

        /** Alterna a visibilidade do campo de estilo de imagem personalizado. */
        const toggleCustomImageStyleVisibility = () => {
            elements.customImageStyleContainer.style.display = elements.imageStyleSelect.value === 'custom' ? 'block' : 'none';
        };

        /**
         * Coleta e concatena o texto puro de todas as se√ß√µes do roteiro na ordem correta.
         * @returns {string} A transcri√ß√£o completa e limpa.
         */
        const getTranscriptOnly = () => {
            let transcript = '';
            const sectionOrder = ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection']; // CTA is now part of conclusionSection
            
            sectionOrder.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                const contentWrapper = section?.querySelector('.generated-content-wrapper');
                if (contentWrapper?.textContent.trim()) {
                    // Adiciona o texto da se√ß√£o e duas quebras de linha para separar os par√°grafos.
                    transcript += contentWrapper.textContent.trim() + '\n\n';
                }
            });
            
            return transcript.trim();
        };
    
        /**
         * Calcula o tempo de leitura estimado de um texto.
         * @param {string} text - O texto a ser analisado.
         * @returns {string} O tempo de leitura formatado (ex: "~1 min 15 seg").
         */
        const calculateReadingTime = (text) => {
            if (!text) return "";
            const wordsPerMinute = 150; // M√©dia para um ritmo de fala moderado
            const words = text.trim().split(/\s+/).length;
            const totalSeconds = (words / wordsPerMinute) * 60;
            
            if (totalSeconds < 1) return "";
            
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.round(totalSeconds % 60);
            
            let timeString = "~";
            if (minutes > 0) {
                timeString += ` ${minutes} min`;
            }
            if (seconds > 0) {
                timeString += ` ${seconds} seg`;
            }
            
            return timeString.trim();
        };

	// ==========================================================
        // ==================== L√ìGICA DAS ABAS =====================
        // ==========================================================
        const setupTabs = () => {
            const tabButtons = document.querySelectorAll('#tabs .tab-button');
            const tabPanes = document.querySelectorAll('#tab-content .tab-pane');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                    tabPanes.forEach(pane => pane.classList.remove('active-pane'));

                    button.classList.add('active-tab');
                    const tabId = button.getAttribute('data-tab');
                    const activePane = document.getElementById(tabId);
                    if (activePane) {
                        activePane.classList.add('active-pane');
                    }
                });
            });
        };


	 /**
         * Gera sugest√µes de trilha sonora para a transcri√ß√£o completa do roteiro.
         * (VERS√ÉO GLOBAL - NA ABA RECURSOS)
         */

	const generateSoundtrack = async () => {
            const fullTranscript = getTranscriptOnly();
            if (!fullTranscript) {
                window.showToast("Gere o roteiro completo primeiro para sugerir uma trilha sonora coerente.");
                return;
            }

            const button = document.getElementById('generateSoundtrackBtn');
            const outputContainer = document.getElementById('soundtrackContent');
            
            showLoading(button);
            outputContainer.innerHTML = `<div class="loading-spinner-small mx-auto my-4"></div>`;

            const prompt = `Voc√™ √© um especialista em prompts para IAs de gera√ß√£o de m√∫sica (como Suno/Udio). Sua tarefa √© analisar o roteiro completo de um v√≠deo e criar 3 prompts de texto distintos e detalhados que capturem a ess√™ncia emocional da narrativa.

            **REGRAS DE FORMATA√á√ÉO (N√ÉO NEGOCI√ÅVEIS):**
            1. Sua resposta DEVE SER um array JSON v√°lido.
            2. O array deve conter EXATAMENTE 3 strings.
            3. CADA string deve ser um par√°grafo √∫nico, bem escrito e descritivo.

            **Roteiro completo para analisar:**
            ---
            ${fullTranscript}
            ---`;

            try {
                const rawResult = await callGroqAPI(prompt, 800);
                const analysis = cleanGeneratedText(rawResult, true);

                if (!analysis || !Array.isArray(analysis)) {
                    throw new Error("A IA retornou um formato de trilha sonora inesperado.");
                }

                let suggestionsHtml = '<ul class="soundtrack-list space-y-2">';
                analysis.forEach(suggestion => {
                    suggestionsHtml += `<li>${suggestion}</li>`;
                });
                suggestionsHtml += '</ul>';
                
                outputContainer.innerHTML = suggestionsHtml;
                markButtonAsCompleted(button.id);

            } catch (error) {
                outputContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar sugest√µes: ${error.message}</p>`;
            } finally {
                hideLoading(button);
            }
        };



	 /**
         * Gera a Conclus√£o e o CTA juntos, com base na estrat√©gia final escolhida,
         * e formata o texto corretamente para an√°lise posterior.
         */
        const generateConclusionAndCta = async () => {
            const button = document.getElementById('generateConclusionAndCtaBtn');
            if (!validateInputs()) return;
            showLoading(button);

            const conclusionType = document.querySelector('input[name="conclusionType"]:checked').value;
            const conclusionSpecifics = document.getElementById('conclusionSpecifics').value.trim();

            let strategyDirective = '';
            switch (conclusionType) {
                case 'lesson':
                    strategyDirective = `O objetivo √© refor√ßar uma li√ß√£o ou reflex√£o central. Detalhe fornecido pelo usu√°rio: '${conclusionSpecifics}'`;
                    break;
                case 'answer':
                    const question = elements.centralQuestion.value.trim() || 'a pergunta central do v√≠deo';
                    strategyDirective = `O objetivo √© responder de forma clara √† pergunta central do v√≠deo ('${question}'). Detalhe fornecido pelo usu√°rio: '${conclusionSpecifics}'`;
                    break;
                case 'cliffhanger':
                    strategyDirective = `O objetivo √© criar um gancho ou mist√©rio para o pr√≥ximo v√≠deo. Detalhe fornecido pelo usu√°rio: '${conclusionSpecifics}'`;
                    break;
            }
            
            const baseContext = getBasePromptContext();
            const prompt = `${baseContext}
            Voc√™ √© um mestre roteirista. Sua tarefa √© escrever a **Conclus√£o e o Call to Action (CTA)** do v√≠deo, JUNTOS, em um √∫nico bloco de texto fluido.
            **Diretiva Estrat√©gica para o Final:** ${strategyDirective}
            **REGRAS CR√çTICAS:** Responda APENAS com o texto final para ser falado. Sem metadados, sem labels (como "Conclus√£o:", "CTA:"), apenas o texto.`;

            try {
                let result = await callGroqAPI(prompt, 800);
                result = removeMetaComments(result.trim());

                const paragraphs = result.split('\n').filter(p => p.trim() !== '');
                const contentWithSpans = paragraphs.map((p, index) => 
                    `<div id="conclusion-p-${index}">${p}</div>`
                ).join('');

                document.getElementById('conclusionSection').innerHTML = generateSectionHtmlContent('conclusion', 'Conclus√£o e CTA', contentWithSpans);
                document.getElementById('ctaSection').innerHTML = ''; 

                markButtonAsCompleted('conclusionBtn');
                markButtonAsCompleted('generateCTABtn');

                document.getElementById('conclusionStrategyModule').classList.add('hidden');
                window.showToast("Conclus√£o e CTA gerados com sucesso!");
                updateButtonStates();

            } catch(error) {
                window.showToast(`Falha ao gerar a conclus√£o: ${error.message}`);
            } finally {
                hideLoading(button);
            }
        };

	// ==========================================================
        // NOVA FUN√á√ÉO PARA ATUALIZAR A BARRA DE PROGRESO
        // ==========================================================
        const updateProgressBar = () => {
            // Lista de todas as tarefas que contam para o progresso
            const taskButtonIds = [
                'generateOutlineBtn', 
                'generateIntroBtn', 'generateDevelopmentBtn', 'climaxBtn', 
                'conclusionBtn', 'generateCTABtn', 'generateDescriptionBtn', 
                'generateTitlesAndThumbnailsBtn' 
            ];
            const totalTasks = taskButtonIds.length;

            let completedTasks = 0;
            taskButtonIds.forEach(id => {
                const button = document.getElementById(id);
                if (button && button.classList.contains('btn-success')) {
                    completedTasks++;
                }
            });

            const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            // Atualiza a UI
            if (elements.progressBar && elements.progressText) {
                elements.progressBar.style.width = `${percentage}%`;
                elements.progressText.textContent = `${percentage}%`;

                if (percentage === 100) {
                    elements.progressBar.textContent = "Projeto Pronto!"; 
                    elements.progressBar.style.color = '#ffffff';
                    elements.progressBar.style.textAlign = 'center';
                    elements.progressBar.style.backgroundColor = 'var(--primary-color)';
                } else {
                    elements.progressBar.textContent = '';
                    elements.progressBar.style.backgroundColor = 'var(--success-color)';
                }
            }
        };

        const setupInputTabs = () => {
            const nav = document.getElementById('inputTabsNav');
            if (!nav) return;

            const tabButtons = nav.querySelectorAll('.tab-button');
            const tabPanes = document.getElementById('inputTabContent').querySelectorAll('.tab-pane');

            nav.addEventListener('click', (event) => {
                const button = event.target.closest('.tab-button');
                if (!button) return;

                tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                tabPanes.forEach(pane => pane.classList.remove('active-pane'));

                button.classList.add('active-tab');
                const tabId = button.getAttribute('data-tab');
                const activePane = document.getElementById(tabId);
                if (activePane) {
                    activePane.classList.add('active-pane');
                }
            });
        };

        const handleConclusionStrategyChange = () => {
            const conclusionSpecificsContainer = document.getElementById('conclusionInputContainer');
            const answerRadioButtonLabel = document.querySelector('input[value="answer"]').parentElement;
            const answerRadioButton = document.querySelector('input[value="answer"]');

            // 1. L√≥gica para desabilitar a op√ß√£o "Responder Pergunta" se n√£o houver pergunta
            const centralQuestionText = document.getElementById('centralQuestion').value.trim();
            if (!centralQuestionText) {
                answerRadioButton.disabled = true;
                answerRadioButtonLabel.classList.add('opacity-50', 'cursor-not-allowed');
                answerRadioButtonLabel.title = "Defina a 'Pergunta Central' nos campos principais para usar esta op√ß√£o.";
                // Se a op√ß√£o desabilitada estava selecionada, muda para a primeira
                if(answerRadioButton.checked) {
                    document.querySelector('input[value="lesson"]').checked = true;
                }
            } else {
                answerRadioButton.disabled = false;
                answerRadioButtonLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                answerRadioButtonLabel.title = "";
            }
            
            const selectedValue = document.querySelector('input[name="conclusionType"]:checked').value;
            
            // 2. L√≥gica para mostrar/esconder o textarea e mudar o placeholder
            if (conclusionSpecificsContainer) {
                conclusionSpecificsContainer.classList.toggle('hidden', !['lesson', 'answer', 'cliffhanger'].includes(selectedValue));
            }
            
            const textarea = document.getElementById('conclusionSpecifics');
            if (textarea) {
                const placeholders = {
                    lesson: "Ex: A li√ß√£o √© que a resili√™ncia √© a nossa maior for√ßa...",
                    answer: "Ex: A resposta √© que a Arca foi levada para a Eti√≥pia, mas o verdadeiro segredo √©...",
                    cliffhanger: "Ex: ...mas se a Arca foi encontrada, o que aconteceu com o que estava DENTRO dela?"
                };
                textarea.placeholder = placeholders[selectedValue] || "";
            }
        };

        /**
         * Alterna a visibilidade de um corpo de acorde√£o e a rota√ß√£o de sua seta. (VERS√ÉO CORRIGIDA E ROBUSTA)
         * @param {string} bodyId - O ID do elemento do corpo do acorde√£o.
         * @param {string} arrowId - O ID do elemento da seta do acorde√£o.
         */
        window.toggleAccordion = (bodyId, arrowId) => {
            const body = document.getElementById(bodyId);
            const arrow = document.getElementById(arrowId);
            // CORRE√á√ÉO: Encontra o cabe√ßalho subindo na √°rvore DOM
            const header = body ? body.closest('.accordion-item').querySelector('.accordion-header') : null;

            if (body && arrow && header) {
                const isOpen = body.classList.toggle('open');
                arrow.classList.toggle('open', isOpen);
                header.classList.toggle('active', isOpen);
            }
        };

        /**
 * Renderiza a p√°gina correta de prompts para uma determinada se√ß√£o. (VERS√ÉO CORRIGIDA)
 * @param {string} sectionElementId - O ID da se√ß√£o (ex: 'introSection').
 */
const renderPaginatedPrompts = (sectionElementId) => {
    const sectionElement = document.getElementById(sectionElementId);
    if (!sectionElement) return;

    const itemsPerPage = 4;
    const prompts = allImagePrompts[sectionElementId] || [];
    const currentPage = promptPaginationState[sectionElementId] || 0;
    const totalPages = Math.ceil(prompts.length / itemsPerPage);

    const promptItemsContainer = sectionElement.querySelector('.prompt-items-container');
    const navContainer = sectionElement.querySelector('.prompt-nav-container');

    if (!promptItemsContainer || !navContainer) return;

    promptItemsContainer.innerHTML = ''; // Limpa o conte√∫do atual

    // --- NOVA L√ìGICA DE C√ÅLCULO GLOBAL ---
    // 1. Define o √≠ndice de in√≠cio no array completo de prompts
    const startIndex = currentPage * itemsPerPage;
    const promptsToShow = prompts.slice(startIndex, startIndex + itemsPerPage);

    // 2. Calcula a dura√ß√£o total de TODOS os prompts ANTES da p√°gina atual
    let cumulativeSeconds = 0;
    if (startIndex > 0) {
        const previousPrompts = prompts.slice(0, startIndex);
        cumulativeSeconds = previousPrompts.reduce((total, p) => total + (parseInt(p.estimated_duration, 10) || 18), 0);
    }
    // --- FIM DA NOVA L√ìGICA ---

    promptsToShow.forEach((promptData, index) => {
        const globalIndex = startIndex + index; // √çndice no array completo
        const currentSceneNumber = globalIndex + 1; // N√∫mero da cena correto

        // Calcula o timestamp para esta cena espec√≠fica
        const minutes = Math.floor(cumulativeSeconds / 60);
        const seconds = cumulativeSeconds % 60;
        const timestamp = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

        const styleBlockContent = promptData.styleBlock || '';
        const promptHtml = `
            <div class="individual-prompt-block card-background animate-fade-in" data-duration="${promptData.estimated_duration || 18}">
                <div class="flex items-center justify-between mb-2">
                    <p class="prompt-time">${timestamp} - Cena ${String(currentSceneNumber).padStart(2, '0')}</p> 
                    <button class="copy-btn" onclick="copyTextToClipboard(document.getElementById('prompt-content-${sectionElementId}-${globalIndex}')?.textContent + ' ' + document.getElementById('style-block-${sectionElementId}-${globalIndex}')?.textContent); window.showCopyFeedback(this)" title="Copiar Prompt">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
</button>
                </div>
                <p class="prompt-phrase">${promptData.scriptPhrase}</p>
                <div class="pt-2 border-t border-dashed border-gray-300 dark:border-gray-600 mt-2">
                    <p class="prompt-description-label">${imageDescriptionLabels[elements.languageSelect.value] || 'Image Description:'}</p>
                    <p id="prompt-content-${sectionElementId}-${globalIndex}" class="prompt-description-content">${promptData.imageDescription}</p>
                    ${styleBlockContent ? `<p class="text-xs mt-2 p-2 rounded-md bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400"><em>[Estilo Cinematogr√°fico Aplicado]</em></p>` : ''}
                    <pre id="style-block-${sectionElementId}-${globalIndex}" class="hidden">${styleBlockContent}</pre>
                </div>
            </div>
        `;
        promptItemsContainer.innerHTML += promptHtml;

        // Atualiza os segundos acumulados para a PR√ìXIMA itera√ß√£o do loop
        cumulativeSeconds += (parseInt(promptData.estimated_duration, 10) || 18);
    });
    
    // Atualiza os controles de navega√ß√£o (c√≥digo existente, permanece igual)
    navContainer.innerHTML = `
        <button class="btn btn-secondary btn-small" onclick="window.navigatePrompts('${sectionElementId}', -1)" ${currentPage === 0 ? 'disabled' : ''}>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg>
        </button>
        <span class="text-sm font-medium text-gray-600 dark:text-gray-400">P√°gina ${currentPage + 1} de ${totalPages}</span>
        <button class="btn btn-secondary btn-small" onclick="window.navigatePrompts('${sectionElementId}', 1)" ${currentPage + 1 >= totalPages ? 'disabled' : ''}>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
        </button>
    `;
    
    // REMOVIDO: A chamada para reNumberAllScenes() foi removida pois agora √© desnecess√°ria
};

/**
 * Valida se o array de prompts recebido da IA tem a estrutura correta.
 * @param {any} data - O dado parseado do JSON.
 * @returns {boolean} - True se for um array v√°lido de prompts, false caso contr√°rio.
 */
const validatePromptsArray = (data) => {
    // √â um array? Ele n√£o est√° vazio? O primeiro item √© um objeto com as chaves que precisamos?
    return Array.isArray(data) && data.length > 0 && data.every(item => 
        item && typeof item === 'object' && 'scriptPhrase' in item && 'imageDescription' in item
    );
};

/**
 * Reseta o conte√∫do do roteiro gerado quando um input estrat√©gico √© alterado.
 * @param {string} sourceId - O ID do elemento que causou a mudan√ßa.
 */
const resetGeneratedScriptContent = (sourceId) => {
    // S√≥ reseta se j√° houver conte√∫do gerado para n√£o incomodar o usu√°rio no in√≠cio.
    if (!strategicOutline && !document.querySelector('#scriptSectionsContainer .accordion-item')) {
        return;
    }

    console.log(`Input estrat√©gico '${sourceId}' alterado. Resetando conte√∫do do roteiro.`);

    // 1. Limpa as vari√°veis de estado
    strategicOutline = null;
    allImagePrompts = {};
    promptPaginationState = {};
    totalScriptSeconds = 0;

    // 2. Limpa a UI do esbo√ßo e das se√ß√µes
    const outlineContent = document.getElementById('outlineContent');
    if (outlineContent) {
        outlineContent.innerHTML = `<div class="asset-card-placeholder">A estrat√©gia mudou. Clique em 'Criar Esbo√ßo' novamente.</div>`;
    }

    const scriptContainer = document.getElementById('scriptSectionsContainer');
    if (scriptContainer) {
        scriptContainer.innerHTML = `
            <div id="introSection" class="script-section"></div>
            <div id="developmentSection" class="script-section"></div>
            <div id="climaxSection" class="script-section"></div>
            <div id="conclusionSection" class="script-section"></div>
            <div id="ctaSection" class="script-section hidden"></div>
        `;
    }
    
    // 3. Reseta os bot√µes de gera√ß√£o para o estado inicial
    const buttonsToReset = [
        'generateOutlineBtn', 'generateIntroBtn', 'generateDevelopmentBtn', 
        'climaxBtn', 'conclusionBtn', 'generateCTABtn', 
        'generateDescriptionBtn', 'generateTitlesAndThumbnailsBtn'
    ];
    
    buttonsToReset.forEach(id => {
        const btn = document.getElementById(id);
        const floatBtn = document.getElementById(`float_${id}`);
        [btn, floatBtn].forEach(b => {
            if (b) {
                b.classList.remove('btn-success');
                // Adiciona a classe correta (primary ou secondary)
                if (['generateDescriptionBtn', 'generateTitlesAndThumbnailsBtn', 'generateOutlineBtn'].includes(id)) {
                    b.classList.add('btn-secondary');
                } else {
                    b.classList.add('btn-primary');
                }
            }
        });
    });

    // 4. Atualiza a UI e notifica o usu√°rio
    updateProgressBar();
    updateButtonStates();
    const sourceLabel = document.querySelector(`label[for='${sourceId}']`)?.textContent || sourceId;
    window.showToast(`'${sourceLabel}' mudou. O roteiro foi resetado.`);
};


/**
 * Invalida e limpa os prompts de imagem de uma se√ß√£o quando seu texto √© alterado.
 * @param {HTMLElement} sectionElement - O elemento da se√ß√£o (ex: o div com id="introSection").
 */
const invalidateAndClearPrompts = (sectionElement) => {
    if (!sectionElement) return;

    const sectionId = sectionElement.id;
    const promptContainer = sectionElement.querySelector('.prompt-container');

    // 1. Remove os prompts da mem√≥ria (do estado global)
    if (allImagePrompts[sectionId]) {
        delete allImagePrompts[sectionId];
        console.log(`Prompts para a se√ß√£o '${sectionId}' invalidados e removidos da mem√≥ria.`);
    }
    
    // 2. Limpa a interface do usu√°rio, se os prompts j√° foram renderizados
    if (promptContainer && promptContainer.innerHTML.trim() !== '') {
        promptContainer.innerHTML = `
            <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-md border-l-4 border-yellow-400">
                <p class="text-sm text-yellow-700 dark:text-yellow-300 font-semibold">
                    Aten√ß√£o: O roteiro foi modificado.
                </p>
                <p class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">
                    Por favor, clique em "Gerar Prompts de Imagem" novamente para criar novos recursos visuais com base no texto atualizado.
                </p>
            </div>
        `;
    }
};

        /**
         * Lida com os cliques nas setas de navega√ß√£o dos prompts.
         * @param {string} sectionElementId - O ID da se√ß√£o.
         * @param {number} direction - -1 para a esquerda, 1 para a direita.
         */
        window.navigatePrompts = (sectionElementId, direction) => {
            const prompts = allImagePrompts[sectionElementId] || [];
            const itemsPerPage = 4;
            const totalPages = Math.ceil(prompts.length / itemsPerPage);
            let currentPage = promptPaginationState[sectionElementId] || 0;

            const newPage = currentPage + direction;

            // Valida√ß√£o dos limites
            if (newPage >= 0 && newPage < totalPages) {
                promptPaginationState[sectionElementId] = newPage;
                renderPaginatedPrompts(sectionElementId);
            }
        };
    
         /**
         * Gera o HTML para uma se√ß√£o do roteiro. (VERS√ÉO FINAL√çSSIMA COM ACORDE√ÉO CORRIGIDO)
         */
        const generateSectionHtmlContent = (sectionId, title, content) => {
            const mainBodyId = `${sectionId}Body`;
            const mainArrowId = `${sectionId}Arrow`;
            const promptsBodyId = `promptsBody-${sectionId}`;
            const promptsArrowId = `promptsArrow-${sectionId}`;
            const soundtrackBodyId = `soundtrackBody-${sectionId}`;
            const soundtrackArrowId = `soundtrackArrow-${sectionId}`;

            const analysisToolsHtml = `
                <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 space-y-6">
                    <div>
                        <h5 class="font-semibold text-base mb-2 text-gray-800 dark:text-gray-200">Passo 1: Diagn√≥stico e Criativo</h5>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Analise a reten√ß√£o de cada par√°grafo e, se precisar, enrique√ßa trechos espec√≠ficos com uma linguagem mais poderosa. Selecione um trecho e clique.</p>
                        <div class="flex items-center gap-2">
                            <button class="btn btn-secondary btn-small" onclick="window.analyzeSectionRetention('${sectionId}Section')">Analisar Reten√ß√£o</button>
                            <button class="btn btn-secondary btn-small" onclick="window.enrichText(this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 1 0 .707.707L14 2.707a.5.5 0 0 0 0-.707ZM7.293 4A.5.5 0 1 0 8 3.293L6.707 2A.5.5 0 0 0 6 2.707L7.293 4Zm-.621 2.5a.5.5 0 0 0 0 .707l1.293 1.293a.5.5 0 0 0 .707-.707L7.38 6.207a.5.5 0 0 0-.707 0ZM5.5 7a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1Zm-1.829-1.5a.5.5 0 0 0-.707 0L2 6.793a.5.5 0 0 0 0 .707l1.293 1.293a.5.5 0 0 0 .707-.707L3.707 7.5H3.5a.5.5 0 0 0 0-1h.207L2.707 5.5Zm-1 .707a.5.5 0 0 0-.707-.707L.707 6.5a.5.5 0 0 0 0 .707l1.293 1.293a.5.5 0 0 0 .707-.707L1.293 7.5H1.5a.5.5 0 0 0 0-1h-.207L2.293 6.207Z"/><path d="M12.026 8.5H11a.5.5 0 0 0 0 1h1.026a.5.5 0 0 0 0-1Zm-1.633.293a.5.5 0 1 1 .707.707l-1.293 1.293a.5.5 0 0 1-.707-.707l1.293-1.293Zm-3.134 3.367a.5.5 0 1 0-.707.707l1.293 1.293a.5.5 0 0 0 .707-.707l-1.293-1.293Zm1.633-.293a.5.5 0 1 1 .707.707l-1.293 1.293a.5.5 0 0 1-.707-.707l1.293-1.293A.5.5 0 0 1 8.89 11.86Z"/></svg>
                                <span class="button-text">Enriquecer Texto</span>
                            </button>
                        </div>
                        <div id="analysis-output-${sectionId}" class="section-analysis-output mt-3"></div>
                    </div>
                    <div class="pt-4 border-t border-dashed border-gray-200 dark:border-gray-700">
                         <h5 class="font-semibold text-base mb-2 text-gray-800 dark:text-gray-200">Passo 2: Estrutura de Narra√ß√£o Criativa</h5>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Ap√≥s a estrutura estar boa, adicione sugest√µes de performance para guiar a narra√ß√£o e torn√°-la mais impactante.</p>
                        <div class="flex items-center gap-2">
                            <button class="btn btn-secondary btn-small" onclick="window.suggestPerformance('${sectionId}Section')">Sugerir Performance</button>
                        </div>
                        <div class="section-performance-output mt-3"></div> 
                    </div>
                </div>
            `;
            const regenerateBtnHtml = `<button class="regenerate-btn" data-action="regenerate" data-section-id="${sectionId}Section" title="Re-gerar esta se√ß√£o"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg></button>`;
            const copyBtnHtml = `<button class="copy-btn" data-action="copy" title="Copiar Roteiro"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg></button>`;
            const headerButtonsHtml = `${regenerateBtnHtml} ${copyBtnHtml}`;

            const promptsSectionHtml = `<div class="section-prompts">
                                            <div class="nested-accordion-header">
                                                <h4>Recursos Visuais (Prompts)</h4>
                                                <svg id="${promptsArrowId}" class="accordion-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                                            </div>
                                            <div id="${promptsBodyId}" class="accordion-body">
                                                <div class="pt-2"><button class="btn btn-secondary btn-small" data-action="generate-prompts" data-section-id="${sectionId}Section">Gerar Prompts de Imagem</button><div class="prompt-container mt-4"></div></div>
                                            </div>
                                        </div>`;
            
            return `<div class="accordion-item">
                        <div class="accordion-header main-accordion-header">
                            <div class="header-content">
                                <h3>${title}</h3>
                                <span class="text-xs font-normal text-gray-400 dark:text-gray-500">${calculateReadingTime(content)}</span>
                                <svg id="${mainArrowId}" class="accordion-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                            </div>
                            <div class="header-buttons">${headerButtonsHtml}</div>
                        </div>
                        <div id="${mainBodyId}" class="accordion-body">
                            <div class="generated-content-wrapper" contenteditable="true">${content}</div>
                            ${analysisToolsHtml}
                            ${promptsSectionHtml}
                        </div>
                    </div>`;
        };
    
        /**
         * Limpa o texto gerado pela IA, removendo metadados e tentando corrigir
         * erros comuns de JSON antes de fazer o parse.
         * @param {string} text - O texto bruto da IA.
         * @param {boolean} expectJson - Se true, tenta extrair e validar um JSON.
         * @returns {string|null} O texto limpo ou o JSON stringificado, ou null em caso de erro.
         */
            const cleanGeneratedText = (text, expectJson = false) => {
            if (!text) return null;
            if (!expectJson) return text.trim();

            // 1. Remove lixo comum, como markdown e texto introdut√≥rio.
            let cleanedText = text.replace(/```json/g, '').replace(/```/g, '').trim();
            
            // 2. Encontra o in√≠cio e o fim do JSON ([...], ou {...})
            const firstBracket = cleanedText.indexOf('[');
            const firstBrace = cleanedText.indexOf('{');

            if (firstBracket === -1 && firstBrace === -1) {
                console.error("Nenhum in√≠cio de JSON ([ ou {) encontrado no texto da IA:", cleanedText);
                return null;
            }

            let startIndex = (firstBracket === -1 || (firstBrace !== -1 && firstBrace < firstBracket)) ? firstBrace : firstBracket;
            let endChar = cleanedText[startIndex] === '[' ? ']' : '}';
            let endIndex = cleanedText.lastIndexOf(endChar);

            if (endIndex === -1) {
                console.error(`N√£o foi poss√≠vel encontrar o caractere final '${endChar}' correspondente.`, cleanedText);
                return null;
            }

            let jsonString = cleanedText.substring(startIndex, endIndex + 1);

            // 3. Tenta corrigir erros comuns, como v√≠rgulas extras
            jsonString = jsonString.replace(/,\s*([}\]])/g, "$1");

            // 4. Tenta fazer o parse
            try {
                return JSON.parse(jsonString);
            } catch (e) {
                console.error("Falha ao fazer o parse do JSON extra√≠do:", e.message);
                console.error("JSON problem√°tico:", jsonString);
                return null; // Retorna null se falhar
            }
        };

        /**
         * Remove coment√°rios meta da IA do texto gerado.
         * @param {string} text - O texto gerado pela IA.
         * @returns {string} O texto sem os coment√°rios meta.
         */
        const removeMetaComments = (text) => {
            if (!text) return text;
            // Padr√£o para remover "Here is/are..." ou "Sure, here is..." etc.
            const introPattern = /^(Sure, |Of course, )?(here is|here's|here are|below is|certainly, here is) .*?:\s*\n?/im;
            let cleanedText = text.replace(introPattern, '');
            
            // Remove linhas que come√ßam com "Description:" ou "Hashtags:" se a IA as adicionar
            cleanedText = cleanedText.replace(/^(Description:|Hashtags:)\s*\n?/gim, '');

            return cleanedText.trim();
        };

        // --- IN√çCIO DO NOVO M√ìDULO DE NARRATIVA ---

        const narrativeStructures = {
            storytelling: {
                documentary: "Document√°rio (Factual e Investigativo)",
                heros_journey: "Jornada do Her√≥i (Estrutura √âpica)",
                pixar_spine: "Espinha Dorsal - Pixar (Estrutura Emocional)",
                mystery_loop: "Mist√©rio (com Loop Aberto)",
                twist: "Narrativa com Virada (Twist)"
            },
            storyselling: {
                underdog_victory: "Vit√≥ria do Vira-lata (Conex√£o e Supera√ß√£o)",
                discovery_mentor: "A Grande Descobrir / Mentor Secreto",
                if_not_found_create: "N√£o Encontrei, Ent√£o Criei (Hist√≥ria de Origem)",
                pas: "Problema-Agita√ß√£o-Solu√ß√£o (PAS)",
                bab: "Antes-Depois-Ponte (BAB)"
            }
        };

        const narrativeTooltips = {
            documentary: "Constr√≥i um argumento com fatos, evid√™ncias e uma narra√ß√£o autorit√°ria. Perfeito para v√≠deos expositivos.",
            heros_journey: "Conta uma hist√≥ria de transforma√ß√£o e supera√ß√£o. √ìtimo para narrativas inspiradoras.",
            pixar_spine: "Estrutura emocional de 8 passos (Era uma vez... todo dia... at√© que...). Pergunta para arcos de personagem r√°pidos.",
            mystery_loop: "Apresenta uma pergunta no in√≠cio e a responde no final. Excelente para reter a aten√ß√£o.",
            twist: "Constr√≥i uma expectativa e a quebra com uma revela√ß√£o surpreendente no final.",
            underdog_victory: "Mostra algu√©m com limita√ß√µes que venceu contra tudo e todos. Gera alta conex√£o emocional.",
            discovery_mentor: "Revela um grande segredo ou uma descoberta que mudou tudo. Posi√ß√£o de autoridade.",
            if_not_found_create: "Conta a hist√≥ria de origem de um produto ou servi√ßo criado a partir de uma necessidade pessoal.",
            pas: "Foca em um problema que o p√∫blico tem, agita a dor e apresenta a solu√ß√£o. Perfeito para vendas diretas.",
            bab: "Mostra um cen√°rio 'antes' (o problema), um 'depois' (o resultado ideal) e seu conte√∫do como 'a ponte' para chegar l√°."
        };

        const updateNarrativeStructureOptions = () => {
            const goalSelect = document.getElementById('narrativeGoal');
            const structureSelect = document.getElementById('narrativeStructure');
            if (!goalSelect || !structureSelect) return;

            const goal = goalSelect.value;
            structureSelect.innerHTML = ''; // Limpa as op√ß√µes atuais

            const structures = narrativeStructures[goal];
            for (const key in structures) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = structures[key];
                structureSelect.appendChild(option);
            }
            
            updateMainTooltip();
        };

        const updateMainTooltip = () => {
            const goalSelect = document.getElementById('narrativeGoal');
            const tooltip = document.getElementById('narrativeStructureTooltip');
            if (!goalSelect || !tooltip) return;

            const goal = goalSelect.value;
            const structures = narrativeStructures[goal];
            
            let tooltipContent = '';
            for (const key in structures) {
                tooltipContent += `${structures[key]}: ${narrativeTooltips[key]}

`;
            }
            
            tooltip.setAttribute('data-tooltip', tooltipContent.trim());
        };

        // --- FIM DO NOVO M√ìDULO DE NARRATIVA ---

        /**
         * Constr√≥i o contexto base do prompt com base nos inputs do usu√°rio.
         * @returns {string} O contexto do prompt.
         */
        const getBasePromptContext = () => {
            const channelName = elements.channelName.value.trim();
            const videoTheme = elements.videoTheme.value.trim();
            const targetAudience = elements.targetAudience.value.trim();
            const language = elements.languageSelect.value;
            const languageStyle = elements.languageStyle.value;
            const videoObjective = elements.videoObjective.value;
            const videoDuration = elements.videoDuration.value;
            const speakingPace = elements.speakingPace.value;
            const narrativeStructure = elements.narrativeStructure.value; // Corrected to use elements.narrativeStructure
            
            // --- IN√çCIO DA LEITURA DOS NOVOS CAMPOS ---
            const narrativeTheme = document.getElementById('narrativeTheme').value.trim();
            const narrativeTone = document.getElementById('narrativeTone').value;
            const narrativeVoice = document.getElementById('narrativeVoice').value.trim();
            // Adicione a linha abaixo
            const shockingEndingHook = document.getElementById('shockingEndingHook').value.trim();
            // --- FIM DA LEITURA DOS NOVOS CAMPOS ---

            const videoDescription = elements.videoDescription.value.trim();
            const centralQuestion = elements.centralQuestion.value.trim();
            const emotionalArc = elements.emotionalArc.value.trim();
            // REMOVIDO: const viralElements = elements.viralElements.value.trim();
            const imageDescriptionEngine = elements.imageDescriptionEngine.value.trim();
            const imageStyleSelect = elements.imageStyleSelect.value;
            const customImageStyle = elements.customImageStyle.value.trim();

            let context = `
            You are an expert YouTube scriptwriter for the channel "${channelName}".
            Your goal is to create highly engaging and viral video content.
            
            **Core Project Details:**
            - Video Topic: "${videoTheme}"
            - Target Audience: "${targetAudience}"
            - Language: "${language}"
            - Video Objective: "${videoObjective}"
            - Desired Duration: "${videoDuration}"
            
            **Narrative & Style Instructions:**
            - Narrative Structure to use: "${narrativeStructure}"
            - Speaking Pace: "${speakingPace}"
            `;

            // --- IN√çCIO DA INJE√á√ÉO DOS NOVOS DADOS NO CONTEXTO ---
            if (narrativeTheme) {
                context += `\n- Core Theme (The Big Idea): "${narrativeTheme}"`;
            }
            if (narrativeTone) {
                context += `\n- Narrative Tone (The Feeling): "${narrativeTone}"`;
            }
            if (narrativeVoice) {
                context += `\n- Narrator's Voice (The Personality): "${narrativeVoice}"`;
            }
            // --- FIM DA INJE√á√ÉO DOS NOVOS DADOS NO CONTEXTO ---

            // Adicione o bloco if abaixo
            if (shockingEndingHook) {
                context += `\n- Shocking Ending Hook to use: "${shockingEndingHook}"`;
            }

            if (videoDescription) { context += `\n\n**Additional Information & Inspiration:**\n- Inspiration/Context: "${videoDescription}"`; }
            if (centralQuestion) { context += `\n- Central Question to guide the entire script: "${centralQuestion}"`; }
            if (emotionalArc) { context += `\n- Desired Emotional Arc: "${emotionalArc}"`; }
            // REMOVIDO: if (viralElements) { context += `\n- Viral Elements to incorporate: "${viralElements}"`; }
            
            if (imageStyleSelect === 'cinematic' || imageStyleSelect === 'custom') {
                context += `\n\n**Visual Style Instructions:**`;
                if (imageDescriptionEngine) { context += `\n- Image Description Keywords: "${imageDescriptionEngine}"`; }
                if (imageStyleSelect === 'cinematic') {
                    context += `\n- Image Style: ${CINEMATIC_STYLE_BLOCK}`;
                } else if (imageStyleSelect === 'custom' && customImageStyle) {
                    context += `\n- Custom Image Style: ${customImageStyle}`;
                }
            }

            return context;
        };
    
        /**
         * Constr√≥i o prompt espec√≠fico para cada sec√ß√£o do roteiro ou tipo de conte√∫do.
         * @param {string} sectionName - O nome da sec√ß√£o (ex: 'intro', 'titles_thumbnails').
         * @param {string} sectionTitle - O t√≠tulo da sec√ß√£o para o prompt.
         * @param {string|null} outlineDirective - Uma diretriz espec√≠fica do esbo√ßo estrat√©gico para esta sec√ß√£o.
         * @returns {{prompt: string, maxTokens: number}} O prompt e o limite de tokens.
         */
        const constructScriptPrompt = (sectionName, sectionTitle, outlineDirective = null) => {
            const baseContext = getBasePromptContext();
            const videoDuration = elements.videoDuration.value;
            const selectedLanguage = elements.languageSelect.value;
            const narrativeStructure = elements.narrativeStructure.value; // Corrected to use elements.narrativeStructure

            let prompt = `${baseContext}

You are a master screenwriter, a true virtuoso of words. Your task is to write the **${sectionTitle}** section of the script.

**Your writing must be magnetic and professional. Follow these core principles:**
1.  **Dynamic Rhythm and Pacing:** Write with a natural, captivating cadence. Use a mix of short, punchy sentences for impact and longer, flowing sentences for description and atmosphere. Avoid monotony at all costs.
2.  **"Show, Don't Tell" on a Deeper Level:** Don't just state facts. Use vivid, sensory language to paint a picture in the viewer's mind. Evoke emotions and create a tangible experience through your words.
3.  **Human Connection:** Weave the information into a narrative that connects with the viewer on a personal level. Use "you" to speak directly to them. Ground abstract concepts in relatable human experiences and emotions.
4.  **Rhetorical Techniques:** Intelligently use rhetorical questions, powerful analogies, and striking metaphors to make the content more memorable and thought-provoking.
5.  **Hook Reinforcement:** If there is a central question, subtly remind the viewer of the mystery or the promise made in the introduction to keep them hooked and eager for the resolution.
`;
            let maxTokens = 2000;

            if (outlineDirective) {
                prompt += `\n\n**IMPORTANT STRATEGIC GUIDELINE:** For this specific section, you MUST follow this strategic plan: "${outlineDirective}"`;
            }

            prompt += `\n\nIMPORTANT: Do NOT include any scene descriptions, visual/audio cues (e.g., [SHOT], (Camera pan), (Music swells)), or speaker labels (e.g., "Narrator:", "Host:") in the generated script content. Provide only the spoken text.`;
            prompt += `\n\nABSOLUTELY NO META-COMMENTS. Do not add any explanatory text about the script itself. Your entire response must be ONLY the text to be spoken in the video, and nothing else.`;

            if (elements.centralQuestion.value.trim()) {
                prompt += `\nIf a 'Central Question' is provided, ensure every section of the script (Introduction, Development, Climax) directly contributes to exploring or answering this question. The entire video must revolve around this central theme.`;
            }

            // --- IN√çCIO DA NOVA L√ìGICA DE NARRATIVA ---
            switch (narrativeStructure) {
                case 'documentary':
                    prompt += `\n\nNARRATIVE STYLE: Use a 'Documentary' structure.
                    - **Introduction:** Start with a powerful, factual statement or a thought-provoking question that establishes the central theme. Present the "thesis" of the documentary.
                    - **Development:** Build the narrative by presenting evidence, data, and historical context in a logical sequence. Structure it like an an investigation, revealing information progressively. Use language that suggests authority and credibility (e.g., "Evidence suggests...", "Historical records show...", "Experts believe...").
                    - **Climax:** Present the most compelling piece of evidence or the central conclusion of your argument. This should be the moment where the "thesis" from the introduction is proven or deeply explored.
                    - **Conclusion:** Summarize the key findings and arguments. End with a broader reflection on the implications of the topic, leaving the viewer with a new understanding or perspective.`;
                    break;
                case 'pixar_spine':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'Pixar Spine' structure.
                    - **Introduction:** Era uma vez... (Introduce the main character and their ordinary world). Todo dia... (Describe their routine and the status quo).
                    - **Development:** At√© que um dia... (The inciting incident that changes everything). E por causa disso... (The character's journey begins, facing a series of challenges and events). E por causa disso... (The stakes get higher).
                    - **Climax:** At√© que finalmente... (The character faces the final confrontation or overcomes the main obstacle).
                    - **Conclusion:** E desde ent√£o... (Describe the new normal and the character's transformation).`;
                    break;
                case 'underdog_victory':
                     prompt += `\n\nNARRATIVE STYLE: Use the 'Victory of the Underdog' structure.
                    - **Introduction:** Present a character or entity in a disadvantaged, underestimated, or limited situation (the 'underdog').
                    - **Development:** Detail the immense challenges, the unfair obstacles, and the moments of doubt and struggle they faced. Emphasize their resilience and determination.
                    - **Climax:** The moment of ultimate triumph, where the underdog overcomes the final, greatest obstacle against all odds.
                    - **Conclusion:** Reflect on the victory, connecting it to a universal message of hope, perseverance, or potential, inspiring the audience with a "if they can do it, so can I" feeling.`;
                    break;
                case 'discovery_mentor':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'Great Discovery / Secret Mentor' structure.
                    - **Introduction:** Start with the "before" state - a life of struggle, confusion, or mediocrity. Hint that a breakthrough is coming.
                    - **Development:** Describe the moment of discovery or the encounter with a mentor. Explain the 'secret' or the new perspective that was revealed. Show how this new knowledge was applied and the first signs of change.
                    - **Climax:** Detail the peak result or the ultimate transformation achieved by applying this secret knowledge.
                    - **Conclusion:** Share the core lesson of the discovery and offer it to the audience, positioning the content as a guide to achieve similar results.`;
                    break;
                case 'if_not_found_create':
                     prompt += `\n\nNARRATIVE STYLE: Use the 'I Couldn't Find It, So I Created It' structure.
                    - **Introduction (The Problem):** Describe a personal and relatable problem you (or the protagonist) faced. Explain the frustration of searching for a solution and finding nothing adequate.
                    - **Development (The Creation):** Detail the journey of deciding to create your own solution. Describe the trial and error, the hard work, and the key insights learned along the way.
                    - **Climax (The Solution):** Present the final, successful creation (the product, the service, the method). Show how it solved the original problem perfectly.
                    - **Conclusion (The Offer):** Offer this solution to the audience, who likely share the same original problem.`;
                    break;
                case 'mystery_loop':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'Mystery/Open Loop' structure.
                    - In the **Introduction**, present a compelling central question or mystery and promise the answer by the end.
                    - In the **Development**, build suspense by exploring clues and theories, occasionally reminding the viewer of the central question.
                    - In the **Climax**, deliver the satisfying answer to the question posed in the introduction.`;
                    break;
                case 'pas':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'Problem-Agitate-Solution' structure.
                    - Frame the **Introduction** around a clear 'Problem' that the audience can relate to.
                    - Use the first part of the **Development** to 'Agitate' this problem, explaining its importance and complexity.
                    - Frame the rest of the **Development** and the **Climax** as the 'Solution' or the revealing insight that addresses the initial problem.`;
                    break;
                case 'twist':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'False Climax & Twist' structure.
                    - In the **Development**, build evidence towards a seemingly obvious conclusion (the 'false climax').
                    - In the **Climax**, introduce a surprising new piece of information or a counter-argument that completely changes the expected outcome (the 'twist').
                    - The **Conclusion** should reflect on the implications of this new, unexpected truth.`;
                    break;
                case 'heros_journey':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'Hero's Journey' structure.
                    - **Introduction:** Present the 'Ordinary World' and the 'Call to Adventure'. Introduce the central character or concept.
                    - **Development:** This is the 'Special World'. Describe the trials, allies, and enemies. Build the character's transformation through challenges.
                    - **Climax:** The 'Ordeal' or the final battle. The moment of greatest tension and the hero's ultimate test.
                    - **Conclusion:** The 'Return with the Elixir'. Show the resolution, what was learned, and how the 'Ordinary World' has changed because of the journey.
                    `;
                    break;
                case 'bab':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'Before-After-Bridge' (BAB) structure.
                    - **Introduction (Before):** Describe the 'Before' state. A world without the knowledge or solution you're about to present. Paint a picture of the problem or the lack of understanding.
                    - **Development (After):** Describe the 'After' state. A desirable world where the problem is solved or the knowledge is revealed. Show the benefits and the ideal outcome.
                    - **Climax & Conclusion (The Bridge):** Present your content as 'The Bridge'. Explain how your video's information is the exact path to get from the 'Before' state to the 'After' state. This is the solution, the 'how-to'.`;
                    break;
            }

            // O resto da fun√ß√£o continua...
            // ...
            switch (sectionName) {
                case 'outline': // New case for strategic outline
                    prompt = `${baseContext}

Voc√™ √© um mestre roteirista e estrategista de conte√∫do. Sua tarefa √© criar um "beat sheet" ou um esbo√ßo estrat√©gico detalhado para o v√≠deo. Analise todos os par√¢metros fornecidos (tema, p√∫blico, estilo narrativo, etc.) para criar a estrutura mais impactante poss√≠vel.

Responda APENAS com um objeto JSON. O objeto deve conter chaves para cada parte principal do roteiro: "introduction", "development", "climax", "conclusion", e "cta".

O valor de cada chave deve ser uma string descrevendo o objetivo, o conte√∫do e a emo√ß√£o daquela sec√ß√£o espec√≠fica. Seja conciso, mas estrat√©gico.

Exemplo de formato JSON esperado:
{
  "introduction": "Come√ßar com uma pergunta ret√≥rica chocante sobre a mortalidade, seguida por uma promessa de que a hist√≥ria de L√°zaro det√©m uma resposta inesperada. Gancho emocional: curiosidade e um toque de medo existencial.",
  "development": "Construir a narrativa explorando o luto das irm√£s de L√°zaro, humanizando a hist√≥ria. Apresentar a chegada tardia de Jesus como um ponto de tens√£o e d√∫vida. Foco na emo√ß√£o de perda antes do milagre.",
  "climax": "O momento de maior tens√£o no t√∫mulo. Descrever a ordem de Jesus com autoridade e o espanto da multid√£o. O milagre deve ser o pico emocional e visual do v√≠deo.",
  "conclusion": "Resumir a li√ß√£o: o milagre n√£o √© sobre desafiar a morte, mas sobre o poder da f√©. Conectar a hist√≥ria de L√°zaro √† jornada de f√© pessoal do espectador.",
  "cta": "Fazer uma chamada para a√ß√£o suave, pedindo para o espectador compartilhar sua pr√≥pria hist√≥ria de supera√ß√£o ou f√© nos coment√°rios, criando uma comunidade."
}
`;
                    maxTokens = 1500;
                    break;
                case 'intro':
                    // LEIA O VALOR DO NOVO CAMPO
                    const shockingHook = document.getElementById('shockingEndingHook')?.value.trim();
                    
                    // L√ìGICA CONDICIONAL PARA O PROMPT
                    if (shockingHook) {
                        prompt += `
                        \n\n**CRITICAL INSTRUCTION FOR THE INTRODUCTION:**
                        You MUST start the script EXACLTY with the following "Shocking Ending" phrase, without any preamble: "${shockingHook}"
                        After stating that phrase, use the rest of the introduction to build a deep sense of mystery and curiosity, making the audience desperate to know the chain of events that led to that ending. Do not explain the ending, only create the hook.
                        `;
                    } else {
                        // Comportamento padr√£o se o campo estiver vazio
                        prompt += `
                        The introduction should hook the viewer immediately, clearly state the video's intriguing question or mystery, and set the stage for what's to come. It must be captivating and create curiosity. For a "${videoDuration}" video, make this introduction appropriate in length and detail.
                        `;
                    }

                    if (selectedLanguage === 'pt-br' || selectedLanguage === 'pt-pt') {
                        prompt += `\n**IMPORTANT: The response for this section MUST be in Portuguese.**`;
                    }
                    maxTokens = 500;
                    break;
                case 'development':
                    prompt += `
                    The development section should delve into the core topic, presenting facts, arguments, and historical context. It should maintain a strong narrative flow, building suspense and providing compelling information. Break down complex ideas into easily digestible parts. For a "${videoDuration}" video, ensure this section is comprehensive but also flows well, adapting its length to the desired duration.
                    `;
                    maxTokens = 1500;
                    break;
                case 'climax':
                    prompt += `
                    The climax should be the most impactful part of the video, revealing key insights, surprising twists, or the most compelling evidence related to the video theme. It should be dramatic and leave the viewer with a sense of awe or profound understanding. For a "${videoDuration}" video, make this climax impactful and well-paced.
                    `;
                    if (selectedLanguage === 'pt-br' || selectedLanguage === 'pt-pt') {
                        prompt += `\n**IMPORTANT: The response for this section MUST be in Portuguese.**`;
                    }
                    maxTokens = 500;
                    break;
                case 'conclusion':
                    prompt += `
                    The conclusion should summarize the main points, provide a final thought or reflection, and leave the viewer with a lasting impression. Ensure the conclusion is complete and well-rounded, providing a sense of closure. For a "${videoDuration}" video, make this conclusion concise yet impactful.
                    `;
                    if (selectedLanguage === 'pt-br' || selectedLanguage === 'pt-pt') {
                        prompt += `\n**IMPORTANT: The response for this section MUST be in Portuguese.**`;
                    }
                    maxTokens = 500;
                    break;
                case 'cta':
                    prompt += `
                    The Call to Action (CTA) should be clear and concise, encouraging viewers to subscribe, like, comment, or share. It should be compelling and feel like a natural conclusion to the video. For a "${videoDuration}" video, keep this CTA direct and effective, **but ensure it is a complete and well-rounded paragraph.**
                    `;
                    maxTokens = 400; 
                    break;
                case 'titles_thumbnails':
                    prompt = `${baseContext}
Generate 5 highly clickable and viral YouTube video titles and 5 compelling thumbnail ideas.

IMPORTANT: Respond ONLY with a valid JSON object. Do not include any other text, preambles, or explanations outside of the JSON structure itself.

The JSON object must have two top-level keys:
1.  "titles": An array of strings.
2.  "thumbnails": Anatah array of objects, where each object has a "title" (string) and a "description" (string) key. Each description should focus on strong visual elements, emotions, and clear text overlays.

The final output MUST be only the JSON code, like this example:
{
  "titles": [
    "The Shocking Truth About the Ark of the Covenant",
    "Was the Ark of the Covenant Finally Discovered?",
    "This Ancient Secret Could Change History Forever",
    "Biblical Mystery: The Ark's Final Location Revealed",
    "They Found It? The Search for the Lost Ark Ends Here"
  ],\n  "thumbnails": [\n    {\n      "title": "FOUND?",\n      "description": "A dramatic image of an ancient, glowing chest half-buried in a dark cave, with an astonished archaeologist looking on."\n    },\n    {\n      "title": "TOP SECRET",\n      "description": "A collage showing a faded ancient map, a secret biblical text, and a satellite image pointing to a location in Ethiopia."\n    },\
    {\n      "title": "HISTORY CHANGED",\n      "description": "A visually stunning image of the Ark of the Covenant radiating golden light inside a reconstructed Solomon's Temple."\n}\n]\n}`;
                    maxTokens = 800;
                    break;
                case 'description':
                    prompt = `${baseContext}\n\nGenerate a compelling YouTube video description (around 150-200 words) that summarizes the video, includes relevant keywords for SEO, and encourages engagement. Include a strong hook, a brief overview of the content, and a call to action. Include 10 relevant hashtags.
                    Output format:
                    Description:
                    [Your description here]

                    Hashtags:
                    #hashtag1 #hashtag2 ...
                    `;
                    maxTokens = 700;
                    break;
                default:
                    maxTokens = 1000;
                    break;
            }
            return { prompt, maxTokens };
        };

        /**
         * Faz uma chamada √† API Groq atrav√©s de uma fun√ß√£o Netlify.
         * @param {string} prompt - O prompt a ser enviado para a IA.
         * @param {number} maxTokens - O n√∫mero m√°ximo de tokens para a resposta.
         * @returns {Promise<string>} A resposta bruta da IA.
         * @throws {Error} Se a chamada √† API falhar.
         */
        const callGroqAPI = async (prompt, maxTokens) => {
            const proxyUrl = "/.netlify/functions/groq"; // Endpoint do proxy

            const payload = {
                prompt: prompt,
                maxTokens: maxTokens
            };

            const request = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetch(proxyUrl, request);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: 'Erro desconhecido do servidor proxy.' } }));
                    throw new Error(`Erro na API via Proxy: ${errorData.error?.message || 'Erro do servidor'}`);
                }
                const result = await response.json();
                const rawContent = result.choices?.[0]?.message?.content;
                if (rawContent) { return rawContent; }
                else { throw new Error("Resposta inesperada da API Groq."); }
            } catch (error) {
                console.error("Fetch da API via Netlify Function falhou:", error);
                window.showToast(`Falha na API: ${error.message}`);
                throw error;
           }
        };

        /**
         * Valida os inputs essenciais antes de gerar conte√∫do.
         * @returns {boolean} True se os inputs s√£o v√°lidos, caso contr√°rio, false.
         */
        const validateInputs = () => {
            if (!elements.channelName.value.trim()) {
                window.showToast("Por favor, insira o nome do canal.");
                return false;
            }
            if (!elements.videoTheme.value.trim()) {
                window.showToast("Por favor, insira o tema do v√≠deo.");
                return false;
            }
            if (!elements.videoDescription.value.trim()) {
                window.showToast("Por favor, insira a descri√ß√£o do v√≠deo (para inspira√ß√£o).");
                return false;
            }
            if (!elements.videoDuration.value || elements.videoDuration.value === "") {
                window.showToast("Por favor, selecione a Dura√ß√£o Desejada do v√≠deo.");
                return false;
            }
            return true;
        };

        /**
         * Itera sobre todas as se√ß√µes do roteiro na ordem correta,
         * renumera globalmente todas as cenas E recalcula o timestamp
         * com base na dura√ß√£o estimada pela IA para cada cena.
         */
        
    
        /**
         * Escapa um objeto JSON para ser usado com seguran√ßa dentro de um atributo onclick.
         * @param {object} idea - O objeto da ideia a ser escapado.
         * @returns {string} Uma string JSON segura para HTML.
         */
        const escapeIdeaForOnclick = (idea) => {
            // Primeiro, converte o objeto para uma string JSON
            const jsonString = JSON.stringify(idea);
            // Em seguida, substitui os caracteres que quebram o HTML
            // Escapa aspas duplas, aspas simples e barras invertidas
            return jsonString.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\\/g, '&#92;');
        };

        // ==========================================================
        // ===== COLE ESTA FUN√á√ÉO FALTANTE NO SEU JAVASCRIPT =====
        // ==========================================================
        /**
         * Lida com a visibilidade da barra de a√ß√£o flutuante com base na posi√ß√£o de rolagem.
         */
        window.handleFloatingActionBar = () => {
            const bar = document.getElementById('floatingActionBar');
            // O gatilho para a barra aparecer ser√° a grade de inputs principais
            const triggerElement = document.getElementById('mainInputsTabs'); 

            if (!bar || !triggerElement) {
                return; // Sai da fun√ß√£o se os elementos n√£o existirem
            }

            // Ponto de gatilho: quando o final do 'mainInputsGrid' passar pelo topo da tela
            const triggerPoint = triggerElement.offsetTop + triggerElement.offsetHeight;

            if (window.scrollY > triggerPoint) {
                bar.classList.add('visible');
            } else {
                bar.classList.remove('visible');
            }
        };

        /**
         * Escapa uma string de texto plano para ser usada em um documento RTF,
         * lidando corretamente com caracteres non-ASCII e especiais.
         * @param {string} text - O texto a ser escapado.
         * @returns {string} O texto formatado para RTF.
         */
        const escapeRtf = (text) => {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i);
                // Escapa caracteres especiais do RTF
                if (charCode === 92 || charCode === 123 || charCode === 125) { // Backslash, {, }
                    result += '\\' + text.charAt(i);
                }
                // Converte caracteres non-ASCII para o formato hexadecimal do RTF
                else if (charCode > 127) {
                    let hex = charCode.toString(16);
                    if (hex.length < 2) {
                        hex = '0' + hex;
                    }
                    result += "\\'" + hex;
                }
                // Mant√©m caracteres ASCII padr√£o
                else {
                    result += text.charAt(i);
                }
            }
            return result;
        };

        // ==========================================================
        // ================== FUN√á√ïES PRINCIPAIS ====================
        // ==========================================================
        
      /**
         * Analisa a se√ß√£o, anexa tooltips com t√≠tulo e bot√µes de a√ß√£o.
         * (VERS√ÉO TOOLTIP FINAL CORRIGIDA)
         */
        window.analyzeSectionRetention = async (sectionId) => {
            const sectionElement = document.getElementById(sectionId);
            const contentWrapper = sectionElement?.querySelector('.generated-content-wrapper');
            if (!contentWrapper) return;

            const paragraphs = Array.from(contentWrapper.querySelectorAll('div[id]'));
            if (paragraphs.length === 0) {
                window.showToast("N√£o h√° par√°grafos para analisar.");
                return;
            }

            try {
                const paragraphsWithIds = paragraphs.map(p => ({ id: p.id, text: p.textContent.trim() }));
                const prompt = `You are a Retention Editor API. Analyze the following paragraphs and return a valid JSON array. For each, provide "paragraphId", "retentionScore" ('green', 'yellow', or 'red'), and a concise "suggestion".
        
        	**CRITICAL RULE: The "suggestion" MUST be written in Portuguese (Brazil).**

	        Analyze this data:
	        ${JSON.stringify(paragraphsWithIds, null, 2)}`;


                const rawResult = await callGroqAPI(prompt, 2500);
                const analysis = cleanGeneratedText(rawResult, true);

                if (!analysis || !Array.isArray(analysis)) throw new Error("An√°lise da IA em formato inv√°lido.");

                // Limpa tooltips e bot√µes antigos antes de adicionar os novos
                paragraphs.forEach(p => {
                    p.classList.remove('retention-green', 'retention-yellow', 'retention-red');
                    p.querySelector('.retention-tooltip')?.remove();
                    p.querySelector('.retention-action-btn')?.remove();
                });

                analysis.forEach(item => {
                    const p = document.getElementById(item.paragraphId);
                    if (p) {
                        p.classList.add('retention-paragraph-live', `retention-${item.retentionScore}`);
                        
                        if (item.retentionScore === 'yellow' || item.retentionScore === 'red') {
                            const scoreLabels = { green: "PONTO FORTE", yellow: "PONTO DE ATEN√á√ÉO", red: "PONTO DE RISCO" };
                            const tooltipTitle = scoreLabels[item.retentionScore] || 'AN√ÅLISE';

                            const tooltipHtml = `<div class="retention-tooltip"><strong>${tooltipTitle}:</strong> ${item.suggestion}</div>`;
                            const buttonHtml = `
                                <button class="retention-action-btn" onclick="event.stopPropagation(); window.optimizeParagraph('${item.paragraphId}', '${item.suggestion.replace(/'/g, "\\'")}')" title="Otimizar com IA">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 1 0 .707.707L14 2.707a.5.5 0 0 0 0-.707ZM7.293 4A.5.5 0 1 0 8 3.293L6.707 2A.5.5 0 0 0 6 2.707L7.293 4Zm-.621 2.5a.5.5 0 0 0 0 .707l1.293 1.293a.5.5 0 0 0 .707-.707L7.38 6.207a.5.5 0 0 0-.707 0Z"/><path d="M12.026 8.5H11a.5.5 0 0 0 0 1h1.026a.5.5 0 0 0 0-1Zm-1.633.293a.5.5 0 1 1 .707.707l-1.293 1.293a.5.5 0 0 1-.707-.707l1.293-1.293Zm-3.134 3.367a.5.5 0 1 0-.707.707l1.293 1.293a.5.5 0 0 0 .707-.707l-1.293-1.293Zm1.633-.293a.5.5 0 1 1 .707.707l-1.293 1.293a.5.5 0 0 1-.707-.707l1.293-1.293A.5.5 0 0 1 8.89 11.86Z"/></svg>
                                </button>`;
                            p.insertAdjacentHTML('beforeend', tooltipHtml + buttonHtml);
                        }
                    }
                });
                window.showToast("An√°lise de reten√ß√£o conclu√≠da!");
            } catch (error) {
                window.showToast(`Falha na an√°lise: ${error.message}`);
            }
        };



    
        /**
         * Pega um par√°grafo, otimiza com IA e substitui seu conte√∫do.
         * (VERS√ÉO TOOLTIP RESGATADA)
         */
        window.optimizeParagraph = async (paragraphId, suggestion) => {
            const paragraphElement = document.getElementById(paragraphId);
            if (!paragraphElement) return;

            const button = paragraphElement.querySelector('.retention-action-btn');
            if (button) {
                button.disabled = true;
                button.innerHTML = `<div class="loading-spinner" style="width:16px; height:16px; border-width: 2px;"></div>`;
            }

            const originalText = paragraphElement.firstChild.textContent.trim(); // Pega apenas o texto
            const languageName = document.getElementById('languageSelect').options[document.getElementById('languageSelect').selectedIndex].text;
        	const prompt = `You are an expert copywriter. Rewrite the "Original Paragraph" below based on the "Improvement Suggestion".
        
        	**CRITICAL RULE: You MUST respond in ${languageName}.** Do not change the language.

       		 **Original Paragraph:**
       		 "${originalText}"

      		  **Improvement Suggestion:**
     		   "${suggestion}"

     	   Respond ONLY with the rewritten paragraph, in ${languageName}.`;

            try {
                const rewrittenText = await callGroqAPI(prompt, 1000);
                paragraphElement.firstChild.textContent = removeMetaComments(rewrittenText);
                
                // Feedback visual
                paragraphElement.classList.remove('retention-yellow', 'retention-red');
                paragraphElement.classList.add('retention-green');
                paragraphElement.querySelector('.retention-tooltip')?.remove();
                button?.remove();
                
                invalidateAndClearPrompts(paragraphElement.closest('.script-section'));
                window.showToast("Par√°grafo otimizado!");
            } catch (error) {
                window.showToast(`Falha ao otimizar: ${error.message}`);
                if (button) button.innerHTML = '‚ö†Ô∏è'; // √çcone de erro
            }
        };




    
        /**
         * Pede √† IA para analisar uma se√ß√£o e inserir sugest√µes de performance.
         * (VERS√ÉO COM PROMPT REFINADO)
         */
        window.suggestPerformance = async (sectionId) => {
            const sectionElement = document.getElementById(sectionId);
            if (!sectionElement) return;

            const contentWrapper = sectionElement.querySelector('.generated-content-wrapper');
            const outputContainer = sectionElement.querySelector('.section-performance-output');
            
            if (!contentWrapper || !contentWrapper.textContent.trim()) {
                window.showToast("Gere o roteiro desta se√ß√£o primeiro.");
                return;
            }

            const originalText = contentWrapper.textContent.trim();
            outputContainer.innerHTML = `<div class="loading-spinner-small mx-auto my-4"></div>`;

            try {
                const languageName = elements.languageSelect.options[elements.languageSelect.selectedIndex].text;

                // ==========================================================
                // AQUI EST√Å A MUDAN√áA CRUCIAL NO PROMPT
                // ==========================================================
                const prompt = `Voc√™ √© um Diretor de Cena e um coach de narra√ß√£o para YouTubers. Sua tarefa √© pegar um roteiro e prepar√°-lo para um narrador profissional, inserindo anota√ß√µes de performance **ANTES** das frases que elas modificam e torn√°-lo muito mais impactante.

                **Roteiro Original:**
                ---
                ${originalText}
                ---

                **Sua Tarefa e Regras Cr√≠ticas:**
                1.  **ANTECIPE A INSTRU√á√ÉO:** A anota√ß√£o [em colchetes] deve vir **SEMPRE ANTES** da frase ou palavra que ela afeta. O narrador precisa ler a instru√ß√£o primeiro para depois executar a fala.
                2.  **FOCO NAS EMO√á√ïES:** Suas anota√ß√µes devem focar em:
                    - **Pausas:** Use [pausa dram√°tica], [pausa curta] ou [pausa longa] para criar suspense e ritmo.
                    - **Tom de Voz:** Sugira mudan√ßas como [tom de voz mais baixo e misterioso], [aumentando a energia], [sussurrando], [com um tom de indigna√ß√£o].
                    - **√änfase:** Indique palavras espec√≠ficas a serem enfatizadas, como [√™nfase em 'imposs√≠vel'].
                    - **Ritmo:** Sugira mudan√ßas de velocidade, como [acelerando o ritmo] ou [desacelere, com peso em cada palavra].
                3.  **N√ÉO ALTERE O TEXTO:** N√£o mude nenhuma palavra do roteiro original. Apenas adicione suas anota√ß√µes.
                4.  **RESPOSTA DIRETA:** Responda APENAS com o texto final anotado, em ${languageName}. Sem introdu√ß√µes ou coment√°rios.

                **Exemplo de Resposta Perfeita (note o posicionamento):**
                "E quando eles finalmente abriram o t√∫mulo... [pausa longa, com tom de suspense] ...o que eles encontraram mudaria a hist√≥ria para sempre. Eles n√£o encontraram um corpo, mas sim [√™nfase em 'uma mensagem']."`;
                // ==========================================================
                // FIM DA MUDAN√áA NO PROMPT
                // ==========================================================

                let performedText = await callGroqAPI(prompt, 2000);
                performedText = removeMetaComments(performedText);

                const highlightedText = performedText.replace(/(\[.*?\])/g, '<span class="text-indigo-500 dark:text-indigo-400 font-semibold italic">$1</span>');
                
                outputContainer.innerHTML = `
                    <div class="card-background p-4 mt-2 rounded-lg border-l-4 border-indigo-500">
                        <h5 class="font-bold text-sm mb-2 text-gray-700 dark:text-gray-200">Sugest√£o de Performance:</h5>
                        <p class="text-gray-800 dark:text-gray-200 leading-relaxed whitespace-pre-wrap">${highlightedText}</p>
                    </div>
                `;

            } catch (error) {
                outputContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao sugerir performance: ${error.message}</p>`;
            }
        };
    
        /**
         * Pega o texto selecionado pelo usu√°rio, pede para a IA reescrev√™-lo com uma analogia/met√°fora,
         * substitui o texto original e invalida a an√°lise anterior. (VERS√ÉO CORRIGIDA)
         * @param {HTMLElement} buttonElement - O bot√£o que foi clicado.
         */
        window.enrichText = async (buttonElement) => {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (!selectedText) {
                window.showToast("Por favor, selecione primeiro o texto que deseja enriquecer.");
                return;
            }

            showLoading(buttonElement);

            try {
                const prompt = `Voc√™ √© um Mestre Roteirista e poeta. Sua tarefa √© reescrever o "Par√°grafo Original" para incorporar a "Sugest√£o de Melhoria".

                **Par√°grafo Original:**
                "${selectedText}"

                **REGRAS:**
                - Mantenha o n√∫cleo da mensagem intacto.
                - A resposta deve ser APENAS o par√°grafo reescrito. Sem introdu√ß√µes, coment√°rios ou explica√ß√µes.`;

                const rawResult = await callGroqAPI(prompt, 500);
                const enrichedText = removeMetaComments(rawResult);

                if (selection.rangeCount > 0) {
                    document.execCommand('insertHTML', false, `<span class="highlight-change">${enrichedText}</span>`);
                }

                // ==========================================================
                // A CORRE√á√ÉO EST√Å AQUI: Invalidar a an√°lise antiga
                // ==========================================================
                // Encontra a se√ß√£o pai onde a modifica√ß√£o ocorreu
                const accordionItem = buttonElement.closest('.accordion-item');
                if (accordionItem) {
                    // Invalida a an√°lise de reten√ß√£o
                    const analysisOutput = accordionItem.querySelector('.section-analysis-output');
                    if (analysisOutput) {
                        const invalidationMessage = `<p class="text-sm text-yellow-500 italic p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-md">O texto foi modificado. Por favor, clique em "Analisar Reten√ß√£o" novamente.</p>`;
                        analysisOutput.innerHTML = invalidationMessage;
                    }
                    
                    // A CORRE√á√ÉO EXPL√çCITA: Invalida a sugest√£o de performance
                    const performanceOutput = accordionItem.querySelector('.section-performance-output');
                    if (performanceOutput) {
                        performanceOutput.innerHTML = ''; // Limpa qualquer conte√∫do antigo
                    }
                    
                    // Invalida os prompts de imagem (l√≥gica que j√° implementamos)
                    const scriptSection = accordionItem.parentElement; 
                    invalidateAndClearPrompts(scriptSection);
                }
                // ==========================================================
                // FIM DA CORRE√á√ÉO
                // ==========================================================

                window.showToast("Texto enriquecido! An√°lise anterior resetada.");

            } catch (error) {
                window.showToast(`Falha ao enriquecer o texto: ${error.message}`);
            } finally {
                hideLoading(buttonElement);
            }
        };
    
        /**
         * Gera e valida ideias de v√≠deo com base no nicho fornecido.
         */
        const generateVideoIdeas = async () => {
            const nicheDescription = document.getElementById('nicheDescription').value.trim();
            if (!nicheDescription) {
                window.showToast("Por favor, descreva o nicho do seu canal.");
                return;
            }

            const button = document.getElementById('generateIdeasBtn');
            const outputContainer = document.getElementById('ideasOutput');
            outputContainer.innerHTML = `<div class="md:col-span-2 loading-spinner-small mx-auto my-4"></div>`;
            showLoading(button);

            try {
                const prompt = `Voc√™ √© um Estrategista de Conte√∫do Viral para o YouTube. Sua tarefa √© analisar a descri√ß√£o de um nicho e gerar 6 ideias de v√≠deo com alto potencial de engajamento.

                **Nicho/Descri√ß√£o:** "${nicheDescription}"

                Para cada ideia, voc√™ deve fornecer:
                1.  **title:** Um t√≠tulo "clickbait" mas inteligente (m√°ximo 70 caracteres).
                2.  **angle:** O √¢ngulo ou abordagem √∫nica em uma frase curta (m√°ximo 120 caracteres).
                3.  **targetAudience:** O p√∫blico-alvo espec√≠fico que esta ideia mais atrairia.
                4.  **viralityScore:** Uma nota de 0 a 10 sobre o potencial de viralidade.
                5.  **videoDescription:** Uma descri√ß√£o curta e otimizada para o YouTube.

                Responda APENAS com um array JSON. Cada objeto no array deve conter exatamente as chaves acima.`;

                const rawResult = await callGroqAPI(prompt, 4000);
                const cleanedResult = cleanGeneratedText(rawResult, true);
                const ideas = cleanedResult;

                outputContainer.innerHTML = ''; 

                // --- L√ìGICA DE RENDERIZA√á√ÉO FINAL MINIMALISTA ---
                ideas.forEach((idea, index) => {
                    const ideaCard = `
                        <div class="card-background p-4 rounded-lg shadow-md border-l-4 border-indigo-500 animate-fade-in flex flex-col justify-between min-h-[140px]">
                            <div>
                                <div class="flex justify-between items-start gap-4">
                                    <h4 class="font-bold text-base text-gray-800 dark:text-gray-200 flex-grow">${index + 1}. ${idea.title}</h4>
                                    <button class="btn btn-primary btn-small flex-shrink-0 py-1 px-3" onclick="window.selectIdea(${escapeIdeaForOnclick(idea)})">
                                        Usar
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 italic mt-2">"${idea.angle}"</p>
                            </div>
                            <span class="font-bold text-sm text-indigo-500 bg-indigo-100 dark:bg-indigo-900 dark:text-indigo-300 py-1 px-2 rounded self-start mt-3">
                                Potencial: ${idea.viralityScore} / 10
                            </span>
                        </div>
                    `;
                    outputContainer.innerHTML += ideaCard;
                });

            } catch (error) {
                outputContainer.innerHTML = `<p class="md:col-span-2 text-red-500 text-sm">Falha ao gerar ideias: ${error.message}</p>`;
            } finally {
                hideLoading(button);
            }
        };
    
        /**
         * Preenche os campos do formul√°rio principal com a ideia selecionada.
         * @param {object} idea - O objeto da ideia contendo t√≠tulo, descri√ß√£o, etc.
         */
        window.selectIdea = (idea) => {
            elements.videoTheme.value = idea.title;
            elements.videoDescription.value = idea.videoDescription;
            elements.targetAudience.value = idea.targetAudience;

            // Rola suavemente para o painel principal
            document.getElementById('mainInputsTabs').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            window.showToast("Ideia selecionada! Agora defina a estrat√©gia completa.");
        };

        /**
         * Lida com a gera√ß√£o de uma sec√ß√£o espec√≠fica do roteiro.
         * @param {HTMLElement} button - O bot√£o que acionou a gera√ß√£o.
         * @param {string} sectionName - O nome da sec√ß√£o (ex: 'intro').
         * @param {string} sectionTitle - O t√≠tulo da sec√ß√£o para exibi√ß√£o.
         * @param {string} elementId - O ID do elemento HTML onde o conte√∫do ser√° inserido (ex: 'intro').
         */
        // ==========================================================
// FUN√á√ÉO handleGenerateSection CORRIGIDA E COMPLETA
// ==========================================================
const handleGenerateSection = async (button, sectionName, sectionTitle, elementId) => {
    if (!validateInputs()) return;
    if (!strategicOutline) {
        window.showToast("Crie o Esbo√ßo Estrat√©gico primeiro!");
        return;
    }
    showLoading(button);
    
    // Declara a vari√°vel aqui para ser usada em todo o escopo da fun√ß√£o
    const targetSectionElement = document.getElementById(`${elementId}Section`);

    // Limpa os resultados de an√°lise anteriores ANTES de gerar novo conte√∫do
    if (targetSectionElement) {
        const analysisOutput = targetSectionElement.querySelector('.section-analysis-output');
        const performanceOutput = targetSectionElement.querySelector('.section-performance-output');
        if (analysisOutput) analysisOutput.innerHTML = '';
        if (performanceOutput) performanceOutput.innerHTML = '';
    }

    try {
        const keyMap = { intro: 'introduction' };
	const outlineKey = keyMap[sectionName] || sectionName; // Usa 'introduction' para 'intro', ou o pr√≥prio nome para os outros ('development', 'climax')
	const directive = strategicOutline[outlineKey]; 
        const { prompt, maxTokens } = constructScriptPrompt(sectionName, sectionTitle, directive);
        
	  // ==================================================================
          // Remove coment√°rios meta da IA do texto gerado. (VERS√ÉO APRIMORADA)
          // ==================================================================
        

try {
            const keyMap = { intro: 'introduction', climax: 'climax' };
            const outlineKey = keyMap[sectionName] || sectionName;
            const directive = strategicOutline ? strategicOutline[outlineKey] : null;
            const { prompt, maxTokens } = constructScriptPrompt(sectionName, sectionTitle, directive);

            let rawResult = await callGroqAPI(prompt, maxTokens);
            let cleanedResult = removeMetaComments(rawResult.trim()); 

            const paragraphs = cleanedResult.split('\n').filter(p => p.trim() !== '');
            const contentWithDivs = paragraphs.map((p, index) => 
                `<div id="${elementId}-p-${index}">${p}</div>`
            ).join('');
            
            if (targetSectionElement) {
                const sectionHtml = generateSectionHtmlContent(elementId, sectionTitle, contentWithDivs);
                targetSectionElement.innerHTML = sectionHtml;
                targetSectionElement.querySelector('.accordion-item')?.classList.add('animate-fade-in');
            } else {
                console.error(`Elemento alvo com ID '${elementId}Section' n√£o encontrado.`);
                window.showToast("Erro interno: Se√ß√£o do roteiro n√£o encontrada.");
                return;
            }
            
            markButtonAsCompleted(button.id);
            updateButtonStates();

        } catch (error) {
            window.showToast(`Falha ao gerar ${sectionTitle}: ${error.message}`);
            console.error(`Erro ao gerar ${sectionTitle}.`, error);
        } finally {
            hideLoading(button);
        }





	const contentWithSpans = paragraphs.map((p, index) => 
   	 // Deve ser um <div> com ID
   	 `<div id="${elementId}-p-${index}">${p}</div>`
	).join(''); // E o .join() deve estar vazio
        
        if (targetSectionElement) {
            const sectionHtml = generateSectionHtmlContent(elementId, sectionTitle, contentWithSpans);
            targetSectionElement.innerHTML = sectionHtml;
            const accordionItem = targetSectionElement.querySelector('.accordion-item');
            if(accordionItem) accordionItem.classList.add('animate-fade-in');
        } else {
            console.error(`Target section element with ID '${elementId}Section' not found.`);
            window.showToast("Erro interno: Se√ß√£o do roteiro n√£o encontrada.");
            return;
        }
        
        markButtonAsCompleted(button.id);
        updateButtonStates();

    } catch (error) {
        window.showToast(`Falha ao gerar ${sectionTitle}: ${error.message}`);
        console.error(`Error generating ${sectionTitle}.`, error);
    } finally {
        hideLoading(button);
    }
};

        /**
         * Re-gera o conte√∫do de uma sec√ß√£o espec√≠fica do roteiro.
         * @param {string} sectionName - O nome da sec√ß√£o (ex: 'intro').
         * @param {string} sectionTitle - O t√≠tulo da sec√ß√£o.
         * @param {string} elementId - O ID do elemento HTML da sec√ß√£o.
         */
        // ==========================================================
// FUN√á√ÉO DE RE-GERA√á√ÉO CORRIGIDA
// ==========================================================
window.regenerateSection = (fullSectionId) => {
    // 1. Extrai a base do ID (ex: "intro" de "introSection")
    const sectionName = fullSectionId.replace('Section', '');
    
    // 2. Mapeia o nome da se√ß√£o para o bot√£o principal e o t√≠tulo
    const sectionMap = {
        'intro': { buttonId: 'generateIntroBtn', title: 'Introdu√ß√£o', elementId: 'intro' },
        'development': { buttonId: 'generateDevelopmentBtn', title: 'Desenvolvimento', elementId: 'development' },
        'climax': { buttonId: 'climaxBtn', title: 'Cl√≠max', elementId: 'climax' },
        'conclusion': { buttonId: 'generateConclusionAndCtaBtn', title: 'Conclus√£o e CTA', elementId: 'conclusion' }
    };

    const sectionInfo = sectionMap[sectionName];

    if (sectionInfo) {
        const button = document.getElementById(sectionInfo.buttonId);
        if (button) {
            // 3. Chama a fun√ß√£o principal com todos os argumentos corretos
            if (sectionName === 'conclusion') {
                 // A fun√ß√£o de conclus√£o tem uma l√≥gica diferente e √© chamada diretamente
                 generateConclusionAndCta();
            } else {
                 handleGenerateSection(button, sectionName, sectionInfo.title, sectionInfo.elementId);
            }
        } else {
            console.error(`Bot√£o com ID '${sectionInfo.buttonId}' n√£o encontrado para re-gera√ß√£o.`);
        }
    } else {
        console.error(`Informa√ß√µes da se√ß√£o n√£o encontradas para: ${sectionName}`);
    }
};

        /**
 * Gera prompts de imagem para uma se√ß√£o espec√≠fica do roteiro. (VERS√ÉO BLINDADA)
 */
window.generatePromptsForSection = async (sectionElementId) => {
    const sectionElement = document.getElementById(sectionElementId);
    const scriptContentElement = sectionElement.querySelector('.generated-content-wrapper');
    const promptContainer = sectionElement.querySelector('.prompt-container');
    
    if (!scriptContentElement || !scriptContentElement.textContent.trim()) {
        window.showToast("Por favor, gere o conte√∫do do roteiro desta se√ß√£o primeiro.");
        return;
    }

    promptContainer.innerHTML = `<div class="loading-spinner-small mx-auto my-4"></div>`;
    const scriptContent = scriptContentElement.textContent;
    const imageDescriptionEngine = elements.imageDescriptionEngine.value.trim();
    const imageStyleSelect = elements.imageStyleSelect.value;
    const customImageStyle = elements.customImageStyle.value.trim();
    let selectedStyleBlock = '';

    // --- PROMPT MELHORADO (CAMADA 3) ---
    let initialPrompt = `Voc√™ √© um Diretor de Arte e Roteirista de Storyboard. Sua tarefa √© analisar o trecho de roteiro abaixo e criar um storyboard visual com ritmo din√¢mico.
    
**REGRAS INEGOCI√ÅVEIS:**
- Sua resposta DEVE SER um array JSON v√°lido.
- Cada objeto no array DEVE ter **exatamente** tr√™s chaves: \`scriptPhrase\` (string), \`imageDescription\` (string), e \`estimated_duration\` (n√∫mero).
- Se o roteiro de entrada for vazio, sem sentido, ou voc√™ n√£o conseguir gerar prompts, sua √öNICA resposta deve ser um array vazio: \`[]\`.
- N√ÉO inclua nenhuma explica√ß√£o ou texto fora do array JSON.

Agora, analise o seguinte trecho e gere o JSON:
---
${scriptContent}
---`;
    
    if (imageDescriptionEngine) {
        initialPrompt += `\n\nInstru√ß√µes de Qualidade da Imagem: "${imageDescriptionEngine}"`;
    }
    if (imageStyleSelect === 'cinematic') {
        initialPrompt += `\n\nEstilo Visual a ser aplicado: ${CINEMATIC_STYLE_BLOCK}`;
        selectedStyleBlock = CINEMATIC_STYLE_BLOCK;
    } else if (imageStyleSelect === 'custom' && customImageStyle) {
        initialPrompt += `\n\nEstilo Visual Personalizado: ${customImageStyle}`;
        selectedStyleBlock = customImageStyle;
    }

    // --- L√ìGICA DE TENTATIVA AUTOM√ÅTICA (CAMADA 2) ---
    const MAX_RETRIES = 2; // Tentativa inicial + 1 retry
    let prompts = null;
    let lastError = null;

    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
        try {
            if (attempt > 1) {
                window.showToast(`A IA falhou. Tentando novamente... (Tentativa ${attempt})`);
            }

            const rawResult = await callGroqAPI(initialPrompt, 4000);
            const cleanedResult = cleanGeneratedText(rawResult, true);
            if (!cleanedResult) {
                throw new Error("A IA retornou uma resposta vazia ou irreconhec√≠vel.");
            }

            const parsedData = cleanedResult;

            // --- VALIDA√á√ÉO DE DADOS (CAMADA 1) ---
            if (validatePromptsArray(parsedData)) {
                prompts = parsedData; // Sucesso!
                break; // Sai do loop de tentativas
            } else if (Array.isArray(parsedData) && parsedData.length === 0) {
                prompts = []; // Resposta v√°lida (array vazio)
                break;
            } else {
                // O JSON √© sintaticamente v√°lido, mas a estrutura interna est√° errada.
                throw new Error("O formato dos dados da IA est√° incorreto (chaves faltando).");
            }
        } catch (error) {
            console.warn(`Tentativa ${attempt} de gerar prompts falhou:`, error.message);
            lastError = error;
            if (attempt < MAX_RETRIES) {
                await new Promise(res => setTimeout(res, 500)); // Pequena pausa antes de tentar de novo
            }
        }
    }

    // Ap√≥s o loop, verifica se conseguimos um resultado v√°lido.
    if (prompts === null) {
        promptContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar prompts ap√≥s ${MAX_RETRIES} tentativas. Erro final: ${lastError.message}</p>`;
        console.error("Falha final ao gerar prompts.", lastError);
        return;
    }

    // Salva e renderiza os prompts (se houver)
    allImagePrompts[sectionElementId] = prompts.map((p) => ({ ...p, styleBlock: selectedStyleBlock }));
    promptPaginationState[sectionElementId] = 0;
    
    if (prompts.length > 0) {
        promptContainer.innerHTML = `
            <div class="prompt-pagination-wrapper space-y-4">
                <div class="prompt-nav-container flex items-center justify-center gap-4"></div>
                <div class="prompt-items-container space-y-4"></div>
            </div>
        `;
        renderPaginatedPrompts(sectionElementId);
    } else {
        promptContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhum prompt de imagem foi gerado para esta se√ß√£o.</p>';
    }
    
    updateButtonStates();
};
    
        /**
         * Sugere trilhas sonoras para uma sec√ß√£o espec√≠fica do roteiro.
         * @param {string} sectionId - O ID do elemento HTML da sec√ß√£o (ex: 'introSection').
         */
        window.suggestSoundtrack = async (sectionId) => {
            const sectionElement = document.getElementById(sectionId);
            const scriptContent = sectionElement.querySelector('.generated-content-wrapper').textContent; 
            const soundtrackContainer = sectionElement.querySelector('.soundtrack-container');
            
            if (!scriptContent) {
                window.showToast("Gere o roteiro para esta sec√ß√£o primeiro.");
                return;
            }

            soundtrackContainer.innerHTML = `<div class="loading-spinner-small"></div>`; 

            const prompt = `Voc√™ √© um especialista em prompts para IAs de gera√ß√£o de m√∫sica (como Suno/Udio). Sua tarefa √© analisar o seguinte trecho de roteiro e criar 3 prompts de texto distintos e detalhados.

**REGRAS DE FORMATA√á√ÉO (N√ÉO NEGOCI√ÅVEIS):**1.  Sua resposta DEVE SER um array JSON v√°lido.2.  O array deve conter EXATAMENTE 3 strings.3.  CADA string deve ser um par√°grafo √∫nico, bem escrito e descritivo, pronto para ser colado em uma IA de m√∫sica. N√ÉO use chaves, colchetes ou qualquer outra sintaxe de objeto DENTRO da string do prompt.

**EXEMPLO DE RESPOSTA PERFEITA:**
["Generate an epic, cinematic orchestral piece in the style of Hans Zimmer... No vocals or percussion, focus on the emotional intensity of the strings and piano.","Create a contemplative, melancholic ambient track with a slow, mournful tempo... No bright or cheerful notes, focus on the darker, more introspective tones.","Craft an uplifting, inspirational electronic piece with a moderate tempo... avoid any jarring or harsh sounds, focusing on the soaring, inspirational quality of the melody."
]

Agora, use o roteiro abaixo como inspira√ß√£o para criar 3 prompts seguindo EXATAMENTE este formato.

Trecho do roteiro para analisar:
---
${scriptContent}
---`;
            
            try {
                const rawResult = await callGroqAPI(prompt, 500);
                const cleanedResult = cleanGeneratedText(rawResult, true);
                const suggestions = JSON.parse(cleanedResult);

                // Adiciona tratamento de erro para garantir que suggestions √© um array de strings
                if (!Array.isArray(suggestions) || !suggestions.every(s => typeof s === 'string')) {
                    throw new Error("A IA retornou um formato de trilha sonora inesperado. Esperava um array de strings.");
                }

                soundtrackContainer.innerHTML = ''; // Limpa o spinner
                if (suggestions && suggestions.length > 0) {
                    // Agora envolvemos a lista em um div com as classes corretas para ter um fundo e padding.
                    let suggestionsHtml = '<div class="card-background p-4 rounded-lg shadow-inner">';
                    suggestionsHtml += '<ul class="soundtrack-list">';
                    suggestions.forEach(suggestion => {
                        suggestionsHtml += `<li>${suggestion}</li>`;
                    });
                    suggestionsHtml += '</ul>';
                    suggestionsHtml += '</div>'; 

                    soundtrackContainer.innerHTML = suggestionsHtml;
                } else {
                    soundtrackContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma sugest√£o de trilha sonora foi gerada.</p>';
                }
            } catch (error) {
                soundtrackContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar sugest√µes: ${error.message}</p>`;
            }
        };

        /**
         * Copia a transcri√ß√£o para a √°rea de transfer√™ncia e
         * inicia o download de um arquivo .rtf limpo e com a codifica√ß√£o correta.
         */
        const handleCopyAndDownloadTranscript = () => {
            const transcriptText = getTranscriptOnly();

            if (!transcriptText) {
                window.showToast("Nenhum roteiro para copiar. Gere as se√ß√µes primeiro.");
                return;
            }

            copyTextToClipboard(transcriptText);
            window.showToast("Transcri√ß√£o copiada! Download do arquivo .rtf iniciado.");

            const fileName = (document.getElementById('videoTheme').value.trim().replace(/[^a-zA-Z0-9]/gi, '_').toLowerCase() || 'roteiro') + '_transcricao.rtf';
            
            // **A CORRE√á√ÉO EST√Å AQUI:**
            // 1. Escapa o texto para o formato RTF.
            // 2. Substitui as quebras de linha pelo comando de par√°grafo do RTF.
            const safeText = escapeRtf(transcriptText);
            const rtfContent = `{\\rtf1\\ansi\\deff0 {\\fonttbl{\\f0 Arial;}}\\f0\\fs24 ${safeText.replace(/\n/g, '\\par\r\n')}}`;
            
            const blob = new Blob([rtfContent], { type: 'application/rtf' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        };
    
        /**
         * Gera t√≠tulos de v√≠deo e ideias de thumbnail.
         */
        const generateTitlesAndThumbnails = async () => {
            if (!validateInputs()) return;
            showLoading(buttons.generateTitlesAndThumbnailsBtn);
            try {
                // --- IN√çCIO DA CORRE√á√ÉO NO PROMPT ---
                const { prompt, maxTokens } = constructScriptPrompt('titles_thumbnails');
                // Adicionamos uma instru√ß√£o extra para garantir a validade do JSON
                const finalPrompt = prompt + `\n\nCRITICAL RULE: Inside the 'description' strings, you MUST use single quotes ('') for any internal quotes, or properly escape double quotes (\\\"). Failure to do so will result in an invalid JSON. Example: "A text overlay that says 'Hope is Here'".`;
                
                const result = await callGroqAPI(finalPrompt, maxTokens);
                // --- FIM DA CORRE√á√ÉO NO PROMPT ---

                const cleanedResult = cleanGeneratedText(result, true);
                
                if (!cleanedResult) {
                    // Adiciona um log mais detalhado em caso de falha
                    console.error("Falha ao limpar ou validar o JSON retornado pela IA.", result);
                    throw new Error("A IA n√£o retornou um JSON v√°lido.");
                }
                
                const parsedContent = cleanedResult;
                generatedTitlesAndThumbnails = parsedContent;

                const targetContentElement = document.getElementById('titlesThumbnailsContent');
                if (targetContentElement) {
                    const titlesListHtml = parsedContent.titles.map((title, index) => `<p>${index + 1}. ${title}</p>`).join('');
                    const thumbnailsListHtml = parsedContent.thumbnails.map((thumb, index) => `
                        <div class="${index === 0 ? '' : 'thumbnail-item-separator'}"> 
                            <p class="font-semibold">"${thumb.title}"</p>
                            <p class="text-sm leading-tight">Descri√ß√£o: ${thumb.description}</p>
                        </div>
                    `).join('');

                    targetContentElement.innerHTML = `
                        <div class="space-y-4 text-sm">
                            <div>
                                <h4 class="font-bold text-base mb-2">Sugest√µes de T√≠tulos:</h4>
                                <div class="p-3 card-background rounded-md space-y-2">${titlesListHtml}</div>
                                <div class="mt-3">
                                    <button class="btn btn-secondary btn-small" onclick="window.analyzeTitles()">Analisar CTR</button>
                                    <div id="ctrAnalysisResult" class="mt-3"></div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-base mb-2">Ideias de Thumbnail:</h4>
                                <div class="p-3 card-background rounded-md space-y-3">${thumbnailsListHtml}</div>
                                <div class="mt-3">
                                    <button class="btn btn-secondary btn-small" onclick="window.analyzeThumbnails()">Analisar Thumbnails</button>
                                    <div id="thumbnailAnalysisResult" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    markButtonAsCompleted(buttons.generateTitlesAndThumbnailsBtn.id);
                }
            } catch (error) {
                window.showToast(`Falha ao gerar T√≠tulos: ${error.message}`);
                console.error("Error generating Titles/Thumbnails.", error);
            } finally {
                hideLoading(buttons.generateTitlesAndThumbnailsBtn);
                updateButtonStates();
            }
        };

        /**
         * Analisa o potencial de clique (CTR) dos t√≠tulos gerados.
         */
        window.analyzeTitles = async () => {
            if (!generatedTitlesAndThumbnails || !generatedTitlesAndThumbnails.titles || generatedTitlesAndThumbnails.titles.length === 0) {
                window.showToast("Gere os t√≠tulos primeiro!");
                return;
            }

            const resultContainer = document.getElementById('ctrAnalysisResult');
            resultContainer.innerHTML = `<div class="loading-spinner-small"></div>`;

            const titlesString = generatedTitlesAndThumbnails.titles.join('\n');
            
            const prompt = `Voc√™ √© um especialista em marketing de conte√∫do para o YouTube. Analise a seguinte lista de t√≠tulos de v√≠deo. Para cada um, forne√ßa uma "nota de CTR" de 0 a 10 (onde 10 √© um clique quase garantido) e uma sugest√£o curta e objetiva para melhor√°-lo, focando em curiosidade, urg√™ncia e benef√≠cio claro.

            Responda APENAS com um array JSON. Cada objeto no array deve ter as chaves "titulo_original", "nota_ctr" e "sugestao_melhora".

            T√≠tulos para analisar:
            ---
            ${titlesString}
            ---`;

            try {
                const rawResult = await callGroqAPI(prompt, 2000);
                const cleanedResult = cleanGeneratedText(rawResult, true);
                const analysis = cleanedResult;

                let analysisHtml = '<div class="space-y-4">';
                analysis.forEach(item => {
                    // --- IN√çCIO DA CORRE√á√ÉO NA RENDERIZA√á√ÉO ---
                    analysisHtml += `
                        <div class="p-3 card-background rounded-md shadow-sm">
                            <p class="font-semibold text-gray-800 dark:text-gray-200">${item.titulo_original}</p>
                            <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Nota de CTR:</strong> <span class="text-indigo-500 font-bold">${item.nota_ctr} / 10</span></p>
                            <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Sugest√£o:</strong> ${item.sugestao_melhora}</p>
                        </div>
                    `;


		    // --------------------------------------
                    // --- FIM DA CORRE√á√ÉO NA RENDERIZA√á√ÉO ---
		    // --------------------------------------



                });
                analysisHtml += '</div>';
                resultContainer.innerHTML = analysisHtml;

            } catch (error) {
                resultContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao analisar os t√≠tulos: ${error.message}</p>`;
            }
        };

        /**
         * Analisa o potencial de clique (CTR) das ideias de thumbnail geradas.
         */
        window.analyzeThumbnails = async () => {
            if (!generatedTitlesAndThumbnails || !generatedTitlesAndThumbnails.thumbnails || generatedTitlesAndThumbnails.thumbnails.length === 0) {
                window.showToast("Gere as ideias de thumbnail primeiro!");
                return;
            }

            const resultContainer = document.getElementById('thumbnailAnalysisResult');
            resultContainer.innerHTML = `<div class="loading-spinner-small"></div>`;

            const thumbnailsString = generatedTitlesAndThumbnails.thumbnails.map(t => `T√≠tulo: ${t.title}, Descri√ß√£o: ${t.description}`).join('\n---\n');
            
            // --- IN√çCIO DA CORRE√á√ÉO NO PROMPT ---
            const prompt = `Voc√™ √© um Diretor de Arte e especialista em YouTube. Analise a seguinte lista de ideias para thumbnails. Para cada uma, forne√ßa uma "nota de potencial visual" de 0 a 10 (onde 10 √© uma imagem irresist√≠vel) e uma sugest√£o curta para maximizar o impacto visual, focando em contraste, emo√ß√£o facial, clareza e curiosidade.

            Responda APENAS com um array JSON. Cada objeto no array deve ter as chaves "titulo", "nota_visual" e "sugestao_melhora". A chave "titulo" DEVE conter o t√≠tulo original da ideia que voc√™ analisou.

            Ideias para analisar:
            ---
            ${thumbnailsString}
            ---`;
            // --- FIM DA CORRE√á√ÉO NO PROMPT ---

            try {
                const rawResult = await callGroqAPI(prompt, 2500);
                const cleanedResult = cleanGeneratedText(rawResult, true);
                const analysis = cleanedResult;

                let analysisHtml = '<div class="space-y-4">';
                analysis.forEach(item => {
                    // --- IN√çCIO DA CORRE√á√ÉO NA RENDERIZA√á√ÉO ---
                    analysisHtml += `
                        <div class="p-3 card-background rounded-md shadow-sm">
                            <p class="font-semibold text-gray-800 dark:text-gray-200">"${item.titulo || 'Ideia Sem T√≠tulo'}"</p>
                            <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Nota de Potencial Visual:</strong> <span class="text-indigo-500 font-bold">${item.nota_visual} / 10</span></p>
                            <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Sugest√£o:</strong> ${item.sugestao_melhora}</p>
                        </div>
                    `;
                    // --- FIM DA CORRE√á√ÉO NA RENDERIZA√á√ÉO ---
                });
                analysisHtml += '</div>';
                resultContainer.innerHTML = analysisHtml;

            } catch (error) {
                resultContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao analisar as thumbnails: ${error.message}</p>`;
            }
        };
        /**
         * Gera a descri√ß√£o do v√≠deo e hashtags.
         */
        const generateVideoDescription = async () => {
            if (!validateInputs()) return;
            showLoading(buttons.generateDescriptionBtn);

            try {
                let result = await callGroqAPI(constructScriptPrompt('description').prompt, constructScriptPrompt('description').maxTokens);
                result = cleanGeneratedText(result, false);
                result = removeMetaComments(result); // <-- REINTRODUZIMOS A LIMPEZA!
                
                const targetContentElement = document.getElementById('videoDescriptionContent');
                if (targetContentElement) {
                    targetContentElement.innerHTML = `<div class="p-3 text-sm card-background rounded-md whitespace-pre-wrap">${result}</div>`;
                    markButtonAsCompleted(buttons.generateDescriptionBtn.id);
                }
            } catch (error) {
                window.showToast(`Falha ao gerar Descri√ß√£o: ${error.message}`);
                console.error("Error generating Video Description.", error);
            } finally {
                hideLoading(buttons.generateDescriptionBtn);
                updateButtonStates();
            }
        };

        /**
         * Gera o esbo√ßo estrat√©gico do roteiro, com formata√ß√£o de layout corrigida.
         */
                /**
         * Gera o esbo√ßo estrat√©gico do roteiro, com formata√ß√£o de layout corrigida.
         */
        const generateStrategicOutline = async () => {
            if (!validateInputs()) return;
            showLoading(buttons.generateOutlineBtn);
            const outlineContentDiv = elements.outlineContent;
            outlineContentDiv.innerHTML = `<div class="loading-spinner-small mx-auto"></div>`;

            try {
                const { prompt, maxTokens } = constructScriptPrompt('outline', 'Esbo√ßo Estrat√©gico');
                const rawResult = await callGroqAPI(prompt, maxTokens);
                
                // ==========================================================
                // AQUI EST√Å A CORRE√á√ÉO
                // ==========================================================
                // A fun√ß√£o cleanGeneratedText j√° retorna o objeto JavaScript corrigido.
                // N√£o precisamos mais do JSON.parse() ou do bloco try...catch complexo.
                strategicOutline = cleanGeneratedText(rawResult, true);

                // Adicionamos uma verifica√ß√£o para garantir que a IA n√£o retornou lixo.
                if (!strategicOutline || typeof strategicOutline !== 'object') {
                    console.error("A IA retornou um esbo√ßo em formato inv√°lido:", rawResult);
                    throw new Error("A IA falhou em gerar um esbo√ßo v√°lido.");
                }
                // ==========================================================
                // FIM DA CORRE√á√ÉO
                // ==========================================================

                const titleTranslations = {
                    'introduction': 'Introdu√ß√£o', 'development': 'Desenvolvimento',
                    'climax': 'Cl√≠max', 'conclusion': 'Conclus√£o', 'cta': 'CTA'
                };
                
                let outlineHtml = '<ul class="space-y-4 text-sm">';
                for (const key in strategicOutline) {
                    if (Object.hasOwnProperty.call(strategicOutline, key)) {
                        const translatedTitle = titleTranslations[key] || (key.charAt(0).toUpperCase() + key.slice(1));
                        let contentText = strategicOutline[key] || '';
                        
                        outlineHtml += `
                            <li>
                                <div>
                                    <strong class="outline-title">${translatedTitle}:</strong>
                                    <span>${contentText}</span>
                                </div>
                            </li>
                        `;
                    }
                }
                outlineHtml += '</ul>';
                outlineContentDiv.innerHTML = outlineHtml;
                markButtonAsCompleted(buttons.generateOutlineBtn.id);

            } catch (error) {
                window.showToast(`Falha ao gerar Esbo√ßo: ${error.message}`);
                console.error("Error generating Outline.", error);
                outlineContentDiv.innerHTML = `<div class="asset-card-placeholder text-red-500">Erro ao gerar o esbo√ßo. Tente novamente.</div>`;
            } finally {
                hideLoading(buttons.generateOutlineBtn);
                updateButtonStates();
            }
        };


        /**
         * Realiza o download do roteiro como PDF.
         */
        const downloadPdf = async () => {
            // 1. Criar um container tempor√°rio para a impress√£o
            let printContainer = document.createElement('div');
            printContainer.id = 'print-container';

            // 2. Coletar e formatar TODO o conte√∫do que queremos imprimir
            let htmlToPrint = `<h1 style="text-align: center; font-size: 22pt; margin-bottom: 24px;">${elements.videoTheme.value}</h1>`;

            // Adicionar o esbo√ßo estrat√©gico
            if (strategicOutline) {
                const titleTranslations = {
                    'introduction': 'Introdu√ß√£o',
                    'development': 'Desenvolvimento',
                    'climax': 'Cl√≠max',
                    'conclusion': 'Conclus√£o',
                    'cta': 'CTA'
                };
                htmlToPrint += `
                    <div class="print-section">
                        <div class="print-section-title">Esbo√ßo Estrat√©gico</div>
                        <div class="print-section-content">
                            <ul style="list-style-type: disc; padding-left: 20px;">`;
                for (const key in strategicOutline) {
                    const translatedTitle = titleTranslations[key] || (key.charAt(0).toUpperCase() + key.slice(1));
                    htmlToPrint += `<li><strong>${translatedTitle}:</strong> ${strategicOutline[key]}</li>`;
                }
                htmlToPrint += `</ul></div></div>`;
            }

            // Adicionar o roteiro principal
            document.querySelectorAll('#scriptSectionsContainer .accordion-item').forEach(item => {
                const title = item.querySelector('h3')?.textContent;
                const content = item.querySelector('.generated-content-wrapper')?.textContent;
                if (title && content) {
                    htmlToPrint += `
                        <div class="print-section">
                            <div class="print-section-title">${title}</div>
                            <div class="print-section-content"><pre>${content}</pre></div>
                        </div>`;
                }
            });
            
            // Adicionar Descri√ß√£o e Hashtags
            const videoDescriptionContent = document.getElementById('videoDescriptionContent');
            if (videoDescriptionContent && videoDescriptionContent.textContent.trim() !== 'Clique em \'Gerar\' para ver a descri√ß√£o') {
                htmlToPrint += `
                    <div class="print-section">
                        <div class="print-section-title">Descri√ß√£o & Hashtags</div>
                        <div class="print-section-content">${videoDescriptionContent.innerHTML}</div>
                    </div>`;
            }

            // Adicionar T√≠tulos e Thumbnails
            const titlesThumbnailsContent = document.getElementById('titlesThumbnailsContent');
            if (titlesThumbnailsContent && titlesThumbnailsContent.textContent.trim() !== 'Clique em \'Gerar\' para ver as sugest√µes') {
                htmlToPrint += `
                    <div class="print-section">
                        <div class="print-section-title">T√≠tulos & Thumbnails</div>
                        <div class="print-section-content">${titlesThumbnailsContent.innerHTML}</div>
                    </div>`;
            }

            // 3. Injetar o HTML no container e adicion√°-lo ao body
            printContainer.innerHTML = htmlToPrint;
            document.body.appendChild(printContainer);

            // 4. Chamar a impress√£o
            window.print();

            // 5. Remover o container tempor√°rio ap√≥s a impress√£o (com um pequeno atraso para garantir a renderiza√ß√£o)
            setTimeout(() => {
                document.body.removeChild(printContainer);
            }, 500); // 500ms de atraso
        };

        /**
         * Reseta o estado da aplica√ß√£o para um novo roteiro. (VERS√ÉO CORRIGIDA E RECONSTRUTIVA)
         */
        const resetApplicationState = () => {
            // Fun√ß√£o para resetar um elemento de forma segura
            const safeReset = (elementId, value = '') => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = value;
                }
            };

            // Reseta todos os inputs para seus valores padr√£o de forma segura
            safeReset('channelName', 'The Biblical Unveiling');
            safeReset('videoTheme');
            safeReset('videoDescription');
            safeReset('targetAudience', 'Pessoas Interessadas em Arqueologia B√≠blica e Hist√≥ria Antiga, Crist√£os e Pessoas de F√©, Entusiastas de Ci√™ncia e Ceticismo (com mente aberta), Curiosos em Geral e Amantes de Mist√©rios.');
            safeReset('languageSelect', 'en');
            safeReset('videoObjective', 'informar');
            safeReset('videoDuration', '');
            safeReset('speakingPace', 'moderate');
            
            safeReset('narrativeGoal', 'storytelling');
            updateNarrativeStructureOptions();
            
            safeReset('narrativeTheme');
            safeReset('narrativeTone', 'inspirador');
            safeReset('narrativeVoice');
            
            safeReset('centralQuestion');
            safeReset('emotionalArc');
            safeReset('shockingEndingHook');
            safeReset('imageDescriptionEngine');
            safeReset('imageStyleSelect', 'cinematic');
            safeReset('customImageStyle');
            toggleCustomImageStyleVisibility();
            
            const nicheDesc = document.getElementById('nicheDescription');
            const ideasOut = document.getElementById('ideasOutput');
            if (nicheDesc) nicheDesc.value = '';
            if (ideasOut) ideasOut.innerHTML = '';

            strategicOutline = null;
            allImagePrompts = {};
            generatedTitlesAndThumbnails = null;
            totalScriptSeconds = 0;
            promptPaginationState = {}; // Reset pagination state

            // ==========================================================
            // A CORRE√á√ÉO CR√çTICA EST√Å AQUI
            // ==========================================================
            const contentContainers = [
                'scriptSectionsContainer', 'outlineContent', 
                'titlesThumbnailsContent', 'videoDescriptionContent'
            ];
            contentContainers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    if (id === 'scriptSectionsContainer') {
                        // RECONSTR√ìI os placeholders em vez de apenas limpar
                        container.innerHTML = `
                            <div id="introSection" class="script-section"></div>
                            <div id="developmentSection" class="script-section"></div>
                            <div id="climaxSection" class="script-section"></div>
                            <div id="conclusionSection" class="script-section"></div>
                            <div id="ctaSection" class="script-section hidden"></div> 
                        `;
                    } else if (id === 'outlineContent') {
                        container.innerHTML = `<div class="asset-card-placeholder">Clique em 'Criar Esbo√ßo' para a IA planejar a estrutura do roteiro.</div>`;
                    } else if (id === 'titlesThumbnailsContent') {
                        container.innerHTML = `<div class="asset-card-placeholder">Clique em 'Gerar' para ver as sugest√µes</div>`;
                    } else if (id === 'videoDescriptionContent') {
                        container.innerHTML = `<div class="asset-card-placeholder">Clique em 'Gerar' para ver a descri√ß√£o</div>`;
                    } else {
                        container.innerHTML = '';
                    }
                }
            });
            // ==========================================================
            // FIM DA CORRE√á√ÉO
            // ==========================================================

            document.querySelectorAll('.section-analysis-output, .section-performance-output').forEach(output => {
                output.innerHTML = '';
            });

            resetCompletionIcons();
            updateProgressBar();
            
            if (elements.projectDashboard) {
                 elements.projectDashboard.classList.add('hidden');
            }

            window.showToast("Pronto para um novo roteiro!");
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        /**
         * Exporta o estado atual do projeto para um ficheiro JSON.
         */
        const exportProject = () => {
            const projectData = {
                inputs: {},
                outputs: {},
                memory: {
                    allImagePrompts: allImagePrompts,
                    generatedTitlesAndThumbnails: generatedTitlesAndThumbnails,
                    strategicOutline: strategicOutline, // Exporta o esbo√ßo
                    promptPaginationState: promptPaginationState // Export pagination state
                }
            };

            // Salva o estado dos inputs
            for (const key in elements) {
                if (elements[key] && typeof elements[key].value !== 'undefined') {
                    projectData.inputs[key] = elements[key].value;
                }
            }
            // Salva o conte√∫do gerado (HTML interno das sec√ß√µes)
            const scriptSectionIds = ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection']; // CTA is now part of conclusionSection
            scriptSectionIds.forEach(id => {
                const sectionElement = document.getElementById(id);
                if (sectionElement) {
                    projectData.outputs[id] = sectionElement.innerHTML;
                }
            });

            // Salva o conte√∫do do esbo√ßo
            projectData.outputs.strategicOutlineContent = elements.outlineContent.innerHTML;

            // Salva o conte√∫do dos cart√µes de recursos
            projectData.outputs.titlesThumbnailsContent = document.getElementById('titlesThumbnailsContent').innerHTML;
            projectData.outputs.videoDescriptionContent = document.getElementById('videoDescriptionContent').innerHTML;
            // Removed storyboardContent export
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const fileName = elements.videoTheme.value.trim().replace(/[^a-zA-Z0-9]/gi, '_').toLowerCase() || 'roteiro_viral';
            downloadAnchorNode.setAttribute("download", `${fileName}_projeto.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            document.body.removeChild(downloadAnchorNode);
            downloadAnchorNode.remove();
            window.showToast("Projeto exportado com sucesso!");
        };

        /**
         * Renderiza os prompts de imagem para uma sec√ß√£o espec√≠fica na UI.
         * Usado ap√≥s carregar um projeto.
         * @param {string} sectionElementId - O ID do elemento HTML da sec√ß√£o.
         */
        const renderImagePromptsForSection = (sectionElementId) => {
            const sectionElement = document.getElementById(sectionElementId);
            if (!sectionElement) return;

            const promptContainer = sectionElement.querySelector('.prompt-container');
            if (!promptContainer) return;

            // Re-cria a estrutura de pagina√ß√£o se ela n√£o existir
            if (!promptContainer.querySelector('.prompt-pagination-wrapper')) {
                promptContainer.innerHTML = `
                    <div class="prompt-pagination-wrapper space-y-4">
                        <div class="prompt-nav-container flex items-center justify-center gap-4">
                            <!-- Controles de navega√ß√£o ser√£o inseridos aqui -->
                        </div>
                        <div class="prompt-items-container space-y-4">
                            <!-- Os 4 prompts da p√°gina atual ser√£o inseridos aqui -->
                        </div>
                    </div>
                `;
            }

            // Renderiza a p√°gina atual de prompts
            renderPaginatedPrompts(sectionElementId);
        };

        /**
         * Importa um projeto de um ficheiro JSON.
         * @param {Event} event - O evento de mudan√ßa do input de ficheiro.
         */
        const importProject = (event) => {
            const file = event.target.files[0];
            if (!file) { return; }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const projectData = JSON.parse(e.target.result);
                    
                    resetApplicationState();

                    // Restaura os inputs
                    const inputIds = [
                        'channelName', 'videoTheme', 'videoDescription', 'targetAudience', 
                        'languageSelect', 'videoObjective', 'videoDuration', 'speakingPace', 
                        'narrativeGoal', 'narrativeStructure', 'narrativeTheme', 'narrativeTone', 
                        'narrativeVoice', 'centralQuestion', 'emotionalArc', 'shockingEndingHook', 'imageDescriptionEngine', 
                        'imageStyleSelect', 'customImageStyle'
                    ];
                    inputIds.forEach(id => {
                        const element = document.getElementById(id);
                        if (element && projectData.inputs[id] !== undefined) {
                            element.value = projectData.inputs[id];
                        }
                    });
                    
                    // Atualiza os dropdowns da narrativa
                    updateNarrativeStructureOptions();
                    const structureSelect = document.getElementById('narrativeStructure');
                    if (structureSelect && projectData.inputs['narrativeStructure']) {
                        structureSelect.value = projectData.inputs['narrativeStructure'];
                        // Ensure the tooltip is updated after setting the structure value
                        updateMainTooltip();
                    }

                    // Restaura o conte√∫do gerado
                    const outputIds = [
                        'introSection', 'developmentSection', 'climaxSection', 'conclusionSection', // CTA is now part of conclusionSection
                        'outlineContent', 'titlesThumbnailsContent', 'videoDescriptionContent'
                    ];
                    outputIds.forEach(id => {
                        const element = document.getElementById(id);
                        if (element && projectData.outputs[id]) {
                            element.innerHTML = projectData.outputs[id]; 
                        }
                    });
                    
                    strategicOutline = projectData.memory.strategicOutline || null;
                    allImagePrompts = projectData.memory.allImagePrompts || {};
                    generatedTitlesAndThumbnails = projectData.memory.generatedTitlesAndThumbnails || null;
                    promptPaginationState = projectData.memory.promptPaginationState || {}; // Load pagination state

                    // Renderiza os prompts de imagem paginados ap√≥s carregar
                    const scriptSectionIds = ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection'];
                    scriptSectionIds.forEach(id => {
                        if (allImagePrompts[id] && allImagePrompts[id].length > 0) {
                            renderImagePromptsForSection(id);
                        }
                    });

                    updateButtonStates();
                    
                    if (elements.outlineContent.textContent.trim().length > 100) markButtonAsCompleted('generateOutlineBtn');
                    if (document.getElementById('introSection').innerHTML.trim()) markButtonAsCompleted('generateIntroBtn');
                    if (document.getElementById('developmentSection').innerHTML.trim()) markButtonAsCompleted('generateDevelopmentBtn');
                    if (document.getElementById('climaxSection').innerHTML.trim()) markButtonAsCompleted('climaxBtn');
                    if (document.getElementById('conclusionSection').innerHTML.trim()) markButtonAsCompleted('conclusionBtn');
                    if (document.getElementById('videoDescriptionContent').innerHTML.includes('Hashtags')) markButtonAsCompleted('generateDescriptionBtn');
                    if (document.getElementById('titlesThumbnailsContent').innerHTML.includes('Analisar CTR')) markButtonAsCompleted('generateTitlesAndThumbnailsBtn');

                    reNumberAllScenes();
                    updateProgressBar(); 
                    
                    elements.projectDashboard.classList.remove('hidden');
                    window.showToast("Projeto importado com sucesso!");

                } catch (err) {
                    window.showToast("Erro: Ficheiro de projeto inv√°lido ou corrompido.");
                    console.error("Erro ao importar projeto:", err);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        };

        /**
	     * Analisa o tema e a descri√ß√£o do v√≠deo para definir a estrat√©gia de conte√∫do. (VERS√ÉO CORRIGIDA PARA ABAS)
         */
                const analyzeAndSetStrategy = async () => {
            const theme = elements.videoTheme.value.trim();
            const description = elements.videoDescription.value.trim();
            if (!theme || !description) {
                window.showToast("Por favor, preencha o Tema e a Descri√ß√£o do V√≠deo.");
                return;
            }
            
            strategicOutline = null;
            allImagePrompts = {};
            generatedTitlesAndThumbnails = null;
            totalScriptSeconds = 0;
            promptPaginationState = {};
            
            const button = document.getElementById('analyzeStrategyBtn');
            showLoading(button);

            const videoObjectiveOptions = Array.from(elements.videoObjective.options).map(o => `'${o.value}'`);
            const narrativeToneOptions = Array.from(document.getElementById('narrativeTone').options).map(o => `'${o.value}'`);
            const allStructures = {...narrativeStructures.storytelling, ...narrativeStructures.storyselling};
            const narrativeStructureOptions = Object.keys(allStructures).map(s => `'${s}'`);

            const prompt = `Voc√™ √© um Estrategista de Conte√∫do de IA para o YouTube, um especialista em engenharia de narrativas virais. Sua tarefa √© analisar o tema e a descri√ß√£o de um v√≠deo e definir a melhor e mais coesa estrat√©gia de conte√∫do.

            **Tema do V√≠deo:** "${theme}"
            **Descri√ß√£o:** "${description}"

            Responda APENAS com um objeto JSON v√°lido. Siga estritamente as regras para cada uma das seguintes 11 chaves:

            1.  **"target_audience"**: (string) Descreva em uma frase o p√∫blico-alvo principal mais propenso a se engajar com este conte√∫do.
            2.  **"video_objective"**: (string) Escolha o objetivo principal mais adequado. Sua resposta DEVE ser um dos seguintes valores EXATOS: [${videoObjectiveOptions.join(', ')}].
            3.  **"narrative_goal"**: (string) Determine se a abordagem mais forte √© 'storytelling' (para conectar e entreter) ou 'storyselling' (para persuadir). Sua resposta DEVE ser 'storytelling' ou 'storyselling'.
            4.  **"narrative_structure"**: (string) Escolha a estrutura narrativa mais poderosa da lista fornecida. **GUIA DE MAPEAMENTO OBRIGAT√ìRIO:** Se o 'narrative_goal' for 'storytelling', escolha entre ['documentary', 'heros_journey', 'pixar_spine', 'mystery_loop', 'twist']. Se for 'storyselling', escolha entre ['underdog_victory', 'discovery_mentor', 'if_not_found_create', 'pas', 'bab']. Sua resposta DEVE ser um valor EXATO deste guia.
            5.  **"narrative_theme"**: (string) Defina a "grande ideia" ou o tema universal por tr√°s da hist√≥ria em poucas palavras (Ex: A jornada contra a adversidade, A busca pela verdade oculta).
            6.  **"narrative_tone"**: (string) Escolha o tom emocional que a narra√ß√£o deve evocar. Sua resposta DEVE ser um dos seguintes valores EXATOS: [${narrativeToneOptions.join(', ')}].
            7.  **"narrative_voice"**: (string) Defina a "persona" do narrador em poucas palavras (Ex: Um historiador c√©tico, Uma testemunha emocionada, Um guia experiente).
            8.  **"central_question"**: (string) Formule a pergunta central mais intrigante que o roteiro inteiro dever√° se esfor√ßar para responder.
            9.  **"emotional_arc"**: (string) Descreva o arco emocional que o espectador deve sentir, usando setas (Ex: Indigna√ß√£o -> Empatia -> Esperan√ßa).
            10. **"image_description_engine"**: (string) Sugira 3 a 5 palavras-chave que guiar√£o o estilo visual do v√≠deo (Ex: fotorrealista, sombrio, cinematogr√°fico, close-up emocional).
            11. **"viral_elements"**: (string) Liste 2 ou 3 elementos virais que podem ser incorporados na narrativa (Ex: "Fato chocante nos primeiros 10s", "Plot twist inesperado", "Loop aberto para o final").
            
            Seja coeso e eficaz.`;

            try {
                isSettingStrategy = true; 

                const rawResult = await callGroqAPI(prompt, 2000);
                
                // ==========================================================
                // AQUI EST√Å A CORRE√á√ÉO
                // ==========================================================
                // A fun√ß√£o cleanGeneratedText agora retorna um objeto, n√£o uma string.
                // Portanto, n√£o precisamos mais do JSON.parse().
                const strategy = cleanGeneratedText(rawResult, true);

                // Adicionamos uma verifica√ß√£o para garantir que a IA n√£o retornou lixo.
                if (!strategy || typeof strategy !== 'object') {
                    throw new Error("A IA n√£o retornou uma resposta em formato JSON v√°lido.");
                }
                // ==========================================================
                // FIM DA CORRE√á√ÉO
                // ==========================================================
                
                // Preenchimento dos campos em todas as abas
                if(strategy.target_audience) elements.targetAudience.value = strategy.target_audience;
                if(strategy.video_objective) elements.videoObjective.value = strategy.video_objective;
                if(strategy.narrative_goal) document.getElementById('narrativeGoal').value = strategy.narrative_goal;
                
                updateNarrativeStructureOptions(); 
                
                if(strategy.narrative_structure) document.getElementById('narrativeStructure').value = strategy.narrative_structure;
                if(strategy.narrative_theme) document.getElementById('narrativeTheme').value = strategy.narrative_theme;
                if (strategy.narrative_tone) {
                    const toneSelect = document.getElementById('narrativeTone');
                    const normalizedReturnedTone = strategy.narrative_tone.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    toneSelect.value = normalizedReturnedTone;
                }
                if(strategy.narrative_voice) document.getElementById('narrativeVoice').value = strategy.narrative_voice;
                if(strategy.central_question) elements.centralQuestion.value = strategy.central_question;
                if(strategy.emotional_arc) elements.emotionalArc.value = strategy.emotional_arc;
                if(strategy.image_description_engine) elements.imageDescriptionEngine.value = strategy.image_description_engine;
                if(strategy.languageSelect) elements.languageSelect.value = strategy.languageSelect;
                if(strategy.languageStyle) elements.languageStyle.value = strategy.languageStyle;
                if(strategy.videoDuration) elements.videoDuration.value = strategy.videoDuration;
                if(strategy.speakingPace) elements.speakingPace.value = strategy.speakingPace;
                if(strategy.imageStyleSelect) elements.imageStyleSelect.value = strategy.imageStyleSelect;

                window.showToast("Estrat√©gia definida com sucesso!");
                elements.projectDashboard.classList.remove('hidden');
                
                document.querySelector('[data-tab="input-tab-estrategia"]').click();

            } catch (error) {
                window.showToast(`Falha ao definir estrat√©gia: ${error.message}`);
                console.error("Erro na an√°lise estrat√©gica:", error);
            } finally {
                isSettingStrategy = false;
                hideLoading(button);
                updateButtonStates();
            }
        };

// ==========================================================
// EVENT LISTENER √öNICO E CORRETO
// ==========================================================
document.addEventListener('DOMContentLoaded', () => {
    // ---- 1. INICIALIZA√á√ÉO GERAL ----
    setupInputTabs();
    setupTabs();
    updateProgressBar();
    updateButtonStates();
    handleConclusionStrategyChange();
    updateNarrativeStructureOptions();

    // ---- 2. EVENTOS DIRETOS EM ELEMENTOS ESPEC√çFICOS ----
    document.getElementById('importFileInput')?.addEventListener('change', importProject);
    
    document.getElementById('darkModeToggle')?.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        const isDarkMode = document.body.classList.contains('dark');
        document.getElementById('moonIcon').classList.toggle('hidden', isDarkMode);
        document.getElementById('sunIcon').classList.toggle('hidden', !isDarkMode);
        localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
    });

    if (localStorage.getItem('darkMode') === 'enabled') {
        document.body.classList.add('dark');
        document.getElementById('moonIcon')?.classList.add('hidden');
        document.getElementById('sunIcon')?.classList.remove('hidden');
    }

    document.getElementById('toggleZenModeBtn')?.addEventListener('click', () => document.body.classList.toggle('zen-mode'));
    document.getElementById('exitZenModeBtn')?.addEventListener('click', () => document.body.classList.remove('zen-mode'));
    document.getElementById('imageStyleSelect')?.addEventListener('change', toggleCustomImageStyleVisibility);
    
    document.querySelectorAll('input[name="conclusionType"]').forEach(radio => {
        radio.addEventListener('change', handleConclusionStrategyChange);
    });

// ==========================================================
        // CIRURGIA: INVALIDA√á√ÉO DE PROMPTS AO DIGITAR MANUALMENTE
        // ==========================================================
        document.addEventListener('input', (event) => {
            // Usamos "event delegation" para observar eventos de input no documento inteiro.
            
            // Verificamos se o evento aconteceu em um de nossos campos de roteiro edit√°veis.
            if (event.target.matches('.generated-content-wrapper[contenteditable="true"]')) {
                
                console.log("Modifica√ß√£o manual detectada no roteiro."); // Log para depura√ß√£o

                // Encontra a se√ß√£o-pai (ex: #introSection) do texto que foi modificado.
                const sectionElement = event.target.closest('.script-section');
                
                if (sectionElement) {
                    // Chama a nossa fun√ß√£o j√° existente para invalidar os prompts daquela se√ß√£o.
                    invalidateAndClearPrompts(sectionElement);
                }
            }
        });

	// ==========================================================
    // L√ìGICA PARA DESTAQUE E DETALHE FIXO (VERS√ÉO CORRETA E FINAL)
    // ==========================================================
    let hideDetailsTimeout; // Timer para esconder o card

    // Listener para MOSTRAR os detalhes ao passar o mouse
    document.getElementById('scriptSectionsContainer').addEventListener('mouseover', (event) => {
        const paragraph = event.target.closest('.retention-paragraph-live');
        if (!paragraph || !paragraph.dataset.suggestion) return;

        clearTimeout(hideDetailsTimeout);

        const sectionId = paragraph.closest('.script-section').id;
        const detailsArea = document.getElementById(`analysis-output-${sectionId.replace('Section', '')}`);
        if (!detailsArea) return;

        // ==========================================================
        // AQUI EST√Å A L√ìGICA CORRIGIDA
        // ==========================================================
        const score = paragraph.dataset.score;
        const suggestion = paragraph.dataset.suggestion;
        const scoreLabels = { green: "Ponto Forte", yellow: "Ponto de Aten√ß√£o", red: "Ponto de Risco" };
        const scoreColors = { green: "green-500", yellow: "yellow-400", red: "red-500" };
        
        let buttonHtml = '';
        // S√≥ mostra o bot√£o de otimizar se o score for amarelo ou vermelho
        if (score === 'yellow' || score === 'red') {
            buttonHtml = `<button class="btn btn-secondary btn-small" data-action="optimize-paragraph" data-paragraph-id="${paragraph.id}">Otimizar com IA</button>`;
        }

        // Esta √© a linha que cria o card NOVO e CORRETO
        detailsArea.innerHTML = `
            <div class="retention-details-card border-l-${scoreColors[score]}">
                <strong class="text-${scoreColors[score]}">${scoreLabels[score]}</strong>
                <p>${suggestion}</p>
                ${buttonHtml}
            </div>
        `;
        detailsArea.classList.remove('hidden');
    });

    // Listener para ESCONDER os detalhes quando o mouse sai
    document.getElementById('scriptSectionsContainer').addEventListener('mouseout', (event) => {
        const paragraph = event.target.closest('.retention-paragraph-live');
        if (paragraph) {
            const sectionId = paragraph.closest('.script-section').id;
            const detailsArea = document.getElementById(`analysis-output-${sectionId.replace('Section', '')}`);
            
            if (detailsArea && !detailsArea.classList.contains('hidden')) {
                hideDetailsTimeout = setTimeout(() => {
                    detailsArea.classList.add('hidden');
                    detailsArea.innerHTML = '';
                }, 300); 
            }
        }
    });

    // Listener para MANTER os detalhes vis√≠veis se o mouse entrar no card
    document.addEventListener('mouseover', (event) => {
        if (event.target.closest('.section-analysis-output')) {
            clearTimeout(hideDetailsTimeout);
        }
    });

    // Listener para MANTER os detalhes vis√≠veis se o mouse entrar no card
    document.addEventListener('mouseover', (event) => {
        if (event.target.closest('.section-analysis-output')) {
            clearTimeout(hideDetailsTimeout); // Cancela o timer de esconder
        }
    });
	// ==========================================================
	// FIM DA L√ìGICA PARA DESTAQUE E DETALHE FIXO (VERS√ÉO FINAL)
	// ==========================================================




    // Listener para ESCONDER os detalhes
    document.getElementById('scriptSectionsContainer').addEventListener('mouseout', (event) => {
        const paragraph = event.target.closest('.retention-paragraph-live');
        if (paragraph) {
            // Se o mouse saiu de um par√°grafo, programa para esconder a √°rea de detalhes
            const sectionId = paragraph.closest('.script-section').id;
            const detailsArea = document.getElementById(`analysis-output-${sectionId.replace('Section', '')}`);
            if (detailsArea && !detailsArea.classList.contains('hidden')) {
                hideDetailsTimeout = setTimeout(() => {
                    detailsArea.classList.add('hidden');
                    detailsArea.innerHTML = '';
                }, 300); // 300ms de atraso
            }
        }
    });

    // Listener para MANTER os detalhes vis√≠veis se o mouse entrar na √°rea
    document.addEventListener('mouseover', (event) => {
        if (event.target.closest('.section-analysis-output')) {
            clearTimeout(hideDetailsTimeout);
        }
    });

    // ---- 4. O "GERENTE DE CLIQUES" - VERS√ÉO FINAL E CORRIGIDA ----
    document.addEventListener('click', function(event) {
        const target = event.target;
        const button = target.closest('button');

        // PARTE 1: A√á√ïES ESPEC√çFICAS (J√Å EST√Å FUNCIONANDO BEM)
        // Se o clique foi em um bot√£o com uma a√ß√£o espec√≠fica (copiar, re-gerar, etc.),
        // a a√ß√£o √© executada e a fun√ß√£o para imediatamente com 'return'.
        if (button && button.dataset.action) {
            event.preventDefault();
            const action = button.dataset.action;

            if (action === 'regenerate') {
                const sectionId = button.dataset.sectionId;
                if (sectionId) window.regenerateSection(sectionId);
                return;
            }
            if (action === 'copy') {
                const accordionItem = button.closest('.accordion-item');
                if (accordionItem) {
                    const contentWrapper = accordionItem.querySelector('.generated-content-wrapper');
                    if (contentWrapper) {
                        const textToCopy = contentWrapper.textContent;
                        window.copyTextToClipboard(textToCopy);
                        window.showCopyFeedback(button);
                    }
                }
                return;
            }
            if (action === 'generate-prompts') {
                const sectionId = button.dataset.sectionId;
                if (sectionId) window.generatePromptsForSection(sectionId);
                return;
            }
            if (action === 'optimize-paragraph') {
                const paragraphId = button.dataset.paragraphId;
                const detailsCard = button.closest('.retention-details-card');
                if (detailsCard) {
                    const suggestion = detailsCard.querySelector('p').textContent;
                    window.optimizeParagraph(paragraphId, suggestion);
                }
                return;
            }
        }

        // PARTE 2: L√ìGICA DO ACORDE√ÉO (AGORA SIMPLIFICADA E CORRETA)
        // Esta parte s√≥ √© executada se um bot√£o de a√ß√£o espec√≠fico N√ÉO foi clicado.
        const header = target.closest('.accordion-header, .nested-accordion-header');
        if (header) {
            // A CONDI√á√ÉO DE OURO:
            // S√ì ABRE O ACORDE√ÉO SE O CLIQUE N√ÉO FOI NA √ÅREA DOS BOT√ïES DE A√á√ÉO.
            if (!target.closest('.header-buttons')) {
                const body = header.nextElementSibling;
                const arrow = header.querySelector('.accordion-arrow');
                if (body && arrow) {
                    const isOpen = body.classList.toggle('open');
                    arrow.classList.toggle('open', isOpen);
                    header.classList.toggle('active', isOpen);
                }
            }
            // N√£o usamos 'return' aqui, para que o c√≥digo continue e verifique os bot√µes por ID.
        }

        // PARTE 3: L√ìGICA DOS BOT√ïES GERAIS POR ID (J√Å ESTAVA FUNCIONANDO)
        if (button) {
            const clickActions = {
                'analyzeStrategyBtn': analyzeAndSetStrategy,
                'generateOutlineBtn': generateStrategicOutline,


	// ==========================================================

	'generateConclusionAndCtaBtn': generateConclusionAndCta,
        	'conclusionBtn': () => {
           	 const conclusionModule = document.getElementById('conclusionStrategyModule');
           	 // Verifica se o m√≥dulo de estrat√©gia da conclus√£o j√° est√° vis√≠vel na tela
          	  if (conclusionModule && !conclusionModule.classList.contains('hidden')) {
              	  // Se estiver vis√≠vel, guia o usu√°rio at√© ele
              	  conclusionModule.scrollIntoView({ behavior: 'smooth', block: 'center' });
                	window.showToast("A√ß√£o necess√°ria: Clique em 'Gerar Conclus√£o + CTA'");
                	// Adiciona um "flash" visual para chamar a aten√ß√£o
                	conclusionModule.style.transition = 'all 0.2s';
                	conclusionModule.style.boxShadow = '0 0 0 3px var(--primary-color)';
                	setTimeout(() => { conclusionModule.style.boxShadow = ''; }, 1500);
            	} else {
                	// Se n√£o estiver vis√≠vel, significa que as se√ß√µes anteriores n√£o foram geradas
                	window.showToast("Por favor, gere a Introdu√ß√£o, Desenvolvimento e Cl√≠max primeiro.");
            	}
        	},
        	'generateCTABtn': () => {
            	// O bot√£o CTA agora faz exatamente a mesma coisa que o bot√£o Conclus√£o
            	// Encontra o bot√£o de conclus√£o e simula um clique nele.
            	document.getElementById('conclusionBtn')?.click();
       	 },
	// ==========================================================


                'generateIntroBtn': () => handleGenerateSection(button, 'intro', 'Introdu√ß√£o', 'intro'),
                'generateDevelopmentBtn': () => handleGenerateSection(button, 'development', 'Desenvolvimento', 'development'),
                'climaxBtn': () => handleGenerateSection(button, 'climax', 'Cl√≠max', 'climax'),
                'generateDescriptionBtn': generateVideoDescription,
                'generateTitlesAndThumbnailsBtn': generateTitlesAndThumbnails,
                'downloadPdfBtn': downloadPdf,
                'exportProjectBtn': exportProject,
                'importProjectBtn': () => document.getElementById('importFileInput').click(),
                'resetScriptBtn': resetApplicationState,
                'generateIdeasBtn': generateVideoIdeas,
                'copyTranscriptBtn': handleCopyAndDownloadTranscript,
                'generateSoundtrackBtn': generateSoundtrack
            };

            if (clickActions[button.id]) {
                event.preventDefault();
                clickActions[button.id]();
                return;
            }

            if (button.id.startsWith('float_')) {
                event.preventDefault();
                const originalId = button.id.replace('float_', '');
                document.getElementById(originalId)?.click();
            }
        }
    });


    // ---- 5. L√ìGICA PARA RESETAR ROTEIRO ----
    const strategicInputIds = [
        'videoTheme', 'videoDescription', 'videoDuration', 'speakingPace', 'narrativeGoal',
        'narrativeStructure', 'narrativeTheme', 'narrativeTone', 'narrativeVoice',
        'centralQuestion', 'emotionalArc', 'shockingEndingHook', 'imageDescriptionEngine', 'imageStyleSelect'
    ];

    strategicInputIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            const eventType = (element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') ? 'change' : 'input';
            element.addEventListener(eventType, (e) => {
                if (!isSettingStrategy) {
                    resetGeneratedScriptContent(e.target.id);
                }
            });
        }
    });

    // ---- 6. EVENTO DE SCROLL PARA BARRA FLUTUANTE ----
    window.addEventListener('scroll', window.handleFloatingActionBar);
});

</script>
</body>
</html>